<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - test/translator.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>test/translator.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">81.87</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">407</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">28.25</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.56</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

// For tests relating to Transifex configuration, check i18n.js

const assert = require(&#039;assert&#039;);
const shim = require(&#039;../src/translator&#039;);

const { Translator } = shim;
const db = require(&#039;./mocks/databasemock&#039;);

describe(&#039;Translator shim&#039;, () =&gt; {
	describe(&#039;.translate()&#039;, () =&gt; {
		it(&#039;should translate correctly&#039;, (done) =&gt; {
			shim.translate(&#039;[[global:pagination.out-of, (foobar), [[global:home]]]]&#039;, (translated) =&gt; {
				assert.strictEqual(translated, &#039;(foobar) out of Home&#039;);
				done();
			});
		});

		it(&#039;should accept a language parameter and adjust accordingly&#039;, (done) =&gt; {
			shim.translate(&#039;[[global:home]]&#039;, &#039;de&#039;, (translated) =&gt; {
				assert.strictEqual(translated, &#039;Übersicht&#039;);
				done();
			});
		});

		it(&#039;should translate empty string properly&#039;, (done) =&gt; {
			shim.translate(&#039;&#039;, &#039;en-GB&#039;, (translated) =&gt; {
				assert.strictEqual(translated, &#039;&#039;);
				done();
			});
		});

		it(&#039;should translate empty string properly&#039;, async () =&gt; {
			const translated = await shim.translate(&#039;&#039;, &#039;en-GB&#039;);
			assert.strictEqual(translated, &#039;&#039;);
		});

		it(&#039;should not allow path traversal&#039;, async () =&gt; {
			const t = await shim.translate(&#039;[[../../../../config:secret]]&#039;);
			assert.strictEqual(t, &#039;secret&#039;);
		});
	});

	describe(&#039;translateKeys&#039;, () =&gt; {
		it(&#039;should translate each key in array&#039;, async () =&gt; {
			const translated = await shim.translateKeys([&#039;[[global:home]]&#039;, &#039;[[global:search]]&#039;], &#039;en-GB&#039;);
			assert.deepStrictEqual(translated, [&#039;Home&#039;, &#039;Search&#039;]);
		});

		it(&#039;should translate each key in array using a callback&#039;, (done) =&gt; {
			shim.translateKeys([&#039;[[global:save]]&#039;, &#039;[[global:close]]&#039;], &#039;en-GB&#039;, (translated) =&gt; {
				assert.deepStrictEqual(translated, [&#039;Save&#039;, &#039;Close&#039;]);
				done();
			});
		});
	});

	it(&#039;should load translations for language&#039;, (done) =&gt; {
		shim.load(&#039;en-GB&#039;, &#039;global&#039;, (translations) =&gt; {
			assert(translations);
			assert(translations[&#039;header.profile&#039;]);
			done();
		});
	});

	it(&#039;should get translations for language&#039;, (done) =&gt; {
		shim.getTranslations(&#039;en-GB&#039;, &#039;global&#039;, (translations) =&gt; {
			assert(translations);
			assert(translations[&#039;header.profile&#039;]);
			done();
		});
	});
});

describe(&#039;new Translator(language)&#039;, () =&gt; {
	it(&#039;should throw if not passed a language&#039;, (done) =&gt; {
		assert.throws(() =&gt; {
			new Translator();
		}, /language string/);
		done();
	});

	describe(&#039;.translate()&#039;, () =&gt; {
		it(&#039;should handle basic translations&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[global:home]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Home&#039;);
			});
		});

		it(&#039;should handle language keys in regular text&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;Let\&#039;s go [[global:home]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Let\&#039;s go Home&#039;);
			});
		});

		it(&#039;should handle language keys in regular text with another language specified&#039;, () =&gt; {
			const translator = Translator.create(&#039;de&#039;);

			return translator.translate(&#039;[[global:home]] test&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Übersicht test&#039;);
			});
		});

		it(&#039;should handle language keys with parameters&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[global:pagination.out-of, 1, 5]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;1 out of 5&#039;);
			});
		});

		it(&#039;should handle language keys inside language keys&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[notifications:outgoing-link-message, [[global:guest]]]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;You are now leaving Guest&#039;);
			});
		});

		it(&#039;should handle language keys inside language keys with multiple parameters&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[notifications:user-posted-to, [[global:guest]], My Topic]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;&lt;strong&gt;Guest&lt;/strong&gt; has posted a reply to: &lt;strong&gt;My Topic&lt;/strong&gt;&#039;);
			});
		});

		it(&#039;should handle language keys inside language keys with all parameters as language keys&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[notifications:user-posted-to, [[global:guest]], [[global:guest]]]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;&lt;strong&gt;Guest&lt;/strong&gt; has posted a reply to: &lt;strong&gt;Guest&lt;/strong&gt;&#039;);
			});
		});

		it(&#039;should properly handle parameters that contain square brackets&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[global:pagination.out-of, [guest], [[global:home]]]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;[guest] out of Home&#039;);
			});
		});

		it(&#039;should properly handle parameters that contain parentheses&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			return translator.translate(&#039;[[global:pagination.out-of, (foobar), [[global:home]]]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;(foobar) out of Home&#039;);
			});
		});

		it(&#039;should escape language key parameters with HTML in them&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			const key = &#039;[[global:403.login, &lt;strong&gt;test&lt;/strong&gt;]]&#039;;
			return translator.translate(key).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Perhaps you should &lt;a class=&quot;alert-link&quot; href=\&#039;&amp;lt;strong&amp;gt;test&amp;lt;/strong&amp;gt;/login\&#039;&gt;try logging in&lt;/a&gt;?&#039;);
			});
		});

		it(&#039;should not unescape html in parameters&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			const key = &#039;[[pages:tag, some&amp;amp;tag]]&#039;;
			return translator.translate(key).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Topics tagged under &amp;quot;some&amp;amp;tag&amp;quot;&#039;);
			});
		});

		it(&#039;should translate escaped translation arguments properly&#039;, () =&gt; {
			// https://github.com/NodeBB/NodeBB/issues/9206
			const translator = Translator.create(&#039;en-GB&#039;);

			const key = &#039;[[notifications:upvoted-your-post-in, test1, error: Error: &amp;lsqb;&amp;lsqb;error:group-name-too-long&amp;rsqb;&amp;rsqb; on NodeBB Upgrade]]&#039;;
			return translator.translate(key).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;&lt;strong&gt;test1&lt;/strong&gt; has upvoted your post in &lt;strong&gt;error: Error: &amp;lsqb;&amp;lsqb;error:group-name-too-long&amp;rsqb;&amp;rsqb; on NodeBB Upgrade&lt;/strong&gt;.&#039;);
			});
		});

		it(&#039;should properly escape and ignore % and \\, in arguments&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			const title = &#039;Test 1\\, 2\\, 3 %2 salmon&#039;;
			const key = `[[topic:composer.replying-to, ${title}]]`;
			return translator.translate(key).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Replying to Test 1&amp;#44; 2&amp;#44; 3 &amp;#37;2 salmon&#039;);
			});
		});

		it(&#039;should not escape regular %&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);

			const title = &#039;3 % salmon&#039;;
			const key = `[[topic:composer.replying-to, ${title}]]`;
			return translator.translate(key).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Replying to 3 % salmon&#039;);
			});
		});

		it(&#039;should not translate [[derp] some text&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[derp] some text&#039;).then((translated) =&gt; {
				assert.strictEqual(&#039;[[derp] some text&#039;, translated);
			});
		});

		it(&#039;should not translate [[derp]] some text&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[derp]] some text&#039;).then((translated) =&gt; {
				assert.strictEqual(&#039;[[derp]] some text&#039;, translated);
			});
		});

		it(&#039;should not translate [[derp:xyz] some text&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[derp:xyz] some text&#039;).then((translated) =&gt; {
				assert.strictEqual(&#039;[[derp:xyz] some text&#039;, translated);
			});
		});

		it(&#039;should translate keys with slashes properly&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[pages:users/latest]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;Latest Users&#039;);
			});
		});

		it(&#039;should use key for unknown keys without arguments&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[unknown:key.without.args]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;key.without.args&#039;);
			});
		});

		it(&#039;should use backup for unknown keys with arguments&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;[[unknown:key.with.args, arguments are here, derpity, derp]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;unknown:key.with.args, arguments are here, derpity, derp&#039;);
			});
		});

		it(&#039;should ignore unclosed tokens&#039;, () =&gt; {
			const translator = Translator.create(&#039;en-GB&#039;);
			return translator.translate(&#039;here is some stuff and other things [[abc:xyz, other random stuff should be fine here [[global:home]] and more things [[pages:users/latest]]&#039;).then((translated) =&gt; {
				assert.strictEqual(translated, &#039;here is some stuff and other things abc:xyz, other random stuff should be fine here Home and more things Latest Users&#039;);
			});
		});
	});
});

describe(&#039;Translator.create()&#039;, () =&gt; {
	it(&#039;should return an instance of Translator&#039;, (done) =&gt; {
		const translator = Translator.create(&#039;en-GB&#039;);

		assert(translator instanceof Translator);
		done();
	});
	it(&#039;should return the same object for the same language&#039;, (done) =&gt; {
		const one = Translator.create(&#039;de&#039;);
		const two = Translator.create(&#039;de&#039;);

		assert.strictEqual(one, two);
		done();
	});
	it(&#039;should default to defaultLang&#039;, (done) =&gt; {
		const translator = Translator.create();

		assert.strictEqual(translator.lang, &#039;en-GB&#039;);
		done();
	});
});

describe(&#039;Translator modules&#039;, () =&gt; {
	it(&#039;should work before registered&#039;, () =&gt; {
		const translator = Translator.create();

		Translator.registerModule(&#039;test-custom-integer-format&#039;, lang =&gt; function (key, args) {
			const num = parseInt(args[0], 10) || 0;
			if (key === &#039;binary&#039;) {
				return num.toString(2);
			}
			if (key === &#039;hex&#039;) {
				return num.toString(16);
			}
			if (key === &#039;octal&#039;) {
				return num.toString(8);
			}
			return num.toString();
		});

		return translator.translate(&#039;[[test-custom-integer-format:octal, 24]]&#039;).then((translation) =&gt; {
			assert.strictEqual(translation, &#039;30&#039;);
		});
	});

	it(&#039;should work after registered&#039;, () =&gt; {
		const translator = Translator.create(&#039;de&#039;);

		return translator.translate(&#039;[[test-custom-integer-format:octal, 23]]&#039;).then((translation) =&gt; {
			assert.strictEqual(translation, &#039;27&#039;);
		});
	});

	it(&#039;registerModule be passed the language&#039;, (done) =&gt; {
		Translator.registerModule(&#039;something&#039;, (lang) =&gt; {
			assert.ok(lang);
		});

		const translator = Translator.create(&#039;fr_FR&#039;);
		done();
	});
});

describe(&#039;Translator static methods&#039;, () =&gt; {
	describe(&#039;.removePatterns&#039;, () =&gt; {
		it(&#039;should remove translator patterns from text&#039;, (done) =&gt; {
			assert.strictEqual(
				Translator.removePatterns(&#039;Lorem ipsum dolor [[sit:amet]], consectetur adipiscing elit. [[sed:vitae, [[semper:dolor]]]] lorem&#039;),
				&#039;Lorem ipsum dolor , consectetur adipiscing elit.  lorem&#039;
			);
			done();
		});
	});
	describe(&#039;.escape&#039;, () =&gt; {
		it(&#039;should escape translation patterns within text&#039;, (done) =&gt; {
			assert.strictEqual(
				Translator.escape(&#039;some nice text [[global:home]] here&#039;),
				&#039;some nice text &amp;lsqb;&amp;lsqb;global:home&amp;rsqb;&amp;rsqb; here&#039;
			);
			done();
		});
	});

	describe(&#039;.unescape&#039;, () =&gt; {
		it(&#039;should unescape escaped translation patterns within text&#039;, (done) =&gt; {
			assert.strictEqual(
				Translator.unescape(&#039;some nice text &amp;lsqb;&amp;lsqb;global:home&amp;rsqb;&amp;rsqb; here&#039;),
				&#039;some nice text [[global:home]] here&#039;
			);
			done();
		});
	});

	describe(&#039;.compile&#039;, () =&gt; {
		it(&#039;should create a translator pattern from a key and list of arguments&#039;, (done) =&gt; {
			assert.strictEqual(
				Translator.compile(&#039;amazing:cool&#039;, &#039;awesome&#039;, &#039;great&#039;),
				&#039;[[amazing:cool, awesome, great]]&#039;
			);
			done();
		});

		it(&#039;should escape `%` and `,` in arguments&#039;, (done) =&gt; {
			assert.strictEqual(
				Translator.compile(&#039;amazing:cool&#039;, &#039;100% awesome!&#039;, &#039;one, two, and three&#039;),
				&#039;[[amazing:cool, 100&amp;#37; awesome!, one&amp;#44; two&amp;#44; and three]]&#039;
			);
			done();
		});
	});

	describe(&#039;add translation&#039;, () =&gt; {
		it(&#039;should add custom translations&#039;, async () =&gt; {
			shim.addTranslation(&#039;en-GB&#039;, &#039;my-namespace&#039;, { foo: &#039;a custom translation&#039; });
			const t = await shim.translate(&#039;this is best [[my-namespace:foo]]&#039;);
			assert.strictEqual(t, &#039;this is best a custom translation&#039;);
		});
	});

	describe(&#039;translate nested keys&#039;, () =&gt; {
		it(&#039;should handle nested translations&#039;, async () =&gt; {
			shim.addTranslation(&#039;en-GB&#039;, &#039;my-namespace&#039;, {
				key: {
					key1: &#039;key1 translated&#039;,
					key2: {
						key3: &#039;key3 translated&#039;,
					},
				},
			});
			const t1 = await shim.translate(&#039;this is best [[my-namespace:key.key1]]&#039;);
			const t2 = await shim.translate(&#039;this is best [[my-namespace:key.key2.key3]]&#039;);
			assert.strictEqual(t1, &#039;this is best key1 translated&#039;);
			assert.strictEqual(t2, &#039;this is best key3 translated&#039;);
		});
		it(&quot;should try the defaults if it didn&#039;t reach a string in a nested translation&quot;, async () =&gt; {
			shim.addTranslation(&#039;en-GB&#039;, &#039;my-namespace&#039;, {
				default1: {
					default1: &#039;default1 translated&#039;,
					&#039;&#039;: &#039;incorrect priority&#039;,
				},
				default2: {
					&#039;&#039;: &#039;default2 translated&#039;,
				},
			});
			const d1 = await shim.translate(&#039;this is best [[my-namespace:default1]]&#039;);
			const d2 = await shim.translate(&#039;this is best [[my-namespace:default2]]&#039;);
			assert.strictEqual(d1, &#039;this is best default1 translated&#039;);
			assert.strictEqual(d2, &#039;this is best default2 translated&#039;);
		});
	});
});
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
