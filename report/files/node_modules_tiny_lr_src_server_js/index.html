<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/tiny-lr/src/server.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/tiny-lr/src/server.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">66.10</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">396</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">60.91</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">5.14</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

Object.defineProperty(exports, &quot;__esModule&quot;, {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i &lt; props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (&quot;value&quot; in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _fs = require(&#039;fs&#039;);

var _fs2 = _interopRequireDefault(_fs);

var _http = require(&#039;http&#039;);

var _http2 = _interopRequireDefault(_http);

var _https = require(&#039;https&#039;);

var _https2 = _interopRequireDefault(_https);

var _events = require(&#039;events&#039;);

var _events2 = _interopRequireDefault(_events);

var _url = require(&#039;url&#039;);

var _client = require(&#039;./client&#039;);

var _client2 = _interopRequireDefault(_client);

var _package = require(&#039;../package.json&#039;);

var _package2 = _interopRequireDefault(_package);

var _any = require(&#039;body/any&#039;);

var _any2 = _interopRequireDefault(_any);

var _qs = require(&#039;qs&#039;);

var _qs2 = _interopRequireDefault(_qs);

function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(&quot;Cannot call a class as a function&quot;); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(&quot;this hasn&#039;t been initialised - super() hasn&#039;t been called&quot;); } return call &amp;&amp; (typeof call === &quot;object&quot; || typeof call === &quot;function&quot;) ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== &quot;function&quot; &amp;&amp; superClass !== null) { throw new TypeError(&quot;Super expression must either be null or a function, not &quot; + typeof superClass); } subClass.prototype = Object.create(superClass &amp;&amp; superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var debug = require(&#039;debug&#039;)(&#039;tinylr:server&#039;);

var CONTENT_TYPE = &#039;content-type&#039;;
var FORM_TYPE = &#039;application/x-www-form-urlencoded&#039;;

function buildRootPath() {
  var prefix = arguments.length &gt; 0 &amp;&amp; arguments[0] !== undefined ? arguments[0] : &#039;/&#039;;

  var rootUrl = prefix;

  // Add trailing slash
  if (prefix[prefix.length - 1] !== &#039;/&#039;) {
    rootUrl = rootUrl + &#039;/&#039;;
  }

  // Add leading slash
  if (prefix[0] !== &#039;/&#039;) {
    rootUrl = &#039;/&#039; + rootUrl;
  }

  return rootUrl;
}

var Server = function (_events$EventEmitter) {
  _inherits(Server, _events$EventEmitter);

  function Server() {
    var options = arguments.length &gt; 0 &amp;&amp; arguments[0] !== undefined ? arguments[0] : {};

    _classCallCheck(this, Server);

    var _this = _possibleConstructorReturn(this, (Server.__proto__ || Object.getPrototypeOf(Server)).call(this));

    _this.options = options;

    options.livereload = options.livereload || require.resolve(&#039;livereload-js/dist/livereload.js&#039;);

    // todo: change falsy check to allow 0 for random port
    options.port = parseInt(options.port || 35729, 10);

    if (options.errorListener) {
      _this.errorListener = options.errorListener;
    }

    _this.rootPath = buildRootPath(options.prefix);

    _this.clients = {};
    _this.configure(options.app);
    _this.routes(options.app);
    return _this;
  }

  _createClass(Server, [{
    key: &#039;routes&#039;,
    value: function routes() {
      if (!this.options.dashboard) {
        this.on(&#039;GET &#039; + this.rootPath, this.index.bind(this));
      }

      this.on(&#039;GET &#039; + this.rootPath + &#039;changed&#039;, this.changed.bind(this));
      this.on(&#039;POST &#039; + this.rootPath + &#039;changed&#039;, this.changed.bind(this));
      this.on(&#039;POST &#039; + this.rootPath + &#039;alert&#039;, this.alert.bind(this));
      this.on(&#039;GET &#039; + this.rootPath + &#039;livereload.js&#039;, this.livereload.bind(this));
      this.on(&#039;GET &#039; + this.rootPath + &#039;kill&#039;, this.close.bind(this));
    }
  }, {
    key: &#039;configure&#039;,
    value: function configure(app) {
      var _this2 = this;

      debug(&#039;Configuring %s&#039;, app ? &#039;connect / express application&#039; : &#039;HTTP server&#039;);

      var handler = this.options.handler || this.handler;

      if (!app) {
        if (this.options.key &amp;&amp; this.options.cert || this.options.pfx) {
          this.server = _https2.default.createServer(this.options, handler.bind(this));
        } else {
          this.server = _http2.default.createServer(handler.bind(this));
        }

        this.server.on(&#039;upgrade&#039;, this.websocketify.bind(this));
        this.server.on(&#039;error&#039;, this.error.bind(this));
        return this;
      }

      this.app = app;
      this.app.listen = function (port, done) {
        done = done || function () {};
        if (port !== _this2.options.port) {
          debug(&#039;Warn: LiveReload port is not standard (%d). You are listening on %d&#039;, _this2.options.port, port);
          debug(&#039;You\&#039;ll need to rely on the LiveReload snippet&#039;);
          debug(&#039;&gt; http://feedback.livereload.com/knowledgebase/articles/86180-how-do-i-add-the-script-tag-manually-&#039;);
        }

        var srv = _this2.server = _http2.default.createServer(app);
        srv.on(&#039;upgrade&#039;, _this2.websocketify.bind(_this2));
        srv.on(&#039;error&#039;, _this2.error.bind(_this2));
        srv.on(&#039;close&#039;, _this2.close.bind(_this2));
        return srv.listen(port, done);
      };

      return this;
    }
  }, {
    key: &#039;handler&#039;,
    value: function handler(req, res, next) {
      var _this3 = this;

      var middleware = typeof next === &#039;function&#039;;
      debug(&#039;LiveReload handler %s (middleware: %s)&#039;, req.url, middleware ? &#039;on&#039; : &#039;off&#039;);

      next = next || this.defaultHandler.bind(this, res);
      req.headers[CONTENT_TYPE] = req.headers[CONTENT_TYPE] || FORM_TYPE;
      return (0, _any2.default)(req, res, function (err, body) {
        if (err) return next(err);
        req.body = body;

        if (!req.query) {
          req.query = req.url.indexOf(&#039;?&#039;) !== -1 ? _qs2.default.parse((0, _url.parse)(req.url).query) : {};
        }

        return _this3.handle(req, res, next);
      });
    }
  }, {
    key: &#039;index&#039;,
    value: function index(req, res) {
      res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
      res.write(JSON.stringify({
        tinylr: &#039;Welcome&#039;,
        version: _package2.default.version
      }));

      res.end();
    }
  }, {
    key: &#039;handle&#039;,
    value: function handle(req, res, next) {
      var url = (0, _url.parse)(req.url);
      debug(&#039;Request:&#039;, req.method, url.href);
      var middleware = typeof next === &#039;function&#039;;

      // do the routing
      var route = req.method + &#039; &#039; + url.pathname;
      var respond = this.emit(route, req, res);
      if (respond) return;

      if (middleware) return next();

      // Only apply content-type on non middleware setup #70
      return this.notFound(res);
    }
  }, {
    key: &#039;defaultHandler&#039;,
    value: function defaultHandler(res, err) {
      if (!err) return this.notFound(res);

      this.error(err);
      res.setHeader(&#039;Content-Type&#039;, &#039;text/plain&#039;);
      res.statusCode = 500;
      res.end(&#039;Error: &#039; + err.stack);
    }
  }, {
    key: &#039;notFound&#039;,
    value: function notFound(res) {
      res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
      res.writeHead(404);
      res.write(JSON.stringify({
        error: &#039;not_found&#039;,
        reason: &#039;no such route&#039;
      }));
      res.end();
    }
  }, {
    key: &#039;websocketify&#039;,
    value: function websocketify(req, socket, head) {
      var _this4 = this;

      var client = new _client2.default(req, socket, head, this.options);
      this.clients[client.id] = client;

      // handle socket error to prevent possible app crash, such as ECONNRESET
      socket.on(&#039;error&#039;, function (e) {
        // ignore frequent ECONNRESET error (seems inevitable when refresh)
        if (e.code === &#039;ECONNRESET&#039;) return;
        _this4.error(e);
      });

      client.once(&#039;info&#039;, function (data) {
        debug(&#039;Create client %s (url: %s)&#039;, data.id, data.url);
        _this4.emit(&#039;MSG /create&#039;, data.id, data.url);
      });

      client.once(&#039;end&#039;, function () {
        debug(&#039;Destroy client %s (url: %s)&#039;, client.id, client.url);
        _this4.emit(&#039;MSG /destroy&#039;, client.id, client.url);
        delete _this4.clients[client.id];
      });
    }
  }, {
    key: &#039;listen&#039;,
    value: function listen(port, host, fn) {
      port = port || this.options.port;

      // Last used port for error display
      this.port = port;

      if (typeof host === &#039;function&#039;) {
        fn = host;
        host = undefined;
      }

      this.server.listen(port, host, fn);
    }
  }, {
    key: &#039;close&#039;,
    value: function close(req, res) {
      Object.keys(this.clients).forEach(function (id) {
        this.clients[id].close();
      }, this);

      if (this.server._handle) this.server.close(this.emit.bind(this, &#039;close&#039;));

      if (res) res.end();
    }
  }, {
    key: &#039;error&#039;,
    value: function error(e) {
      if (this.errorListener) {
        this.errorListener(e);
        return;
      }

      console.error();
      if (typeof e === &#039;undefined&#039;) {
        console.error(&#039;... Uhoh. Got error %s ...&#039;, e);
      } else {
        console.error(&#039;... Uhoh. Got error %s ...&#039;, e.message);
        console.error(e.stack);

        if (e.code !== &#039;EADDRINUSE&#039;) return;
        console.error();
        console.error(&#039;You already have a server listening on %s&#039;, this.port);
        console.error(&#039;You should stop it and try again.&#039;);
        console.error();
      }
    }

    // Routes

  }, {
    key: &#039;livereload&#039;,
    value: function livereload(req, res) {
      res.setHeader(&#039;Content-Type&#039;, &#039;application/javascript&#039;);
      _fs2.default.createReadStream(this.options.livereload).pipe(res);
    }
  }, {
    key: &#039;changed&#039;,
    value: function changed(req, res) {
      var files = this.param(&#039;files&#039;, req);

      debug(&#039;Changed event (Files: %s)&#039;, files.join(&#039; &#039;));
      var clients = this.notifyClients(files);

      if (!res) return;

      res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
      res.write(JSON.stringify({
        clients: clients,
        files: files
      }));

      res.end();
    }
  }, {
    key: &#039;alert&#039;,
    value: function alert(req, res) {
      var message = this.param(&#039;message&#039;, req);

      debug(&#039;Alert event (Message: %s)&#039;, message);
      var clients = this.alertClients(message);

      if (!res) return;

      res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
      res.write(JSON.stringify({
        clients: clients,
        message: message
      }));

      res.end();
    }
  }, {
    key: &#039;notifyClients&#039;,
    value: function notifyClients(files) {
      var clients = Object.keys(this.clients).map(function (id) {
        var client = this.clients[id];
        debug(&#039;Reloading client %s (url: %s)&#039;, client.id, client.url);
        client.reload(files);
        return {
          id: client.id,
          url: client.url
        };
      }, this);

      return clients;
    }
  }, {
    key: &#039;alertClients&#039;,
    value: function alertClients(message) {
      var clients = Object.keys(this.clients).map(function (id) {
        var client = this.clients[id];
        debug(&#039;Alert client %s (url: %s)&#039;, client.id, client.url);
        client.alert(message);
        return {
          id: client.id,
          url: client.url
        };
      }, this);

      return clients;
    }

    // Lookup param from body / params / query.

  }, {
    key: &#039;param&#039;,
    value: function param(name, req) {
      var param = void 0;
      if (req.body &amp;&amp; req.body[name]) param = req.body[name];else if (req.params &amp;&amp; req.params[name]) param = req.params[name];else if (req.query &amp;&amp; req.query[name]) param = req.query[name];

      // normalize files array
      if (name === &#039;files&#039;) {
        param = Array.isArray(param) ? param : typeof param === &#039;string&#039; ? param.split(/[\s,]/) : [];
      }

      return param;
    }
  }]);

  return Server;
}(_events2.default.EventEmitter);

exports.default = Server;
module.exports = exports[&#039;default&#039;];</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
