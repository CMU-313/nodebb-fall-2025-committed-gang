<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/fido2-lib/lib/utils.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/fido2-lib/lib/utils.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">66.14</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">384</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">70.75</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.04</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&quot;use strict&quot;;

var psl = require(&quot;psl&quot;);
var { URL } = require(&quot;url&quot;);

class Fido2LibError extends Error {
	constructor(message, type) {
		super();
		Error.captureStackTrace(this, this.constructor);
		this.name = this.constructor.name;
		this.message = message;
		this.extra = type;
	}
}

/* istanbul ignore next */
function printHex(msg, buf) {
	// if the buffer was a TypedArray (e.g. Uint8Array), grab its buffer and use that
	if (ArrayBuffer.isView(buf) &amp;&amp; buf.buffer instanceof ArrayBuffer) {
		buf = buf.buffer;
	}

	// check the arguments
	if ((typeof msg != &quot;string&quot;) ||
        (typeof buf != &quot;object&quot;)) {
		console.log(&quot;Bad args to printHex&quot;); // eslint-disable-line no-console
		return;
	}
	if (!(buf instanceof ArrayBuffer)) {
		console.log(&quot;Attempted printHex with non-ArrayBuffer:&quot;, buf); // eslint-disable-line no-console
		return;
	}

	// print the buffer as a 16 byte long hex string
	var arr = new Uint8Array(buf);
	var len = buf.byteLength;
	var i, str = &quot;&quot;;
	console.log(msg, `(${buf.byteLength} bytes)`); // eslint-disable-line no-console
	for (i = 0; i &lt; len; i++) {
		var hexch = arr[i].toString(16);
		hexch = (hexch.length == 1) ? (&quot;0&quot; + hexch) : hexch;
		str += hexch.toUpperCase() + &quot; &quot;;
		if (i &amp;&amp; !((i + 1) % 16)) {
			console.log(str); // eslint-disable-line no-console
			str = &quot;&quot;;
		}
	}
	// print the remaining bytes
	if ((i) % 16) {
		console.log(str); // eslint-disable-line no-console
	}
}

function coerceToBase64(thing, name) {
	if (!name) {
		throw new TypeError(&quot;name not specified in coerceToBase64&quot;);
	}

	// Array to Uint8Array
	if (Array.isArray(thing)) {
		thing = Uint8Array.from(thing);
	}

	// Uint8Array, etc. to ArrayBuffer
	if (typeof thing === &quot;object&quot; &amp;&amp;
        thing.buffer instanceof ArrayBuffer &amp;&amp;
        !(thing instanceof Buffer)) {
		thing = thing.buffer;
	}

	// ArrayBuffer to Buffer
	if (thing instanceof ArrayBuffer &amp;&amp; !(thing instanceof Buffer)) {
		thing = Buffer.from(thing);
	}

	// Buffer to base64 string
	if (thing instanceof Buffer) {
		thing = thing.toString(&quot;base64&quot;);
	}

	if (typeof thing !== &quot;string&quot;) {
		throw new Error(`could not coerce &#039;${name}&#039; to string`);
	}

	return thing;
}

function coerceToBase64Url(thing, name) {
	thing = coerceToBase64(thing, name);

	// base64 to base64url
	// NOTE: &quot;=&quot; at the end of challenge is optional, strip it off here so that it&#039;s compatible with client
	thing = thing.replace(/\+/g, &quot;-&quot;).replace(/\//g, &quot;_&quot;).replace(/=*$/g, &quot;&quot;);

	return thing;
}

function coerceToArrayBuffer(buf, name) {
	if (!name) {
		throw new TypeError(&quot;name not specified in coerceToArrayBuffer&quot;);
	}

	if (typeof buf === &quot;string&quot;) {
		// base64url to base64
		buf = buf.replace(/-/g, &quot;+&quot;).replace(/_/g, &quot;/&quot;);
		// base64 to Buffer
		buf = Buffer.from(buf, &quot;base64&quot;);
	}

	// Buffer or Array to Uint8Array
	if (buf instanceof Buffer || Array.isArray(buf)) {
		buf = new Uint8Array(buf);
	}

	// Uint8Array to ArrayBuffer
	if (buf instanceof Uint8Array) {
		buf = buf.buffer;
	}

	// error if none of the above worked
	if (!(buf instanceof ArrayBuffer)) {
		throw new TypeError(`could not coerce &#039;${name}&#039; to ArrayBuffer`);
	}

	return buf;
}

function ab2str(buf) {
	var str = &quot;&quot;;
	new Uint8Array(buf).forEach((ch) =&gt; {
		str += String.fromCharCode(ch);
	});
	return str;
}

function str2ab(str) {
	var buf = new ArrayBuffer(str.length);
	var bufView = new Uint8Array(buf);
	for (var i = 0, strLen = str.length; i &lt; strLen; i++) {
		bufView[i] = str.charCodeAt(i);
	}
	return buf;
}

function isBase64Url(str) {
	return !!str.match(/^[A-Za-z0-9\-_]+={0,2}$/);
}

function checkOrigin(str) {
	var originUrl = new URL(str);
	var origin = originUrl.origin;

	if (origin !== str) {
		throw new Error(&quot;origin was malformatted&quot;);
	}

	var isLocalhost = (originUrl.hostname == &quot;localhost&quot; || originUrl.hostname.endsWith(&quot;.localhost&quot;));

	if (originUrl.protocol !== &quot;https:&quot; &amp;&amp; !isLocalhost) {
		throw new Error(&quot;origin should be https&quot;);
	}

	if (!psl.isValid(originUrl.hostname) &amp;&amp; !isLocalhost) {
		throw new Error(&quot;origin is not a valid eTLD+1&quot;);
	}

	return origin;
}

function checkUrl(value, name, rules = {}) {
	if (!name) {
		throw new TypeError(&quot;name not specified in checkUrl&quot;);
	}

	if (typeof value !== &quot;string&quot;) {
		throw new Error(`${name} must be a string`);
	}

	let urlValue = null;
	try {
		urlValue = new URL(value);
	} catch (err) {
		throw new Error(`${name} is not a valid eTLD+1/url`);
	}

	if (!value.startsWith(&quot;http&quot;)) {
		throw new Error(`${name} must be http protocol`);
	}

	if (!rules.allowHttp &amp;&amp; urlValue.protocol !== &quot;https:&quot;) {
		throw new Error(`${name} should be https`);
	}

	// origin: base url without path including /
	if (!rules.allowPath &amp;&amp; (value.endsWith(&quot;/&quot;) || urlValue.pathname !== &quot;/&quot;)) { // urlValue adds / in path always
		throw new Error(`${name} should not include path in url`);
	}

	if (!rules.allowHash &amp;&amp; urlValue.hash) {
		throw new Error(`${name} should not include hash in url`);
	}

	if (!rules.allowCred &amp;&amp; (urlValue.username || urlValue.password)) {
		throw new Error(`${name} should not include credentials in url`);
	}

	if (!rules.allowQuery &amp;&amp; urlValue.search) {
		throw new Error(`${name} should not include query string in url`);
	}

	return value;
}

function checkDomainOrUrl(value, name, rules = {}) {
	if (!name) {
		throw new TypeError(&quot;name not specified in checkDomainOrUrl&quot;);
	}

	if (typeof value !== &quot;string&quot;) {
		throw new Error(`${name} must be a string`);
	}

	if (psl.isValid(value)) return value; // if valid domain no need for futher checks

	return checkUrl(value, name, rules);
}

function checkRpId(rpId) {
	if (typeof rpId !== &quot;string&quot;) {
		throw new Error(&quot;rpId must be a string&quot;);
	}

	var isLocalhost = (rpId === &quot;localhost&quot; || rpId.endsWith(&quot;.localhost&quot;));

	if (isLocalhost) return rpId;

	return checkDomainOrUrl(rpId, &quot;rpId&quot;);
}

function bufEqual(a, b) {
	var len = a.length;

	if (len !== b.length) {
		return false;
	}

	for (var i = 0; i &lt; len; i++) {
		if (a.readUInt8(i) !== b.readUInt8(i)) {
			return false;
		}
	}

	return true;
}

function abEqual(a, b) {
	var len = a.byteLength;

	if (len !== b.byteLength) {
		return false;
	}

	a = new Uint8Array(a);
	b = new Uint8Array(b);
	for (let i = 0; i &lt; len; i++) {
		if (a[i] !== b[i]) {
			return false;
		}
	}

	return true;
}

function isPem(pem) {
	if (typeof pem !== &quot;string&quot;) {
		return false;
	}

	var pemRegex = /^-----BEGIN .+-----$\n([A-Za-z0-9+/=]|\n)*^-----END .+-----$/m;
	return !!pem.match(pemRegex);
}

function pemToBase64(pem) {
	if (!isPem(pem)) {
		throw new Error(&quot;expected PEM string as input&quot;);
	}

	var pemArr = pem.split(&quot;\n&quot;);
	// remove first and last lines
	pemArr = pemArr.slice(1, pemArr.length - 2);
	return pemArr.join(&quot;&quot;);
}

function isPositiveInteger(n) {
	return n &gt;&gt;&gt; 0 === parseFloat(n);
}

function abToBuf(ab) {
	return Buffer.from(new Uint8Array(ab));
}

function abToPem(type, ab) {
	if (typeof type !== &quot;string&quot;) {
		throw new Error(&quot;abToPem expected &#039;type&#039; to be string like &#039;CERTIFICATE&#039;, got: &quot; + type);
	}

	var str = coerceToBase64(ab, &quot;pem buffer&quot;);

	return [
		`-----BEGIN ${type}-----\n`,
		...str.match(/.{1,64}/g).map((s) =&gt; s + &quot;\n&quot;),
		`-----END ${type}-----\n`,
	].join(&quot;&quot;);
}

function arrayBufferEquals(b1, b2) {
	if (!(b1 instanceof ArrayBuffer) ||
            !(b2 instanceof ArrayBuffer)) {
		console.log(&quot;not array buffers&quot;);
		return false;
	}

	if (b1.byteLength !== b2.byteLength) {
		console.log(&quot;not same length&quot;);
		return false;
	}
	b1 = new Uint8Array(b1);
	b2 = new Uint8Array(b2);
	for (let i = 0; i &lt; b1.byteLength; i++) {
		if (b1[i] !== b2[i]) return false;
	}
	return true;
}

function abToInt(ab) {
	if (!(ab instanceof ArrayBuffer)) {
		throw new Error(&quot;abToInt: expected ArrayBuffer&quot;);
	}

	var buf = new Uint8Array(ab);
	var cnt = ab.byteLength - 1;
	var ret = 0;
	buf.forEach((byte) =&gt; {
		ret |= (byte &lt;&lt; (cnt * 8));
		cnt--;
	});

	return ret;
}

function b64ToJsObject(b64, desc) {
	return JSON.parse(ab2str(coerceToArrayBuffer(b64, desc)));
}

function jsObjectToB64(obj) {
	return Buffer.from(JSON.stringify(obj).replace(/[\u{0080}-\u{FFFF}]/gu,&quot;&quot;)).toString(&quot;base64&quot;);
}

module.exports = {
	printHex,
	Fido2LibError,
	coerceToBase64,
	coerceToBase64Url,
	coerceToArrayBuffer,
	ab2str,
	str2ab,
	isBase64Url,
	checkOrigin,
	checkRpId,
	bufEqual,
	abEqual,
	isPem,
	pemToBase64,
	isPositiveInteger,
	abToBuf,
	abToPem,
	abToInt,
	arrayBufferEquals,
	b64ToJsObject,
	jsObjectToB64,
	checkUrl,
	checkDomainOrUrl,
};
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
