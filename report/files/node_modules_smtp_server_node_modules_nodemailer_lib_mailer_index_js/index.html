<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/smtp-server/node_modules/nodemailer/lib/mailer/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/smtp-server/node_modules/nodemailer/lib/mailer/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">66.15</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">442</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">47.85</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">4.00</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

const EventEmitter = require(&#039;events&#039;);
const shared = require(&#039;../shared&#039;);
const mimeTypes = require(&#039;../mime-funcs/mime-types&#039;);
const MailComposer = require(&#039;../mail-composer&#039;);
const DKIM = require(&#039;../dkim&#039;);
const httpProxyClient = require(&#039;../smtp-connection/http-proxy-client&#039;);
const util = require(&#039;util&#039;);
const urllib = require(&#039;url&#039;);
const packageData = require(&#039;../../package.json&#039;);
const MailMessage = require(&#039;./mail-message&#039;);
const net = require(&#039;net&#039;);
const dns = require(&#039;dns&#039;);
const crypto = require(&#039;crypto&#039;);

/**
 * Creates an object for exposing the Mail API
 *
 * @constructor
 * @param {Object} transporter Transport object instance to pass the mails to
 */
class Mail extends EventEmitter {
    constructor(transporter, options, defaults) {
        super();

        this.options = options || {};
        this._defaults = defaults || {};

        this._defaultPlugins = {
            compile: [(...args) =&gt; this._convertDataImages(...args)],
            stream: []
        };

        this._userPlugins = {
            compile: [],
            stream: []
        };

        this.meta = new Map();

        this.dkim = this.options.dkim ? new DKIM(this.options.dkim) : false;

        this.transporter = transporter;
        this.transporter.mailer = this;

        this.logger = shared.getLogger(this.options, {
            component: this.options.component || &#039;mail&#039;
        });

        this.logger.debug(
            {
                tnx: &#039;create&#039;
            },
            &#039;Creating transport: %s&#039;,
            this.getVersionString()
        );

        // setup emit handlers for the transporter
        if (typeof this.transporter.on === &#039;function&#039;) {
            // deprecated log interface
            this.transporter.on(&#039;log&#039;, log =&gt; {
                this.logger.debug(
                    {
                        tnx: &#039;transport&#039;
                    },
                    &#039;%s: %s&#039;,
                    log.type,
                    log.message
                );
            });

            // transporter errors
            this.transporter.on(&#039;error&#039;, err =&gt; {
                this.logger.error(
                    {
                        err,
                        tnx: &#039;transport&#039;
                    },
                    &#039;Transport Error: %s&#039;,
                    err.message
                );
                this.emit(&#039;error&#039;, err);
            });

            // indicates if the sender has became idle
            this.transporter.on(&#039;idle&#039;, (...args) =&gt; {
                this.emit(&#039;idle&#039;, ...args);
            });

            // indicates if the sender has became idle and all connections are terminated
            this.transporter.on(&#039;clear&#039;, (...args) =&gt; {
                this.emit(&#039;clear&#039;, ...args);
            });
        }

        /**
         * Optional methods passed to the underlying transport object
         */
        [&#039;close&#039;, &#039;isIdle&#039;, &#039;verify&#039;].forEach(method =&gt; {
            this[method] = (...args) =&gt; {
                if (typeof this.transporter[method] === &#039;function&#039;) {
                    if (method === &#039;verify&#039; &amp;&amp; typeof this.getSocket === &#039;function&#039;) {
                        this.transporter.getSocket = this.getSocket;
                        this.getSocket = false;
                    }
                    return this.transporter[method](...args);
                } else {
                    this.logger.warn(
                        {
                            tnx: &#039;transport&#039;,
                            methodName: method
                        },
                        &#039;Non existing method %s called for transport&#039;,
                        method
                    );
                    return false;
                }
            };
        });

        // setup proxy handling
        if (this.options.proxy &amp;&amp; typeof this.options.proxy === &#039;string&#039;) {
            this.setupProxy(this.options.proxy);
        }
    }

    use(step, plugin) {
        step = (step || &#039;&#039;).toString();
        if (!this._userPlugins.hasOwnProperty(step)) {
            this._userPlugins[step] = [plugin];
        } else {
            this._userPlugins[step].push(plugin);
        }

        return this;
    }

    /**
     * Sends an email using the preselected transport object
     *
     * @param {Object} data E-data description
     * @param {Function?} callback Callback to run once the sending succeeded or failed
     */
    sendMail(data, callback = null) {
        let promise;

        if (!callback) {
            promise = new Promise((resolve, reject) =&gt; {
                callback = shared.callbackPromise(resolve, reject);
            });
        }

        if (typeof this.getSocket === &#039;function&#039;) {
            this.transporter.getSocket = this.getSocket;
            this.getSocket = false;
        }

        let mail = new MailMessage(this, data);

        this.logger.debug(
            {
                tnx: &#039;transport&#039;,
                name: this.transporter.name,
                version: this.transporter.version,
                action: &#039;send&#039;
            },
            &#039;Sending mail using %s/%s&#039;,
            this.transporter.name,
            this.transporter.version
        );

        this._processPlugins(&#039;compile&#039;, mail, err =&gt; {
            if (err) {
                this.logger.error(
                    {
                        err,
                        tnx: &#039;plugin&#039;,
                        action: &#039;compile&#039;
                    },
                    &#039;PluginCompile Error: %s&#039;,
                    err.message
                );
                return callback(err);
            }

            mail.message = new MailComposer(mail.data).compile();

            mail.setMailerHeader();
            mail.setPriorityHeaders();
            mail.setListHeaders();

            this._processPlugins(&#039;stream&#039;, mail, err =&gt; {
                if (err) {
                    this.logger.error(
                        {
                            err,
                            tnx: &#039;plugin&#039;,
                            action: &#039;stream&#039;
                        },
                        &#039;PluginStream Error: %s&#039;,
                        err.message
                    );
                    return callback(err);
                }

                if (mail.data.dkim || this.dkim) {
                    mail.message.processFunc(input =&gt; {
                        let dkim = mail.data.dkim ? new DKIM(mail.data.dkim) : this.dkim;
                        this.logger.debug(
                            {
                                tnx: &#039;DKIM&#039;,
                                messageId: mail.message.messageId(),
                                dkimDomains: dkim.keys.map(key =&gt; key.keySelector + &#039;.&#039; + key.domainName).join(&#039;, &#039;)
                            },
                            &#039;Signing outgoing message with %s keys&#039;,
                            dkim.keys.length
                        );
                        return dkim.sign(input, mail.data._dkim);
                    });
                }

                this.transporter.send(mail, (...args) =&gt; {
                    if (args[0]) {
                        this.logger.error(
                            {
                                err: args[0],
                                tnx: &#039;transport&#039;,
                                action: &#039;send&#039;
                            },
                            &#039;Send Error: %s&#039;,
                            args[0].message
                        );
                    }
                    callback(...args);
                });
            });
        });

        return promise;
    }

    getVersionString() {
        return util.format(
            &#039;%s (%s; +%s; %s/%s)&#039;,
            packageData.name,
            packageData.version,
            packageData.homepage,
            this.transporter.name,
            this.transporter.version
        );
    }

    _processPlugins(step, mail, callback) {
        step = (step || &#039;&#039;).toString();

        if (!this._userPlugins.hasOwnProperty(step)) {
            return callback();
        }

        let userPlugins = this._userPlugins[step] || [];
        let defaultPlugins = this._defaultPlugins[step] || [];

        if (userPlugins.length) {
            this.logger.debug(
                {
                    tnx: &#039;transaction&#039;,
                    pluginCount: userPlugins.length,
                    step
                },
                &#039;Using %s plugins for %s&#039;,
                userPlugins.length,
                step
            );
        }

        if (userPlugins.length + defaultPlugins.length === 0) {
            return callback();
        }

        let pos = 0;
        let block = &#039;default&#039;;
        let processPlugins = () =&gt; {
            let curplugins = block === &#039;default&#039; ? defaultPlugins : userPlugins;
            if (pos &gt;= curplugins.length) {
                if (block === &#039;default&#039; &amp;&amp; userPlugins.length) {
                    block = &#039;user&#039;;
                    pos = 0;
                    curplugins = userPlugins;
                } else {
                    return callback();
                }
            }
            let plugin = curplugins[pos++];
            plugin(mail, err =&gt; {
                if (err) {
                    return callback(err);
                }
                processPlugins();
            });
        };

        processPlugins();
    }

    /**
     * Sets up proxy handler for a Nodemailer object
     *
     * @param {String} proxyUrl Proxy configuration url
     */
    setupProxy(proxyUrl) {
        let proxy = urllib.parse(proxyUrl);

        // setup socket handler for the mailer object
        this.getSocket = (options, callback) =&gt; {
            let protocol = proxy.protocol.replace(/:$/, &#039;&#039;).toLowerCase();

            if (this.meta.has(&#039;proxy_handler_&#039; + protocol)) {
                return this.meta.get(&#039;proxy_handler_&#039; + protocol)(proxy, options, callback);
            }

            switch (protocol) {
                // Connect using a HTTP CONNECT method
                case &#039;http&#039;:
                case &#039;https&#039;:
                    httpProxyClient(proxy.href, options.port, options.host, (err, socket) =&gt; {
                        if (err) {
                            return callback(err);
                        }
                        return callback(null, {
                            connection: socket
                        });
                    });
                    return;
                case &#039;socks&#039;:
                case &#039;socks5&#039;:
                case &#039;socks4&#039;:
                case &#039;socks4a&#039;: {
                    if (!this.meta.has(&#039;proxy_socks_module&#039;)) {
                        return callback(new Error(&#039;Socks module not loaded&#039;));
                    }
                    let connect = ipaddress =&gt; {
                        let proxyV2 = !!this.meta.get(&#039;proxy_socks_module&#039;).SocksClient;
                        let socksClient = proxyV2 ? this.meta.get(&#039;proxy_socks_module&#039;).SocksClient : this.meta.get(&#039;proxy_socks_module&#039;);
                        let proxyType = Number(proxy.protocol.replace(/\D/g, &#039;&#039;)) || 5;
                        let connectionOpts = {
                            proxy: {
                                ipaddress,
                                port: Number(proxy.port),
                                type: proxyType
                            },
                            [proxyV2 ? &#039;destination&#039; : &#039;target&#039;]: {
                                host: options.host,
                                port: options.port
                            },
                            command: &#039;connect&#039;
                        };

                        if (proxy.auth) {
                            let username = decodeURIComponent(proxy.auth.split(&#039;:&#039;).shift());
                            let password = decodeURIComponent(proxy.auth.split(&#039;:&#039;).pop());
                            if (proxyV2) {
                                connectionOpts.proxy.userId = username;
                                connectionOpts.proxy.password = password;
                            } else if (proxyType === 4) {
                                connectionOpts.userid = username;
                            } else {
                                connectionOpts.authentication = {
                                    username,
                                    password
                                };
                            }
                        }

                        socksClient.createConnection(connectionOpts, (err, info) =&gt; {
                            if (err) {
                                return callback(err);
                            }
                            return callback(null, {
                                connection: info.socket || info
                            });
                        });
                    };

                    if (net.isIP(proxy.hostname)) {
                        return connect(proxy.hostname);
                    }

                    return dns.resolve(proxy.hostname, (err, address) =&gt; {
                        if (err) {
                            return callback(err);
                        }
                        connect(Array.isArray(address) ? address[0] : address);
                    });
                }
            }
            callback(new Error(&#039;Unknown proxy configuration&#039;));
        };
    }

    _convertDataImages(mail, callback) {
        if ((!this.options.attachDataUrls &amp;&amp; !mail.data.attachDataUrls) || !mail.data.html) {
            return callback();
        }
        mail.resolveContent(mail.data, &#039;html&#039;, (err, html) =&gt; {
            if (err) {
                return callback(err);
            }
            let cidCounter = 0;
            html = (html || &#039;&#039;)
                .toString()
                .replace(/(&lt;img\b[^&lt;&gt;]{0,1024} src\s{0,20}=[\s&quot;&#039;]{0,20})(data:([^;]+);[^&quot;&#039;&gt;\s]+)/gi, (match, prefix, dataUri, mimeType) =&gt; {
                    let cid = crypto.randomBytes(10).toString(&#039;hex&#039;) + &#039;@localhost&#039;;
                    if (!mail.data.attachments) {
                        mail.data.attachments = [];
                    }
                    if (!Array.isArray(mail.data.attachments)) {
                        mail.data.attachments = [].concat(mail.data.attachments || []);
                    }
                    mail.data.attachments.push({
                        path: dataUri,
                        cid,
                        filename: &#039;image-&#039; + ++cidCounter + &#039;.&#039; + mimeTypes.detectExtension(mimeType)
                    });
                    return prefix + &#039;cid:&#039; + cid;
                });
            mail.data.html = html;
            callback();
        });
    }

    set(key, value) {
        return this.meta.set(key, value);
    }

    get(key) {
        return this.meta.get(key);
    }
}

module.exports = Mail;
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
