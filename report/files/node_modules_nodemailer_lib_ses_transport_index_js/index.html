<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/nodemailer/lib/ses-transport/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/nodemailer/lib/ses-transport/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">70.71</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">235</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">38.62</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.00</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

const EventEmitter = require(&#039;events&#039;);
const packageData = require(&#039;../../package.json&#039;);
const shared = require(&#039;../shared&#039;);
const LeWindows = require(&#039;../mime-node/le-windows&#039;);
const MimeNode = require(&#039;../mime-node&#039;);

/**
 * Generates a Transport object for AWS SES
 *
 * @constructor
 * @param {Object} optional config parameter
 */
class SESTransport extends EventEmitter {
    constructor(options) {
        super();
        options = options || {};

        this.options = options || {};
        this.ses = this.options.SES;

        this.name = &#039;SESTransport&#039;;
        this.version = packageData.version;

        this.logger = shared.getLogger(this.options, {
            component: this.options.component || &#039;ses-transport&#039;
        });
    }

    getRegion(cb) {
        if (this.ses.sesClient.config &amp;&amp; typeof this.ses.sesClient.config.region === &#039;function&#039;) {
            // promise
            return this.ses.sesClient.config
                .region()
                .then(region =&gt; cb(null, region))
                .catch(err =&gt; cb(err));
        }
        return cb(null, false);
    }

    /**
     * Compiles a mailcomposer message and forwards it to SES
     *
     * @param {Object} emailMessage MailComposer object
     * @param {Function} callback Callback function to run when the sending is completed
     */
    send(mail, callback) {
        let statObject = {
            ts: Date.now(),
            pending: true
        };

        let fromHeader = mail.message._headers.find(header =&gt; /^from$/i.test(header.key));
        if (fromHeader) {
            let mimeNode = new MimeNode(&#039;text/plain&#039;);
            fromHeader = mimeNode._convertAddresses(mimeNode._parseAddresses(fromHeader.value));
        }

        let envelope = mail.data.envelope || mail.message.getEnvelope();
        let messageId = mail.message.messageId();

        let recipients = [].concat(envelope.to || []);
        if (recipients.length &gt; 3) {
            recipients.push(&#039;...and &#039; + recipients.splice(2).length + &#039; more&#039;);
        }
        this.logger.info(
            {
                tnx: &#039;send&#039;,
                messageId
            },
            &#039;Sending message %s to &lt;%s&gt;&#039;,
            messageId,
            recipients.join(&#039;, &#039;)
        );

        let getRawMessage = next =&gt; {
            // do not use Message-ID and Date in DKIM signature
            if (!mail.data._dkim) {
                mail.data._dkim = {};
            }
            if (mail.data._dkim.skipFields &amp;&amp; typeof mail.data._dkim.skipFields === &#039;string&#039;) {
                mail.data._dkim.skipFields += &#039;:date:message-id&#039;;
            } else {
                mail.data._dkim.skipFields = &#039;date:message-id&#039;;
            }

            let sourceStream = mail.message.createReadStream();
            let stream = sourceStream.pipe(new LeWindows());
            let chunks = [];
            let chunklen = 0;

            stream.on(&#039;readable&#039;, () =&gt; {
                let chunk;
                while ((chunk = stream.read()) !== null) {
                    chunks.push(chunk);
                    chunklen += chunk.length;
                }
            });

            sourceStream.once(&#039;error&#039;, err =&gt; stream.emit(&#039;error&#039;, err));

            stream.once(&#039;error&#039;, err =&gt; {
                next(err);
            });

            stream.once(&#039;end&#039;, () =&gt; next(null, Buffer.concat(chunks, chunklen)));
        };

        setImmediate(() =&gt;
            getRawMessage((err, raw) =&gt; {
                if (err) {
                    this.logger.error(
                        {
                            err,
                            tnx: &#039;send&#039;,
                            messageId
                        },
                        &#039;Failed creating message for %s. %s&#039;,
                        messageId,
                        err.message
                    );
                    statObject.pending = false;
                    return callback(err);
                }

                let sesMessage = {
                    Content: {
                        Raw: {
                            // required
                            Data: raw // required
                        }
                    },
                    FromEmailAddress: fromHeader ? fromHeader : envelope.from,
                    Destination: {
                        ToAddresses: envelope.to
                    }
                };

                Object.keys(mail.data.ses || {}).forEach(key =&gt; {
                    sesMessage[key] = mail.data.ses[key];
                });

                this.getRegion((err, region) =&gt; {
                    if (err || !region) {
                        region = &#039;us-east-1&#039;;
                    }

                    const command = new this.ses.SendEmailCommand(sesMessage);
                    const sendPromise = this.ses.sesClient.send(command);

                    sendPromise
                        .then(data =&gt; {
                            if (region === &#039;us-east-1&#039;) {
                                region = &#039;email&#039;;
                            }

                            statObject.pending = true;
                            callback(null, {
                                envelope: {
                                    from: envelope.from,
                                    to: envelope.to
                                },
                                messageId: &#039;&lt;&#039; + data.MessageId + (!/@/.test(data.MessageId) ? &#039;@&#039; + region + &#039;.amazonses.com&#039; : &#039;&#039;) + &#039;&gt;&#039;,
                                response: data.MessageId,
                                raw
                            });
                        })
                        .catch(err =&gt; {
                            this.logger.error(
                                {
                                    err,
                                    tnx: &#039;send&#039;
                                },
                                &#039;Send error for %s: %s&#039;,
                                messageId,
                                err.message
                            );
                            statObject.pending = false;
                            callback(err);
                        });
                });
            })
        );
    }

    /**
     * Verifies SES configuration
     *
     * @param {Function} callback Callback function
     */
    verify(callback) {
        let promise;
        if (!callback) {
            promise = new Promise((resolve, reject) =&gt; {
                callback = shared.callbackPromise(resolve, reject);
            });
        }

        const cb = err =&gt; {
            if (err &amp;&amp; ![&#039;InvalidParameterValue&#039;, &#039;MessageRejected&#039;].includes(err.code || err.Code || err.name)) {
                return callback(err);
            }
            return callback(null, true);
        };

        const sesMessage = {
            Content: {
                Raw: {
                    Data: Buffer.from(&#039;From: &lt;invalid@invalid&gt;\r\nTo: &lt;invalid@invalid&gt;\r\n Subject: Invalid\r\n\r\nInvalid&#039;)
                }
            },
            FromEmailAddress: &#039;invalid@invalid&#039;,
            Destination: {
                ToAddresses: [&#039;invalid@invalid&#039;]
            }
        };

        this.getRegion((err, region) =&gt; {
            if (err || !region) {
                region = &#039;us-east-1&#039;;
            }

            const command = new this.ses.SendEmailCommand(sesMessage);
            const sendPromise = this.ses.sesClient.send(command);

            sendPromise.then(data =&gt; cb(null, data)).catch(err =&gt; cb(err));
        });

        return promise;
    }
}

module.exports = SESTransport;
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
