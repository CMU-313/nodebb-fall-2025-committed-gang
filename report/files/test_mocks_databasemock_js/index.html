<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - test/mocks/databasemock.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>test/mocks/databasemock.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">61.41</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">266</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">28.88</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.98</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

/**
 * Database Mock - wrapper for database.js, makes system use separate test db, instead of production
 * ATTENTION: testing db is flushed before every use!
 */

require(&#039;../../require-main&#039;);

const path = require(&#039;path&#039;);
const nconf = require(&#039;nconf&#039;);
const url = require(&#039;url&#039;);
const util = require(&#039;util&#039;);

process.env.NODE_ENV = process.env.TEST_ENV || &#039;production&#039;;
global.env = process.env.NODE_ENV || &#039;production&#039;;


const winston = require(&#039;winston&#039;);
const packageInfo = require(&#039;../../package.json&#039;);

winston.add(new winston.transports.Console({
	format: winston.format.combine(
		winston.format.splat(),
		winston.format.simple()
	),
}));

try {
	const fs = require(&#039;fs&#039;);
	const configJSON = fs.readFileSync(path.join(__dirname, &#039;../../config.json&#039;), &#039;utf-8&#039;);
	winston.info(&#039;configJSON&#039;);
	winston.info(configJSON);
} catch (err) {
	console.error(err.stack);
	throw err;
}

nconf.file({ file: path.join(__dirname, &#039;../../config.json&#039;) });
nconf.defaults({
	base_dir: path.join(__dirname, &#039;../..&#039;),
	themes_path: path.join(__dirname, &#039;../../node_modules&#039;),
	upload_path: &#039;test/uploads&#039;,
	views_dir: path.join(__dirname, &#039;../../build/public/templates&#039;),
	relative_path: &#039;&#039;,
});

const urlObject = url.parse(nconf.get(&#039;url&#039;));
const relativePath = urlObject.pathname !== &#039;/&#039; ? urlObject.pathname : &#039;&#039;;
nconf.set(&#039;relative_path&#039;, relativePath);
nconf.set(&#039;asset_base_url&#039;, `${relativePath}/assets`);
nconf.set(&#039;upload_path&#039;, path.join(nconf.get(&#039;base_dir&#039;), nconf.get(&#039;upload_path&#039;)));
nconf.set(&#039;upload_url&#039;, &#039;/assets/uploads&#039;);
nconf.set(&#039;url_parsed&#039;, urlObject);
nconf.set(&#039;base_url&#039;, `${urlObject.protocol}//${urlObject.host}`);
nconf.set(&#039;secure&#039;, urlObject.protocol === &#039;https:&#039;);
nconf.set(&#039;use_port&#039;, !!urlObject.port);
nconf.set(&#039;port&#039;, urlObject.port || nconf.get(&#039;port&#039;) || (nconf.get(&#039;PORT_ENV_VAR&#039;) ? nconf.get(nconf.get(&#039;PORT_ENV_VAR&#039;)) : false) || 4567);

// cookies don&#039;t provide isolation by port: http://stackoverflow.com/a/16328399/122353
const domain = nconf.get(&#039;cookieDomain&#039;) || urlObject.hostname;
const origins = nconf.get(&#039;socket.io:origins&#039;) || `${urlObject.protocol}//${domain}:*`;
nconf.set(&#039;socket.io:origins&#039;, origins);

if (nconf.get(&#039;isCluster&#039;) === undefined) {
	nconf.set(&#039;isPrimary&#039;, true);
	nconf.set(&#039;isCluster&#039;, false);
	nconf.set(&#039;singleHostCluster&#039;, false);
}

const dbType = nconf.get(&#039;database&#039;);
const testDbConfig = nconf.get(&#039;test_database&#039;);
const productionDbConfig = nconf.get(dbType);

if (!testDbConfig) {
	const errorText = &#039;test_database is not defined&#039;;
	winston.info(
		&#039;\n===========================================================\n&#039; +
		&#039;Please, add parameters for test database in config.json\n&#039; +
		&#039;For example (redis):\n&#039; +
		&#039;&quot;test_database&quot;: {\n&#039; +
		&#039;    &quot;host&quot;: &quot;127.0.0.1&quot;,\n&#039; +
		&#039;    &quot;port&quot;: &quot;6379&quot;,\n&#039; +
		&#039;    &quot;password&quot;: &quot;&quot;,\n&#039; +
		&#039;    &quot;database&quot;: &quot;1&quot;\n&#039; +
		&#039;}\n&#039; +
		&#039; or (mongo):\n&#039; +
		&#039;&quot;test_database&quot;: {\n&#039; +
		&#039;    &quot;host&quot;: &quot;127.0.0.1&quot;,\n&#039; +
		&#039;    &quot;port&quot;: &quot;27017&quot;,\n&#039; +
		&#039;    &quot;password&quot;: &quot;&quot;,\n&#039; +
		&#039;    &quot;database&quot;: &quot;1&quot;\n&#039; +
		&#039;}\n&#039; +
		&#039; or (mongo) in a replicaset\n&#039; +
		&#039;&quot;test_database&quot;: {\n&#039; +
		&#039;    &quot;host&quot;: &quot;127.0.0.1,127.0.0.1,127.0.0.1&quot;,\n&#039; +
		&#039;    &quot;port&quot;: &quot;27017,27018,27019&quot;,\n&#039; +
		&#039;    &quot;username&quot;: &quot;&quot;,\n&#039; +
		&#039;    &quot;password&quot;: &quot;&quot;,\n&#039; +
		&#039;    &quot;database&quot;: &quot;nodebb_test&quot;\n&#039; +
		&#039;}\n&#039; +
		&#039; or (postgres):\n&#039; +
		&#039;&quot;test_database&quot;: {\n&#039; +
		&#039;    &quot;host&quot;: &quot;127.0.0.1&quot;,\n&#039; +
		&#039;    &quot;port&quot;: &quot;5432&quot;,\n&#039; +
		&#039;    &quot;username&quot;: &quot;postgres&quot;,\n&#039; +
		&#039;    &quot;password&quot;: &quot;&quot;,\n&#039; +
		&#039;    &quot;database&quot;: &quot;nodebb_test&quot;\n&#039; +
		&#039;}\n&#039; +
		&#039;===========================================================&#039;
	);
	winston.error(errorText);
	throw new Error(errorText);
}

if (testDbConfig.database === productionDbConfig.database &amp;&amp;
	testDbConfig.host === productionDbConfig.host &amp;&amp;
	testDbConfig.port === productionDbConfig.port) {
	const errorText = &#039;test_database has the same config as production db&#039;;
	winston.error(errorText);
	throw new Error(errorText);
}

nconf.set(dbType, testDbConfig);

winston.info(&#039;database config %s&#039;, dbType, testDbConfig);
winston.info(`environment ${global.env}`);

const db = require(&#039;../../src/database&#039;);

module.exports = db;

before(async function () {
	this.timeout(30000);

	// Parse out the relative_url and other goodies from the configured URL
	const urlObject = url.parse(nconf.get(&#039;url&#039;));

	nconf.set(&#039;core_templates_path&#039;, path.join(__dirname, &#039;../../src/views&#039;));
	nconf.set(&#039;base_templates_path&#039;, path.join(nconf.get(&#039;themes_path&#039;), &#039;nodebb-theme-persona/templates&#039;));
	nconf.set(&#039;theme_config&#039;, path.join(nconf.get(&#039;themes_path&#039;), &#039;nodebb-theme-persona&#039;, &#039;theme.json&#039;));
	nconf.set(&#039;bcrypt_rounds&#039;, 1);
	nconf.set(&#039;socket.io:origins&#039;, &#039;*:*&#039;);
	nconf.set(&#039;version&#039;, packageInfo.version);
	nconf.set(&#039;runJobs&#039;, false);
	nconf.set(&#039;jobsDisabled&#039;, false);
	nconf.set(&#039;acpPluginInstallDisabled&#039;, false);


	await db.init();
	if (db.hasOwnProperty(&#039;createIndices&#039;)) {
		await db.createIndices();
	}
	await setupMockDefaults();
	await db.initSessionStore();

	const meta = require(&#039;../../src/meta&#039;);
	nconf.set(&#039;theme_templates_path&#039;, meta.config[&#039;theme:templates&#039;] ? path.join(nconf.get(&#039;themes_path&#039;), meta.config[&#039;theme:id&#039;], meta.config[&#039;theme:templates&#039;]) : nconf.get(&#039;base_templates_path&#039;));
	// nconf defaults, if not set in config
	if (!nconf.get(&#039;sessionKey&#039;)) {
		nconf.set(&#039;sessionKey&#039;, &#039;express.sid&#039;);
	}

	await meta.dependencies.check();

	const webserver = require(&#039;../../src/webserver&#039;);
	const sockets = require(&#039;../../src/socket.io&#039;);
	await sockets.init(webserver.server);

	require(&#039;../../src/notifications&#039;).startJobs();
	require(&#039;../../src/user&#039;).startJobs();

	await webserver.listen();

	// Iterate over all of the test suites/contexts
	this.test.parent.suites.forEach((suite) =&gt; {
		// Attach an afterAll listener that resets the defaults
		suite.afterAll(async () =&gt; {
			await setupMockDefaults();
		});
	});
});

async function setupMockDefaults() {
	const meta = require(&#039;../../src/meta&#039;);
	await db.emptydb();

	winston.info(&#039;test_database flushed&#039;);
	await setupDefaultConfigs(meta);

	await meta.configs.init();
	meta.config.postDelay = 0;
	meta.config.initialPostDelay = 0;
	meta.config.newbiePostDelay = 0;
	meta.config.autoDetectLang = 0;

	require(&#039;../../src/groups&#039;).cache.reset();
	require(&#039;../../src/posts/cache&#039;).getOrCreate().reset();
	require(&#039;../../src/cache&#039;).reset();
	require(&#039;../../src/middleware/uploads&#039;).clearCache();
	// privileges must be given after cache reset
	await giveDefaultGlobalPrivileges();
	await enableDefaultPlugins();

	await meta.themes.set({
		type: &#039;local&#039;,
		id: &#039;nodebb-theme-persona&#039;,
	});

	const fs = require(&#039;fs&#039;);
	await fs.promises.rm(&#039;test/uploads&#039;, { recursive: true, force: true });


	const { mkdirp } = require(&#039;mkdirp&#039;);

	const folders = [
		&#039;test/uploads&#039;,
		&#039;test/uploads/category&#039;,
		&#039;test/uploads/files&#039;,
		&#039;test/uploads/system&#039;,
		&#039;test/uploads/profile&#039;,
	];
	for (const folder of folders) {
		/* eslint-disable no-await-in-loop */
		await mkdirp(folder);
	}
}
db.setupMockDefaults = setupMockDefaults;

async function setupDefaultConfigs(meta) {
	winston.info(&#039;Populating database with default configs, if not already set...\n&#039;);

	const defaults = require(path.join(nconf.get(&#039;base_dir&#039;), &#039;install/data/defaults.json&#039;));
	defaults.eventLoopCheckEnabled = 0;
	defaults.minimumPasswordStrength = 0;
	await meta.configs.setOnEmpty(defaults);
}

async function giveDefaultGlobalPrivileges() {
	winston.info(&#039;Giving default global privileges...\n&#039;);
	const privileges = require(&#039;../../src/privileges&#039;);
	await privileges.global.give([
		&#039;groups:chat&#039;, &#039;groups:upload:post:image&#039;, &#039;groups:signature&#039;, &#039;groups:search:content&#039;,
		&#039;groups:search:users&#039;, &#039;groups:search:tags&#039;, &#039;groups:local:login&#039;, &#039;groups:view:users&#039;,
		&#039;groups:view:tags&#039;, &#039;groups:view:groups&#039;,
	], &#039;registered-users&#039;);
	await privileges.global.give([
		&#039;groups:view:users&#039;, &#039;groups:view:tags&#039;, &#039;groups:view:groups&#039;,
	], &#039;guests&#039;);
	await privileges.global.give([&#039;groups:view:users&#039;], &#039;fediverse&#039;);
}

async function enableDefaultPlugins() {
	winston.info(&#039;Enabling default plugins\n&#039;);
	const testPlugins = Array.isArray(nconf.get(&#039;test_plugins&#039;)) ? nconf.get(&#039;test_plugins&#039;) : [];
	const defaultEnabled = [
		&#039;nodebb-plugin-dbsearch&#039;,
		&#039;nodebb-widget-essentials&#039;,
		&#039;nodebb-plugin-composer-default&#039;,
	].concat(testPlugins);

	winston.info(&#039;[install/enableDefaultPlugins] activating default plugins&#039;, defaultEnabled);

	await db.sortedSetAdd(&#039;plugins:active&#039;, Object.keys(defaultEnabled), defaultEnabled);
}
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
