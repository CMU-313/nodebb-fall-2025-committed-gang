<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/revalidator/example/webservice.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/revalidator/example/webservice.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">52.11</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">204</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.40</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.06</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">//
// (C) 2011, Nodejitsu Inc.
// MIT License
//
// A simple web service for storing JSON data via REST
//
// GET - View Object
// POST - Create Object
// PUT - Update Object
// DELETE - Delete Object
//

var revalidator = require(&#039;../&#039;),
  http = require(&#039;http&#039;),
//
// Keep our objects in a simple memory store
//
  memoryStore = {},
//
// Set up our request schema
//
  schema = {
    properties: {
      url: {
        description: &#039;the url the object should be stored at&#039;,
        type: &#039;string&#039;,
        pattern: &#039;^/[^#%&amp;*{}\\:&lt;&gt;?\/+]+$&#039;,
        required: true
      },
      challenge: {
        description: &#039;a means of protecting data (insufficient for production, used as example)&#039;,
        type: &#039;string&#039;,
        minLength: 5
      },
      body: {
        description: &#039;what to store at the url&#039;,
        type: &#039;any&#039;,
        default: null
      }
    }
  }

var server = http.createServer(function validateRestRequest (req, res) {
  req.method = req.method.toUpperCase();

  //
  // Log the requests
  //
  console.log(req.method, req.url);

  //
  // Buffer the request so it can be parsed as JSON
  //
  var requestBody = [];
  req.on(&#039;data&#039;, function addDataToBody (data) {
    requestBody.push(data);
  });

  //
  // Once the request has ended work with the body
  //
  req.on(&#039;end&#039;, function dealWithRest () {

    //
    // Parse the JSON
    //
    requestBody = requestBody.join(&#039;&#039;);
    if ({POST: 1, PUT: 1}[req.method]) {
      try {
        requestBody = JSON.parse(requestBody);
      }
      catch (e) {
        res.writeHead(400);
        res.end(e);
        return;
      }
    }
    else {
      requestBody = {};
    }

    //
    // If this was sent to a url but the body url was not declared
    // Make sure the body get the requested url so that our schema
    //  validates before we work on it
    //
    if (!requestBody.url) {
      requestBody.url = req.url;
    }

    //
    // Don&#039;t let users override the main API endpoint
    //
    if (requestBody.url === &#039;/&#039;) {
      res.writeHead(400);
      res.end(&#039;Cannot override the API endpoint &quot;/&quot;&#039;);
      return;
    }

    //
    // See if our request and target are out of sync
    // This lets us double check the url we are about to take up
    //  if we choose to send the request to the url directly
    //
    if (req.url !== &#039;/&#039; &amp;&amp; requestBody.url !== req.url) {
      res.writeHead(400);
      res.end(&#039;Requested url and actual url do not match&#039;);
      return;
    }

    //
    // Validate the schema
    //
    var validation = revalidator.validate(requestBody, schema);
    if (!validation.valid) {
      res.writeHead(400);
      res.end(validation.errors.join(&#039;\n&#039;));
      return;
    }

    //
    // Grab the current value from storage and
    //  check if it is a valid state for REST
    //
    var storedValue = memoryStore[requestBody.url];
    if (req.method === &#039;POST&#039;) {
      if (storedValue) {
        res.writeHead(400);
        res.end(&#039;ALREADY EXISTS&#039;);
        return;
      }
    }
    else if (!storedValue) {
      res.writeHead(404);
      res.end(&#039;DOES NOT EXIST&#039;);
      return;
    }

    //
    // Check our challenge
    //
    if (storedValue &amp;&amp; requestBody.challenge != storedValue.challenge) {
      res.writeHead(403);
      res.end(&#039;NOT AUTHORIZED&#039;);
      return;
    }

    //
    // Since revalidator only checks and does not manipulate
    //  our object we need to set up the defaults our selves
    // For an easier solution to this please look at Flatiron&#039;s
    //  `Resourceful` project
    //
    if (requestBody.body === undefined) {
      requestBody.body = schema.properties.body.default;
    }

    //
    // Use REST to determine how to manipulate the stored
    //  values
    //
    switch (req.method) {

      case &quot;GET&quot;:
        res.writeHead(200);
        var result = storedValue.body;
        res.end(JSON.stringify(result));
        return;

      case &quot;POST&quot;:
        res.writeHead(201);
        res.end();
        memoryStore[requestBody.url] = requestBody;
        return;

      case &quot;DELETE&quot;:
        delete memoryStore[requestBody.url];
        res.writeHead(200);
        res.end();
        return;

      case &quot;PUT&quot;:
        memoryStore[requestBody.url] = requestBody;
        res.writeHead(200);
        res.end();
        return;

      default:
        res.writeHead(400);
        res.end(&#039;Invalid Http Verb&#039;);
        return;
    }
  });
})
//
// Listen to various ports depending on environment we are being run on
//
server.listen(process.env.PORT || process.env.C9_PORT || 1337, function reportListening () {

  console.log(&#039;JSON REST Service listening on port&#039;, this.address().port);
  console.log(&#039;Requests can be sent via REST to &quot;/&quot; if they conform to the following schema:&#039;);
  console.log(JSON.stringify(schema, null, &#039; &#039;));

});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
