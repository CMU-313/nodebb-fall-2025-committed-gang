<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/tiny-lr/lib/server.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/tiny-lr/lib/server.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">67.51</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">323</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">56.29</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.48</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">import fs      from &#039;fs&#039;;
import http    from &#039;http&#039;;
import https   from &#039;https&#039;;
import events  from &#039;events&#039;;
import {parse} from &#039;url&#039;;
import Client  from &#039;./client&#039;;
import config  from &#039;../package.json&#039;;
import anybody from &#039;body/any&#039;;
import qs      from &#039;qs&#039;;

const debug = require(&#039;debug&#039;)(&#039;tinylr:server&#039;);

const CONTENT_TYPE = &#039;content-type&#039;;
const FORM_TYPE = &#039;application/x-www-form-urlencoded&#039;;

function buildRootPath (prefix = &#039;/&#039;) {
  let rootUrl = prefix;

  // Add trailing slash
  if (prefix[prefix.length - 1] !== &#039;/&#039;) {
    rootUrl = `${rootUrl}/`;
  }

  // Add leading slash
  if (prefix[0] !== &#039;/&#039;) {
    rootUrl = `/${rootUrl}`;
  }

  return rootUrl;
}

class Server extends events.EventEmitter {
  constructor (options = {}) {
    super();

    this.options = options;

    options.livereload = options.livereload || require.resolve(&#039;livereload-js/dist/livereload.js&#039;);

    // todo: change falsy check to allow 0 for random port
    options.port = parseInt(options.port || 35729, 10);

    if (options.errorListener) {
      this.errorListener = options.errorListener;
    }

    this.rootPath = buildRootPath(options.prefix);

    this.clients = {};
    this.configure(options.app);
    this.routes(options.app);
  }

  routes () {
    if (!this.options.dashboard) {
      this.on(`GET ${this.rootPath}`, this.index.bind(this));
    }

    this.on(`GET ${this.rootPath}changed`, this.changed.bind(this));
    this.on(`POST ${this.rootPath}changed`, this.changed.bind(this));
    this.on(`POST ${this.rootPath}alert`, this.alert.bind(this));
    this.on(`GET ${this.rootPath}livereload.js`, this.livereload.bind(this));
    this.on(`GET ${this.rootPath}kill`, this.close.bind(this));
  }

  configure (app) {
    debug(&#039;Configuring %s&#039;, app ? &#039;connect / express application&#039; : &#039;HTTP server&#039;);

    let handler = this.options.handler || this.handler;

    if (!app) {
      if ((this.options.key &amp;&amp; this.options.cert) || this.options.pfx) {
        this.server = https.createServer(this.options, handler.bind(this));
      } else {
        this.server = http.createServer(handler.bind(this));
      }

      this.server.on(&#039;upgrade&#039;, this.websocketify.bind(this));
      this.server.on(&#039;error&#039;, this.error.bind(this));
      return this;
    }

    this.app = app;
    this.app.listen = (port, done) =&gt; {
      done = done || function () {};
      if (port !== this.options.port) {
        debug(&#039;Warn: LiveReload port is not standard (%d). You are listening on %d&#039;, this.options.port, port);
        debug(&#039;You\&#039;ll need to rely on the LiveReload snippet&#039;);
        debug(&#039;&gt; http://feedback.livereload.com/knowledgebase/articles/86180-how-do-i-add-the-script-tag-manually-&#039;);
      }

      let srv = this.server = http.createServer(app);
      srv.on(&#039;upgrade&#039;, this.websocketify.bind(this));
      srv.on(&#039;error&#039;, this.error.bind(this));
      srv.on(&#039;close&#039;, this.close.bind(this));
      return srv.listen(port, done);
    };

    return this;
  }

  handler (req, res, next) {
    let middleware = typeof next === &#039;function&#039;;
    debug(&#039;LiveReload handler %s (middleware: %s)&#039;, req.url, middleware ? &#039;on&#039; : &#039;off&#039;);

    next = next || this.defaultHandler.bind(this, res);
    req.headers[CONTENT_TYPE] = req.headers[CONTENT_TYPE] || FORM_TYPE;
    return anybody(req, res, (err, body) =&gt; {
      if (err) return next(err);
      req.body = body;

      if (!req.query) {
        req.query = req.url.indexOf(&#039;?&#039;) !== -1
          ? qs.parse(parse(req.url).query)
          : {};
      }

      return this.handle(req, res, next);
    });
  }

  index (req, res) {
    res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
    res.write(JSON.stringify({
      tinylr: &#039;Welcome&#039;,
      version: config.version
    }));

    res.end();
  }

  handle (req, res, next) {
    let url = parse(req.url);
    debug(&#039;Request:&#039;, req.method, url.href);
    let middleware = typeof next === &#039;function&#039;;

    // do the routing
    let route = req.method + &#039; &#039; + url.pathname;
    let respond = this.emit(route, req, res);
    if (respond) return;

    if (middleware) return next();

    // Only apply content-type on non middleware setup #70
    return this.notFound(res);
  }

  defaultHandler (res, err) {
    if (!err) return this.notFound(res);

    this.error(err);
    res.setHeader(&#039;Content-Type&#039;, &#039;text/plain&#039;);
    res.statusCode = 500;
    res.end(&#039;Error: &#039; + err.stack);
  }

  notFound (res) {
    res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
    res.writeHead(404);
    res.write(JSON.stringify({
      error: &#039;not_found&#039;,
      reason: &#039;no such route&#039;
    }));
    res.end();
  }

  websocketify (req, socket, head) {
    let client = new Client(req, socket, head, this.options);
    this.clients[client.id] = client;

    // handle socket error to prevent possible app crash, such as ECONNRESET
    socket.on(&#039;error&#039;, (e) =&gt; {
      // ignore frequent ECONNRESET error (seems inevitable when refresh)
      if (e.code === &#039;ECONNRESET&#039;) return;
      this.error(e);
    });

    client.once(&#039;info&#039;, (data) =&gt; {
      debug(&#039;Create client %s (url: %s)&#039;, data.id, data.url);
      this.emit(&#039;MSG /create&#039;, data.id, data.url);
    });

    client.once(&#039;end&#039;, () =&gt; {
      debug(&#039;Destroy client %s (url: %s)&#039;, client.id, client.url);
      this.emit(&#039;MSG /destroy&#039;, client.id, client.url);
      delete this.clients[client.id];
    });
  }

  listen (port, host, fn) {
    port = port || this.options.port;

    // Last used port for error display
    this.port = port;

    if (typeof host === &#039;function&#039;) {
      fn = host;
      host = undefined;
    }

    this.server.listen(port, host, fn);
  }

  close (req, res) {
    Object.keys(this.clients).forEach(function (id) {
      this.clients[id].close();
    }, this);

    if (this.server._handle) this.server.close(this.emit.bind(this, &#039;close&#039;));

    if (res) res.end();
  }

  error (e) {
    if (this.errorListener) {
      this.errorListener(e);
      return;
    }

    console.error();
    if (typeof e === &#039;undefined&#039;) {
      console.error(&#039;... Uhoh. Got error %s ...&#039;, e);
    } else {
      console.error(&#039;... Uhoh. Got error %s ...&#039;, e.message);
      console.error(e.stack);

      if (e.code !== &#039;EADDRINUSE&#039;) return;
      console.error();
      console.error(&#039;You already have a server listening on %s&#039;, this.port);
      console.error(&#039;You should stop it and try again.&#039;);
      console.error();
    }
  }

  // Routes

  livereload (req, res) {
    res.setHeader(&#039;Content-Type&#039;, &#039;application/javascript&#039;);
    fs.createReadStream(this.options.livereload).pipe(res);
  }

  changed (req, res) {
    let files = this.param(&#039;files&#039;, req);

    debug(&#039;Changed event (Files: %s)&#039;, files.join(&#039; &#039;));
    let clients = this.notifyClients(files);

    if (!res) return;

    res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
    res.write(JSON.stringify({
      clients: clients,
      files: files
    }));

    res.end();
  }

  alert (req, res) {
    let message = this.param(&#039;message&#039;, req);

    debug(&#039;Alert event (Message: %s)&#039;, message);
    let clients = this.alertClients(message);

    if (!res) return;

    res.setHeader(&#039;Content-Type&#039;, &#039;application/json&#039;);
    res.write(JSON.stringify({
      clients: clients,
      message: message
    }));

    res.end();
  }

  notifyClients (files) {
    let clients = Object.keys(this.clients).map(function (id) {
      let client = this.clients[id];
      debug(&#039;Reloading client %s (url: %s)&#039;, client.id, client.url);
      client.reload(files);
      return {
        id: client.id,
        url: client.url
      };
    }, this);

    return clients;
  };

  alertClients (message) {
    let clients = Object.keys(this.clients).map(function (id) {
      let client = this.clients[id];
      debug(&#039;Alert client %s (url: %s)&#039;, client.id, client.url);
      client.alert(message);
      return {
        id: client.id,
        url: client.url
      };
    }, this);

    return clients;
  }

  // Lookup param from body / params / query.
  param (name, req) {
    let param;
    if (req.body &amp;&amp; req.body[name]) param = req.body[name];
    else if (req.params &amp;&amp; req.params[name]) param = req.params[name];
    else if (req.query &amp;&amp; req.query[name]) param = req.query[name];

    // normalize files array
    if (name === &#039;files&#039;) {
      param = Array.isArray(param) ? param
        : typeof param === &#039;string&#039; ? param.split(/[\s,]/)
        : [];
    }

    return param;
  }
}

export default Server;
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
