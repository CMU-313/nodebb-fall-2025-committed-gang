<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/websocket-driver/lib/websocket/driver/client.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/websocket-driver/lib/websocket/driver/client.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">60.97</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">143</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.19</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.71</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

var Buffer     = require(&#039;safe-buffer&#039;).Buffer,
    crypto     = require(&#039;crypto&#039;),
    url        = require(&#039;url&#039;),
    util       = require(&#039;util&#039;),
    HttpParser = require(&#039;../http_parser&#039;),
    Base       = require(&#039;./base&#039;),
    Hybi       = require(&#039;./hybi&#039;),
    Proxy      = require(&#039;./proxy&#039;);

var Client = function(_url, options) {
  this.version = &#039;hybi-&#039; + Hybi.VERSION;
  Hybi.call(this, null, _url, options);

  this.readyState = -1;
  this._key       = Client.generateKey();
  this._accept    = Hybi.generateAccept(this._key);
  this._http      = new HttpParser(&#039;response&#039;);

  var uri  = url.parse(this.url),
      auth = uri.auth &amp;&amp; Buffer.from(uri.auth, &#039;utf8&#039;).toString(&#039;base64&#039;);

  if (this.VALID_PROTOCOLS.indexOf(uri.protocol) &lt; 0)
    throw new Error(this.url + &#039; is not a valid WebSocket URL&#039;);

  this._pathname = (uri.pathname || &#039;/&#039;) + (uri.search || &#039;&#039;);

  this._headers.set(&#039;Host&#039;, uri.host);
  this._headers.set(&#039;Upgrade&#039;, &#039;websocket&#039;);
  this._headers.set(&#039;Connection&#039;, &#039;Upgrade&#039;);
  this._headers.set(&#039;Sec-WebSocket-Key&#039;, this._key);
  this._headers.set(&#039;Sec-WebSocket-Version&#039;, Hybi.VERSION);

  if (this._protocols.length &gt; 0)
    this._headers.set(&#039;Sec-WebSocket-Protocol&#039;, this._protocols.join(&#039;, &#039;));

  if (auth)
    this._headers.set(&#039;Authorization&#039;, &#039;Basic &#039; + auth);
};
util.inherits(Client, Hybi);

Client.generateKey = function() {
  return crypto.randomBytes(16).toString(&#039;base64&#039;);
};

var instance = {
  VALID_PROTOCOLS: [&#039;ws:&#039;, &#039;wss:&#039;],

  proxy: function(origin, options) {
    return new Proxy(this, origin, options);
  },

  start: function() {
    if (this.readyState !== -1) return false;
    this._write(this._handshakeRequest());
    this.readyState = 0;
    return true;
  },

  parse: function(chunk) {
    if (this.readyState === 3) return;
    if (this.readyState &gt; 0) return Hybi.prototype.parse.call(this, chunk);

    this._http.parse(chunk);
    if (!this._http.isComplete()) return;

    this._validateHandshake();
    if (this.readyState === 3) return;

    this._open();
    this.parse(this._http.body);
  },

  _handshakeRequest: function() {
    var extensions = this._extensions.generateOffer();
    if (extensions)
      this._headers.set(&#039;Sec-WebSocket-Extensions&#039;, extensions);

    var start   = &#039;GET &#039; + this._pathname + &#039; HTTP/1.1&#039;,
        headers = [start, this._headers.toString(), &#039;&#039;];

    return Buffer.from(headers.join(&#039;\r\n&#039;), &#039;utf8&#039;);
  },

  _failHandshake: function(message) {
    message = &#039;Error during WebSocket handshake: &#039; + message;
    this.readyState = 3;
    this.emit(&#039;error&#039;, new Error(message));
    this.emit(&#039;close&#039;, new Base.CloseEvent(this.ERRORS.protocol_error, message));
  },

  _validateHandshake: function() {
    this.statusCode = this._http.statusCode;
    this.headers    = this._http.headers;

    if (this._http.error)
      return this._failHandshake(this._http.error.message);

    if (this._http.statusCode !== 101)
      return this._failHandshake(&#039;Unexpected response code: &#039; + this._http.statusCode);

    var headers    = this._http.headers,
        upgrade    = headers[&#039;upgrade&#039;] || &#039;&#039;,
        connection = headers[&#039;connection&#039;] || &#039;&#039;,
        accept     = headers[&#039;sec-websocket-accept&#039;] || &#039;&#039;,
        protocol   = headers[&#039;sec-websocket-protocol&#039;] || &#039;&#039;;

    if (upgrade === &#039;&#039;)
      return this._failHandshake(&quot;&#039;Upgrade&#039; header is missing&quot;);
    if (upgrade.toLowerCase() !== &#039;websocket&#039;)
      return this._failHandshake(&quot;&#039;Upgrade&#039; header value is not &#039;WebSocket&#039;&quot;);

    if (connection === &#039;&#039;)
      return this._failHandshake(&quot;&#039;Connection&#039; header is missing&quot;);
    if (connection.toLowerCase() !== &#039;upgrade&#039;)
      return this._failHandshake(&quot;&#039;Connection&#039; header value is not &#039;Upgrade&#039;&quot;);

    if (accept !== this._accept)
      return this._failHandshake(&#039;Sec-WebSocket-Accept mismatch&#039;);

    this.protocol = null;

    if (protocol !== &#039;&#039;) {
      if (this._protocols.indexOf(protocol) &lt; 0)
        return this._failHandshake(&#039;Sec-WebSocket-Protocol mismatch&#039;);
      else
        this.protocol = protocol;
    }

    try {
      this._extensions.activate(this.headers[&#039;sec-websocket-extensions&#039;]);
    } catch (e) {
      return this._failHandshake(e.message);
    }
  }
};

for (var key in instance)
  Client.prototype[key] = instance[key];

module.exports = Client;
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
