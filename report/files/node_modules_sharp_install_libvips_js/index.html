<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/sharp/install/libvips.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/sharp/install/libvips.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">70.25</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">223</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">27.36</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.41</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Copyright 2013 Lovell Fuller and others.
// SPDX-License-Identifier: Apache-2.0

&#039;use strict&#039;;

const fs = require(&#039;fs&#039;);
const os = require(&#039;os&#039;);
const path = require(&#039;path&#039;);
const stream = require(&#039;stream&#039;);
const zlib = require(&#039;zlib&#039;);
const { createHash } = require(&#039;crypto&#039;);

const detectLibc = require(&#039;detect-libc&#039;);
const semverCoerce = require(&#039;semver/functions/coerce&#039;);
const semverLessThan = require(&#039;semver/functions/lt&#039;);
const semverSatisfies = require(&#039;semver/functions/satisfies&#039;);
const simpleGet = require(&#039;simple-get&#039;);
const tarFs = require(&#039;tar-fs&#039;);

const agent = require(&#039;../lib/agent&#039;);
const libvips = require(&#039;../lib/libvips&#039;);
const platform = require(&#039;../lib/platform&#039;);

const minimumGlibcVersionByArch = {
  arm: &#039;2.28&#039;,
  arm64: &#039;2.17&#039;,
  x64: &#039;2.17&#039;
};

const hasSharpPrebuild = [
  &#039;darwin-x64&#039;,
  &#039;darwin-arm64&#039;,
  &#039;linux-arm64&#039;,
  &#039;linux-x64&#039;,
  &#039;linuxmusl-x64&#039;,
  &#039;linuxmusl-arm64&#039;,
  &#039;win32-ia32&#039;,
  &#039;win32-x64&#039;
];

const { minimumLibvipsVersion, minimumLibvipsVersionLabelled } = libvips;
const localLibvipsDir = process.env.npm_config_sharp_libvips_local_prebuilds || &#039;&#039;;
const distHost = process.env.npm_config_sharp_libvips_binary_host || &#039;https://github.com/lovell/sharp-libvips/releases/download&#039;;
const distBaseUrl = process.env.npm_config_sharp_dist_base_url || process.env.SHARP_DIST_BASE_URL || `${distHost}/v${minimumLibvipsVersionLabelled}/`;
const installationForced = !!(process.env.npm_config_sharp_install_force || process.env.SHARP_INSTALL_FORCE);

const fail = function (err) {
  libvips.log(err);
  if (err.code === &#039;EACCES&#039;) {
    libvips.log(&#039;Are you trying to install as a root or sudo user?&#039;);
    libvips.log(&#039;- For npm &lt;= v6, try again with the &quot;--unsafe-perm&quot; flag&#039;);
    libvips.log(&#039;- For npm &gt;= v8, the user must own the directory &quot;npm install&quot; is run in&#039;);
  }
  libvips.log(&#039;Please see https://sharp.pixelplumbing.com/install for required dependencies&#039;);
  process.exit(1);
};

const handleError = function (err) {
  if (installationForced) {
    libvips.log(`Installation warning: ${err.message}`);
  } else {
    throw err;
  }
};

const verifyIntegrity = function (platformAndArch) {
  const expected = libvips.integrity(platformAndArch);
  if (installationForced || !expected) {
    libvips.log(`Integrity check skipped for ${platformAndArch}`);
    return new stream.PassThrough();
  }
  const hash = createHash(&#039;sha512&#039;);
  return new stream.Transform({
    transform: function (chunk, _encoding, done) {
      hash.update(chunk);
      done(null, chunk);
    },
    flush: function (done) {
      const digest = `sha512-${hash.digest(&#039;base64&#039;)}`;
      if (expected !== digest) {
        try {
          libvips.removeVendoredLibvips();
        } catch (err) {
          libvips.log(err.message);
        }
        libvips.log(`Integrity expected: ${expected}`);
        libvips.log(`Integrity received: ${digest}`);
        done(new Error(`Integrity check failed for ${platformAndArch}`));
      } else {
        libvips.log(`Integrity check passed for ${platformAndArch}`);
        done();
      }
    }
  });
};

const extractTarball = function (tarPath, platformAndArch) {
  const versionedVendorPath = path.join(__dirname, &#039;..&#039;, &#039;vendor&#039;, minimumLibvipsVersion, platformAndArch);
  libvips.mkdirSync(versionedVendorPath);

  const ignoreVendorInclude = hasSharpPrebuild.includes(platformAndArch) &amp;&amp; !process.env.npm_config_build_from_source;
  const ignore = function (name) {
    return ignoreVendorInclude &amp;&amp; name.includes(&#039;include/&#039;);
  };

  stream.pipeline(
    fs.createReadStream(tarPath),
    verifyIntegrity(platformAndArch),
    new zlib.BrotliDecompress(),
    tarFs.extract(versionedVendorPath, { ignore }),
    function (err) {
      if (err) {
        if (/unexpected end of file/.test(err.message)) {
          fail(new Error(`Please delete ${tarPath} as it is not a valid tarball`));
        }
        fail(err);
      }
    }
  );
};

try {
  const useGlobalLibvips = libvips.useGlobalLibvips();

  if (useGlobalLibvips) {
    const globalLibvipsVersion = libvips.globalLibvipsVersion();
    libvips.log(`Detected globally-installed libvips v${globalLibvipsVersion}`);
    libvips.log(&#039;Building from source via node-gyp&#039;);
    process.exit(1);
  } else if (libvips.hasVendoredLibvips()) {
    libvips.log(`Using existing vendored libvips v${minimumLibvipsVersion}`);
  } else {
    // Is this arch/platform supported?
    const arch = process.env.npm_config_arch || process.arch;
    const platformAndArch = platform();
    if (arch === &#039;ia32&#039; &amp;&amp; !platformAndArch.startsWith(&#039;win32&#039;)) {
      throw new Error(`Intel Architecture 32-bit systems require manual installation of libvips &gt;= ${minimumLibvipsVersion}`);
    }
    if (platformAndArch === &#039;freebsd-x64&#039; || platformAndArch === &#039;openbsd-x64&#039; || platformAndArch === &#039;sunos-x64&#039;) {
      throw new Error(`BSD/SunOS systems require manual installation of libvips &gt;= ${minimumLibvipsVersion}`);
    }
    // Linux libc version check
    const libcVersionRaw = detectLibc.versionSync();
    if (libcVersionRaw) {
      const libcFamily = detectLibc.familySync();
      const libcVersion = semverCoerce(libcVersionRaw).version;
      if (libcFamily === detectLibc.GLIBC &amp;&amp; minimumGlibcVersionByArch[arch]) {
        if (semverLessThan(libcVersion, semverCoerce(minimumGlibcVersionByArch[arch]).version)) {
          handleError(new Error(`Use with glibc ${libcVersionRaw} requires manual installation of libvips &gt;= ${minimumLibvipsVersion}`));
        }
      }
      if (libcFamily === detectLibc.MUSL) {
        if (semverLessThan(libcVersion, &#039;1.1.24&#039;)) {
          handleError(new Error(`Use with musl ${libcVersionRaw} requires manual installation of libvips &gt;= ${minimumLibvipsVersion}`));
        }
      }
    }
    // Node.js minimum version check
    const supportedNodeVersion = process.env.npm_package_engines_node || require(&#039;../package.json&#039;).engines.node;
    if (!semverSatisfies(process.versions.node, supportedNodeVersion)) {
      handleError(new Error(`Expected Node.js version ${supportedNodeVersion} but found ${process.versions.node}`));
    }
    // Download to per-process temporary file
    const tarFilename = [&#039;libvips&#039;, minimumLibvipsVersionLabelled, platformAndArch].join(&#039;-&#039;) + &#039;.tar.br&#039;;
    const tarPathCache = path.join(libvips.cachePath(), tarFilename);
    if (fs.existsSync(tarPathCache)) {
      libvips.log(`Using cached ${tarPathCache}`);
      extractTarball(tarPathCache, platformAndArch);
    } else if (localLibvipsDir) {
      // If localLibvipsDir is given try to use binaries from local directory
      const tarPathLocal = path.join(path.resolve(localLibvipsDir), `v${minimumLibvipsVersionLabelled}`, tarFilename);
      libvips.log(`Using local libvips from ${tarPathLocal}`);
      extractTarball(tarPathLocal, platformAndArch);
    } else {
      const url = distBaseUrl + tarFilename;
      libvips.log(`Downloading ${url}`);
      simpleGet({ url: url, agent: agent(libvips.log) }, function (err, response) {
        if (err) {
          fail(err);
        } else if (response.statusCode === 404) {
          fail(new Error(`Prebuilt libvips ${minimumLibvipsVersion} binaries are not yet available for ${platformAndArch}`));
        } else if (response.statusCode !== 200) {
          fail(new Error(`Status ${response.statusCode} ${response.statusMessage}`));
        } else {
          const tarPathTemp = path.join(os.tmpdir(), `${process.pid}-${tarFilename}`);
          const tmpFileStream = fs.createWriteStream(tarPathTemp);
          response
            .on(&#039;error&#039;, function (err) {
              tmpFileStream.destroy(err);
            })
            .on(&#039;close&#039;, function () {
              if (!response.complete) {
                tmpFileStream.destroy(new Error(&#039;Download incomplete (connection was terminated)&#039;));
              }
            })
            .pipe(tmpFileStream);
          tmpFileStream
            .on(&#039;error&#039;, function (err) {
              // Clean up temporary file
              try {
                fs.unlinkSync(tarPathTemp);
              } catch (e) {}
              fail(err);
            })
            .on(&#039;close&#039;, function () {
              try {
                // Attempt to rename
                fs.renameSync(tarPathTemp, tarPathCache);
              } catch (err) {
                // Fall back to copy and unlink
                fs.copyFileSync(tarPathTemp, tarPathCache);
                fs.unlinkSync(tarPathTemp);
              }
              extractTarball(tarPathCache, platformAndArch);
            });
        }
      });
    }
  }
} catch (err) {
  fail(err);
}
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
