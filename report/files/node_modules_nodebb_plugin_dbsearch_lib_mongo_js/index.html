<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/nodebb-plugin-dbsearch/lib/mongo.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/nodebb-plugin-dbsearch/lib/mongo.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">61.28</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">229</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">61.63</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.87</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

const nconf = require.main.require(&#039;nconf&#039;);

const db = require.main.require(&#039;./src/database&#039;);

function generateIndexName(indexSpec) {
	return Object.entries(indexSpec)
		.map(([key, value]) =&gt; `${key}_${value}`)
		.join(&#039;_&#039;);
}

async function safeCreateIndex(collection, indexSpec, options) {
	try {
		await db.client.collection(collection).createIndex(indexSpec, options);
	} catch (err) {
		if (err.code === 85) { // index options conflict, retry by dropping the index
			await safeDropIndex(collection, generateIndexName(indexSpec));
			await safeCreateIndex(collection, indexSpec, options);
			return;
		}
		throw err;
	}
}

async function safeDropIndex(collection, indexName) {
	try {
		await db.client.collection(collection).dropIndex(indexName);
	} catch (err) {
		// Ignore &quot;index not found (27)&quot; error
		if (err.code !== 27) {
			throw err;
		}
	}
};

exports.createIndices = async function (language) {
	const options = { background: true };
	if (language &amp;&amp; language !== &#039;en&#039;) {
		options.default_language = language;
	}

	if (nconf.get(&#039;isPrimary&#039;) &amp;&amp; !nconf.get(&#039;jobsDisabled&#039;)) {
		await safeCreateIndex(&#039;searchtopic&#039;, { content: &#039;text&#039;, uid: 1, cid: 1 }, options);
		await safeCreateIndex(&#039;searchtopic&#039;, { ts: 1 }, { background: true });

		await safeCreateIndex(&#039;searchpost&#039;, { content: &#039;text&#039;, uid: 1, cid: 1 }, options);
		await safeCreateIndex(&#039;searchpost&#039;, { ts: 1 }, { background: true });

		await safeCreateIndex(&#039;searchchat&#039;, { content: &#039;text&#039;, roomId: 1, uid: 1 }, options);
	}
};

exports.changeIndexLanguage = async function (language) {
	const indexSpec = { content: &#039;text&#039;, uid: 1, cid: 1 };
	const options = { background: true };
	if (language !== &#039;en&#039;) {
		options.default_language = language;
	}

	await safeDropIndex(&#039;searchtopic&#039;, &#039;content_text_uid_1_cid_1&#039;);
	await db.client.collection(&#039;searchtopic&#039;).createIndex(indexSpec, options);

	await safeDropIndex(&#039;searchpost&#039;, &#039;content_text_uid_1_cid_1&#039;);
	await db.client.collection(&#039;searchpost&#039;).createIndex(indexSpec, options);

	await safeDropIndex(&#039;searchchat&#039;, &#039;content_text_roomId_1_uid_1&#039;);
	await db.client.collection(&#039;searchchat&#039;).createIndex({ content: &#039;text&#039;, roomId: 1, uid: 1 }, options);
};

exports.searchIndex = async function (key, data, ids) {
	if (!ids.length) {
		return;
	}

	const bulk = db.client.collection(`search${key}`).initializeUnorderedBulkOp();
	ids.forEach((id, index) =&gt; {
		const setData = {};
		Object.keys(data[index]).forEach((field) =&gt; {
			if (data[index].hasOwnProperty(field) &amp;&amp; data[index][field]) {
				if (field === &#039;timestamp&#039;) {
					setData.ts = parseInt(data[index][field], 10);
				} else {
					setData[field] = data[index][field].toString();
				}
			}
		});

		bulk.find({ _id: String(id) }).upsert().updateOne({ $set: setData });
	});

	await bulk.execute();
};

exports.search = async function (key, data, limit) {
	const searchQuery = {};
	if (data.content) {
		searchQuery.$text = buildTextQuery(data.content, data.matchWords);
	}

	if (Array.isArray(data.cid) &amp;&amp; data.cid.length) {
		if (data.cid.length &gt; 1) {
			searchQuery.cid = { $in: data.cid.map(String) };
		} else {
			searchQuery.cid = String(data.cid[0]);
		}
	}

	if (Array.isArray(data.uid) &amp;&amp; data.uid.length) {
		if (data.uid.length &gt; 1) {
			searchQuery.uid = { $in: data.uid.map(String) };
		} else {
			searchQuery.uid = String(data.uid[0]);
		}
	}

	if (data.searchData.timeFilter &amp;&amp; data.searchData.timeRange) {
		const timeRange = parseInt(data.searchData.timeRange, 10) * 1000;
		if (timeRange) {
			const ts = Date.now() - timeRange;
			searchQuery.ts = data.searchData.timeFilter === &#039;newer&#039; ?
				{ $gte: ts } :
				{ $lte: ts };
		}
	}

	const aggregate = [{ $match: searchQuery }];
	if (searchQuery.$text) {
		const sortQuery = { score: { $meta: &#039;textScore&#039; } };
		if (data.searchData.sortBy === &#039;timestamp&#039; || data.searchData.sortBy === &#039;topic.timestamp&#039;) {
			sortQuery.ts = data.searchData.sortDirection === &#039;asc&#039; ? 1 : -1;
		}
		aggregate.push({ $sort: sortQuery });
	} else {
		aggregate.push({ $sort: { ts: data.searchData.sortDirection === &#039;asc&#039; ? 1 : -1 } });
	}
	aggregate.push({ $limit: parseInt(limit, 10) });
	aggregate.push({ $project: { _id: 1 } });

	const results = await db.client.collection(`search${key}`).aggregate(aggregate).toArray();
	if (!results || !results.length) {
		return [];
	}
	return results.map(item =&gt; item._id);
};

exports.searchRemove = async function (key, ids) {
	if (!key || !ids.length) {
		return;
	}

	await db.client.collection(`search${key}`).deleteMany({ _id: { $in: ids.map(String) } });
};

exports.chat = {};
exports.chat.index = async (data, ids) =&gt; {
	if (!ids.length) {
		return;
	}

	const bulk = db.client.collection(`searchchat`).initializeUnorderedBulkOp();
	ids.forEach((id, index) =&gt; {
		const d = data[index];
		if (d &amp;&amp; d.content &amp;&amp; d.uid &amp;&amp; d.roomId) {
			bulk.find({ _id: String(id) }).upsert().updateOne({
				$set: {
					content: String(d.content),
					roomId: String(d.roomId),
					uid: String(d.uid),
				},
			});
		}
	});

	await bulk.execute();
};

exports.chat.search = async (data, limit) =&gt; {
	const searchQuery = {};
	if (!data.content) {
		return [];
	}
	searchQuery.$text = buildTextQuery(data.content, data.matchWords);

	if (Array.isArray(data.roomId) &amp;&amp; data.roomId.filter(Boolean).length) {
		if (data.roomId.length &gt; 1) {
			searchQuery.roomId = { $in: data.roomId.filter(Boolean).map(String) };
		} else {
			searchQuery.roomId = String(data.roomId[0]);
		}
	}

	if (Array.isArray(data.uid) &amp;&amp; data.uid.filter(Boolean).length) {
		if (data.uid.length &gt; 1) {
			searchQuery.uid = { $in: data.uid.filter(Boolean).map(String) };
		} else {
			searchQuery.uid = String(data.uid[0]);
		}
	}

	const collection = db.client.collection(`searchchat`);
	const results = await collection.aggregate([
		{ $match: searchQuery },
		{ $sort: { score: { $meta: &#039;textScore&#039; } } },
		{ $limit: parseInt(limit, 10) },
		{ $project: { _id: 1 } },
	]).toArray();
	if (!results || !results.length) {
		return [];
	}
	return results.map(item =&gt; item._id);
};

function buildTextQuery(content, matchWords) {
	let words = content.split(&#039; &#039;);
	const allQuoted = content.startsWith(&#039;&quot;&#039;) &amp;&amp; content.endsWith(&#039;&quot;&#039;);
	if (matchWords === &#039;all&#039; &amp;&amp; !allQuoted) {
		words = words.map((word) =&gt; {
			if (!word.startsWith(&#039;&quot;&#039;) &amp;&amp; !word.endsWith(&#039;&quot;&#039;)) {
				return `&quot;${word}&quot;`;
			}
			return word;
		});
	}

	return { $search: words.join(&#039; &#039;) };
}

</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
