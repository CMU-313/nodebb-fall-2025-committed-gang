<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/prebuild-install/node_modules/tar-fs/test/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/prebuild-install/node_modules/tar-fs/test/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">69.94</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">347</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">55.76</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">4.62</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var test = require(&#039;tape&#039;)
var rimraf = require(&#039;rimraf&#039;)
var tar = require(&#039;../index&#039;)
var tarStream = require(&#039;tar-stream&#039;)
var path = require(&#039;path&#039;)
var fs = require(&#039;fs&#039;)
var os = require(&#039;os&#039;)

var win32 = os.platform() === &#039;win32&#039;

var mtime = function (st) {
  return Math.floor(st.mtime.getTime() / 1000)
}

test(&#039;copy a -&gt; copy/a&#039;, function (t) {
  t.plan(5)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;a&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;a&#039;)

  rimraf.sync(b)
  tar.pack(a)
    .pipe(tar.extract(b))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b)
      t.same(files.length, 1)
      t.same(files[0], &#039;hello.txt&#039;)
      var fileB = path.join(b, files[0])
      var fileA = path.join(a, files[0])
      t.same(fs.readFileSync(fileB, &#039;utf-8&#039;), fs.readFileSync(fileA, &#039;utf-8&#039;))
      t.same(fs.statSync(fileB).mode, fs.statSync(fileA).mode)
      t.same(mtime(fs.statSync(fileB)), mtime(fs.statSync(fileA)))
    })
})

test(&#039;copy b -&gt; copy/b&#039;, function (t) {
  t.plan(8)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;b&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;b&#039;)

  rimraf.sync(b)
  tar.pack(a)
    .pipe(tar.extract(b))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b)
      t.same(files.length, 1)
      t.same(files[0], &#039;a&#039;)
      var dirB = path.join(b, files[0])
      var dirA = path.join(a, files[0])
      t.same(fs.statSync(dirB).mode, fs.statSync(dirA).mode)
      t.same(mtime(fs.statSync(dirB)), mtime(fs.statSync(dirA)))
      t.ok(fs.statSync(dirB).isDirectory())
      var fileB = path.join(dirB, &#039;test.txt&#039;)
      var fileA = path.join(dirA, &#039;test.txt&#039;)
      t.same(fs.readFileSync(fileB, &#039;utf-8&#039;), fs.readFileSync(fileA, &#039;utf-8&#039;))
      t.same(fs.statSync(fileB).mode, fs.statSync(fileA).mode)
      t.same(mtime(fs.statSync(fileB)), mtime(fs.statSync(fileA)))
    })
})

test(&#039;symlink&#039;, function (t) {
  if (win32) { // no symlink support on win32 currently. TODO: test if this can be enabled somehow
    t.plan(1)
    t.ok(true)
    return
  }

  t.plan(5)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;c&#039;)

  rimraf.sync(path.join(a, &#039;link&#039;))
  fs.symlinkSync(&#039;.gitignore&#039;, path.join(a, &#039;link&#039;))

  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;c&#039;)

  rimraf.sync(b)
  tar.pack(a)
    .pipe(tar.extract(b))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b).sort()
      t.same(files.length, 2)
      t.same(files[0], &#039;.gitignore&#039;)
      t.same(files[1], &#039;link&#039;)

      var linkA = path.join(a, &#039;link&#039;)
      var linkB = path.join(b, &#039;link&#039;)

      t.same(mtime(fs.lstatSync(linkB)), mtime(fs.lstatSync(linkA)))
      t.same(fs.readlinkSync(linkB), fs.readlinkSync(linkA))
    })
})

test(&#039;follow symlinks&#039;, function (t) {
  if (win32) { // no symlink support on win32 currently. TODO: test if this can be enabled somehow
    t.plan(1)
    t.ok(true)
    return
  }

  t.plan(5)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;c&#039;)

  rimraf.sync(path.join(a, &#039;link&#039;))
  fs.symlinkSync(&#039;.gitignore&#039;, path.join(a, &#039;link&#039;))

  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;c-dereference&#039;)

  rimraf.sync(b)
  tar.pack(a, { dereference: true })
    .pipe(tar.extract(b))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b).sort()
      t.same(files.length, 2)
      t.same(files[0], &#039;.gitignore&#039;)
      t.same(files[1], &#039;link&#039;)

      var file1 = path.join(b, &#039;.gitignore&#039;)
      var file2 = path.join(b, &#039;link&#039;)

      t.same(mtime(fs.lstatSync(file1)), mtime(fs.lstatSync(file2)))
      t.same(fs.readFileSync(file1), fs.readFileSync(file2))
    })
})

test(&#039;strip&#039;, function (t) {
  t.plan(2)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;b&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;b-strip&#039;)

  rimraf.sync(b)

  tar.pack(a)
    .pipe(tar.extract(b, { strip: 1 }))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b).sort()
      t.same(files.length, 1)
      t.same(files[0], &#039;test.txt&#039;)
    })
})

test(&#039;strip + map&#039;, function (t) {
  t.plan(2)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;b&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;b-strip&#039;)

  rimraf.sync(b)

  var uppercase = function (header) {
    header.name = header.name.toUpperCase()
    return header
  }

  tar.pack(a)
    .pipe(tar.extract(b, { strip: 1, map: uppercase }))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b).sort()
      t.same(files.length, 1)
      t.same(files[0], &#039;TEST.TXT&#039;)
    })
})

test(&#039;map + dir + permissions&#039;, function (t) {
  t.plan(win32 ? 1 : 2) // skip chmod test, it&#039;s not working like unix

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;b&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;a-perms&#039;)

  rimraf.sync(b)

  var aWithMode = function (header) {
    if (header.name === &#039;a&#039;) {
      header.mode = parseInt(700, 8)
    }
    return header
  }

  tar.pack(a)
    .pipe(tar.extract(b, { map: aWithMode }))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b).sort()
      var stat = fs.statSync(path.join(b, &#039;a&#039;))
      t.same(files.length, 1)
      if (!win32) {
        t.same(stat.mode &amp; parseInt(777, 8), parseInt(700, 8))
      }
    })
})

test(&#039;specific entries&#039;, function (t) {
  t.plan(6)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;d&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;d-entries&#039;)

  var entries = [&#039;file1&#039;, &#039;sub-files/file3&#039;, &#039;sub-dir&#039;]

  rimraf.sync(b)
  tar.pack(a, { entries: entries })
    .pipe(tar.extract(b))
    .on(&#039;finish&#039;, function () {
      var files = fs.readdirSync(b)
      t.same(files.length, 3)
      t.notSame(files.indexOf(&#039;file1&#039;), -1)
      t.notSame(files.indexOf(&#039;sub-files&#039;), -1)
      t.notSame(files.indexOf(&#039;sub-dir&#039;), -1)
      var subFiles = fs.readdirSync(path.join(b, &#039;sub-files&#039;))
      t.same(subFiles, [&#039;file3&#039;])
      var subDir = fs.readdirSync(path.join(b, &#039;sub-dir&#039;))
      t.same(subDir, [&#039;file5&#039;])
    })
})

test(&#039;check type while mapping header on packing&#039;, function (t) {
  t.plan(3)

  var e = path.join(__dirname, &#039;fixtures&#039;, &#039;e&#039;)

  var checkHeaderType = function (header) {
    if (header.name.indexOf(&#039;.&#039;) === -1) t.same(header.type, header.name)
  }

  tar.pack(e, { map: checkHeaderType })
})

test(&#039;finish callbacks&#039;, function (t) {
  t.plan(3)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;a&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;a&#039;)

  rimraf.sync(b)

  var packEntries = 0
  var extractEntries = 0

  var countPackEntry = function (header) { packEntries++ }
  var countExtractEntry = function (header) { extractEntries++ }

  var pack
  var onPackFinish = function (passedPack) {
    t.equal(packEntries, 2, &#039;All entries have been packed&#039;) // 2 entries - the file and base directory
    t.equal(passedPack, pack, &#039;The finish hook passes the pack&#039;)
  }

  var onExtractFinish = function () { t.equal(extractEntries, 2) }

  pack = tar.pack(a, { map: countPackEntry, finish: onPackFinish })

  pack.pipe(tar.extract(b, { map: countExtractEntry, finish: onExtractFinish }))
    .on(&#039;finish&#039;, function () {
      t.end()
    })
})

test(&#039;not finalizing the pack&#039;, function (t) {
  t.plan(2)

  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;a&#039;)
  var b = path.join(__dirname, &#039;fixtures&#039;, &#039;b&#039;)

  var out = path.join(__dirname, &#039;fixtures&#039;, &#039;copy&#039;, &#039;merged-packs&#039;)

  rimraf.sync(out)

  var prefixer = function (prefix) {
    return function (header) {
      header.name = path.join(prefix, header.name)
      return header
    }
  }

  tar.pack(a, {
    map: prefixer(&#039;a-files&#039;),
    finalize: false,
    finish: packB
  })

  function packB (pack) {
    tar.pack(b, { pack: pack, map: prefixer(&#039;b-files&#039;) })
      .pipe(tar.extract(out))
      .on(&#039;finish&#039;, assertResults)
  }

  function assertResults () {
    var containers = fs.readdirSync(out)
    t.deepEqual(containers, [&#039;a-files&#039;, &#039;b-files&#039;])
    var aFiles = fs.readdirSync(path.join(out, &#039;a-files&#039;))
    t.deepEqual(aFiles, [&#039;hello.txt&#039;])
  }
})

test(&#039;do not extract invalid tar&#039;, function (t) {
  var a = path.join(__dirname, &#039;fixtures&#039;, &#039;invalid.tar&#039;)

  var out = path.join(__dirname, &#039;fixtures&#039;, &#039;invalid&#039;)

  rimraf.sync(out)

  fs.createReadStream(a)
    .pipe(tar.extract(out))
    .on(&#039;error&#039;, function (err) {
      t.ok(/is not a valid symlink/i.test(err.message))
      fs.stat(path.join(out, &#039;../bar&#039;), function (err) {
        t.ok(err)
        t.end()
      })
    })
})

test(&#039;no abs hardlink targets&#039;, function (t) {
  var out = path.join(__dirname, &#039;fixtures&#039;, &#039;invalid&#039;)
  var outside = path.join(__dirname, &#039;fixtures&#039;, &#039;outside&#039;)

  rimraf.sync(out)

  var s = tarStream.pack()

  fs.writeFileSync(outside, &#039;something&#039;)

  s.entry({
    type: &#039;link&#039;,
    name: &#039;link&#039;,
    linkname: outside
  })

  s.entry({
    name: &#039;link&#039;
  }, &#039;overwrite&#039;)

  s.finalize()

  s.pipe(tar.extract(out))
    .on(&#039;error&#039;, function (err) {
      t.ok(err, &#039;had error&#039;)
      fs.readFile(outside, &#039;utf-8&#039;, function (err, str) {
        t.error(err, &#039;no error&#039;)
        t.same(str, &#039;something&#039;)
        t.end()
      })
    })
})
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
