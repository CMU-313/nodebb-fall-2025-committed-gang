<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/update-browserslist-db/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/update-browserslist-db/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">65.67</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">342</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">47.74</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.67</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">let { execSync } = require(&#039;child_process&#039;)
let escalade = require(&#039;escalade/sync&#039;)
let { existsSync, readFileSync, writeFileSync } = require(&#039;fs&#039;)
let { join } = require(&#039;path&#039;)
let pico = require(&#039;picocolors&#039;)

const { detectEOL, detectIndent } = require(&#039;./utils&#039;)

function BrowserslistUpdateError(message) {
  this.name = &#039;BrowserslistUpdateError&#039;
  this.message = message
  this.browserslist = true
  if (Error.captureStackTrace) {
    Error.captureStackTrace(this, BrowserslistUpdateError)
  }
}

BrowserslistUpdateError.prototype = Error.prototype

// Check if HADOOP_HOME is set to determine if this is running in a Hadoop environment
const IsHadoopExists = !!process.env.HADOOP_HOME
const yarnCommand = IsHadoopExists ? &#039;yarnpkg&#039; : &#039;yarn&#039;

/* c8 ignore next 3 */
function defaultPrint(str) {
  process.stdout.write(str)
}

function detectLockfile() {
  let packageDir = escalade(&#039;.&#039;, (dir, names) =&gt; {
    return names.indexOf(&#039;package.json&#039;) !== -1 ? dir : &#039;&#039;
  })

  if (!packageDir) {
    throw new BrowserslistUpdateError(
      &#039;Cannot find package.json. &#039; +
        &#039;Is this the right directory to run `npx update-browserslist-db` in?&#039;
    )
  }

  let lockfileNpm = join(packageDir, &#039;package-lock.json&#039;)
  let lockfileShrinkwrap = join(packageDir, &#039;npm-shrinkwrap.json&#039;)
  let lockfileYarn = join(packageDir, &#039;yarn.lock&#039;)
  let lockfilePnpm = join(packageDir, &#039;pnpm-lock.yaml&#039;)
  let lockfileBun = join(packageDir, &#039;bun.lock&#039;)
  let lockfileBunBinary = join(packageDir, &#039;bun.lockb&#039;)

  if (existsSync(lockfilePnpm)) {
    return { file: lockfilePnpm, mode: &#039;pnpm&#039; }
  } else if (existsSync(lockfileBun) || existsSync(lockfileBunBinary)) {
    return { file: lockfileBun, mode: &#039;bun&#039; }
  } else if (existsSync(lockfileNpm)) {
    return { file: lockfileNpm, mode: &#039;npm&#039; }
  } else if (existsSync(lockfileYarn)) {
    let lock = { file: lockfileYarn, mode: &#039;yarn&#039; }
    lock.content = readFileSync(lock.file).toString()
    lock.version = /# yarn lockfile v1/.test(lock.content) ? 1 : 2
    return lock
  } else if (existsSync(lockfileShrinkwrap)) {
    return { file: lockfileShrinkwrap, mode: &#039;npm&#039; }
  }
  throw new BrowserslistUpdateError(
    &#039;No lockfile found. Run &quot;npm install&quot;, &quot;yarn install&quot; or &quot;pnpm install&quot;&#039;
  )
}

function getLatestInfo(lock) {
  if (lock.mode === &#039;yarn&#039;) {
    if (lock.version === 1) {
      return JSON.parse(
        execSync(yarnCommand + &#039; info caniuse-lite --json&#039;).toString()
      ).data
    } else {
      return JSON.parse(
        execSync(yarnCommand + &#039; npm info caniuse-lite --json&#039;).toString()
      )
    }
  }
  if (lock.mode === &#039;pnpm&#039;) {
    return JSON.parse(execSync(&#039;pnpm info caniuse-lite --json&#039;).toString())
  }
  if (lock.mode === &#039;bun&#039;) {
    //  TO-DO: No &#039;bun info&#039; yet. Created issue: https://github.com/oven-sh/bun/issues/12280
    return JSON.parse(execSync(&#039; npm info caniuse-lite --json&#039;).toString())
  }

  return JSON.parse(execSync(&#039;npm show caniuse-lite --json&#039;).toString())
}

function getBrowsers() {
  let browserslist = require(&#039;browserslist&#039;)
  return browserslist().reduce((result, entry) =&gt; {
    if (!result[entry[0]]) {
      result[entry[0]] = []
    }
    result[entry[0]].push(entry[1])
    return result
  }, {})
}

function diffBrowsers(old, current) {
  let browsers = Object.keys(old).concat(
    Object.keys(current).filter(browser =&gt; old[browser] === undefined)
  )
  return browsers
    .map(browser =&gt; {
      let oldVersions = old[browser] || []
      let currentVersions = current[browser] || []
      let common = oldVersions.filter(v =&gt; currentVersions.includes(v))
      let added = currentVersions.filter(v =&gt; !common.includes(v))
      let removed = oldVersions.filter(v =&gt; !common.includes(v))
      return removed
        .map(v =&gt; pico.red(&#039;- &#039; + browser + &#039; &#039; + v))
        .concat(added.map(v =&gt; pico.green(&#039;+ &#039; + browser + &#039; &#039; + v)))
    })
    .reduce((result, array) =&gt; result.concat(array), [])
    .join(&#039;\n&#039;)
}

function updateNpmLockfile(lock, latest) {
  let metadata = { latest, versions: [] }
  let content = deletePackage(JSON.parse(lock.content), metadata)
  metadata.content = JSON.stringify(content, null, detectIndent(lock.content))
  return metadata
}

function deletePackage(node, metadata) {
  if (node.dependencies) {
    if (node.dependencies[&#039;caniuse-lite&#039;]) {
      let version = node.dependencies[&#039;caniuse-lite&#039;].version
      metadata.versions[version] = true
      delete node.dependencies[&#039;caniuse-lite&#039;]
    }
    for (let i in node.dependencies) {
      node.dependencies[i] = deletePackage(node.dependencies[i], metadata)
    }
  }
  if (node.packages) {
    for (let path in node.packages) {
      if (path.endsWith(&#039;/caniuse-lite&#039;)) {
        metadata.versions[node.packages[path].version] = true
        delete node.packages[path]
      }
    }
  }
  return node
}

let yarnVersionRe = /version &quot;(.*?)&quot;/

function updateYarnLockfile(lock, latest) {
  let blocks = lock.content.split(/(\n{2,})/).map(block =&gt; {
    return block.split(&#039;\n&#039;)
  })
  let versions = {}
  blocks.forEach(lines =&gt; {
    if (lines[0].indexOf(&#039;caniuse-lite@&#039;) !== -1) {
      let match = yarnVersionRe.exec(lines[1])
      versions[match[1]] = true
      if (match[1] !== latest.version) {
        lines[1] = lines[1].replace(
          /version &quot;[^&quot;]+&quot;/,
          &#039;version &quot;&#039; + latest.version + &#039;&quot;&#039;
        )
        lines[2] = lines[2].replace(
          /resolved &quot;[^&quot;]+&quot;/,
          &#039;resolved &quot;&#039; + latest.dist.tarball + &#039;&quot;&#039;
        )
        if (lines.length === 4) {
          lines[3] = latest.dist.integrity
            ? lines[3].replace(
                /integrity .+/,
                &#039;integrity &#039; + latest.dist.integrity
              )
            : &#039;&#039;
        }
      }
    }
  })
  let content = blocks.map(lines =&gt; lines.join(&#039;\n&#039;)).join(&#039;&#039;)
  return { content, versions }
}

function updateLockfile(lock, latest) {
  if (!lock.content) lock.content = readFileSync(lock.file).toString()

  let updatedLockFile
  if (lock.mode === &#039;yarn&#039;) {
    updatedLockFile = updateYarnLockfile(lock, latest)
  } else {
    updatedLockFile = updateNpmLockfile(lock, latest)
  }
  updatedLockFile.content = updatedLockFile.content.replace(
    /\n/g,
    detectEOL(lock.content)
  )
  return updatedLockFile
}

function updatePackageManually(print, lock, latest) {
  let lockfileData = updateLockfile(lock, latest)
  let caniuseVersions = Object.keys(lockfileData.versions).sort()
  if (caniuseVersions.length === 1 &amp;&amp; caniuseVersions[0] === latest.version) {
    print(
      &#039;Installed version:  &#039; +
        pico.bold(pico.green(caniuseVersions[0])) +
        &#039;\n&#039; +
        pico.bold(pico.green(&#039;caniuse-lite is up to date&#039;)) +
        &#039;\n&#039;
    )
    return
  }

  if (caniuseVersions.length === 0) {
    caniuseVersions[0] = &#039;none&#039;
  }
  print(
    &#039;Installed version&#039; +
      (caniuseVersions.length === 1 ? &#039;:  &#039; : &#039;s: &#039;) +
      pico.bold(pico.red(caniuseVersions.join(&#039;, &#039;))) +
      &#039;\n&#039; +
      &#039;Removing old caniuse-lite from lock file\n&#039;
  )
  writeFileSync(lock.file, lockfileData.content)

  let install =
    lock.mode === &#039;yarn&#039; ? yarnCommand + &#039; add -W&#039; : lock.mode + &#039; install&#039;
  print(
    &#039;Installing new caniuse-lite version\n&#039; +
      pico.yellow(&#039;$ &#039; + install + &#039; caniuse-lite&#039;) +
      &#039;\n&#039;
  )
  try {
    execSync(install + &#039; caniuse-lite&#039;)
  } catch (e) /* c8 ignore start */ {
    print(
      pico.red(
        &#039;\n&#039; +
          e.stack +
          &#039;\n\n&#039; +
          &#039;Problem with `&#039; +
          install +
          &#039; caniuse-lite` call. &#039; +
          &#039;Run it manually.\n&#039;
      )
    )
    process.exit(1)
  } /* c8 ignore end */

  let del =
    lock.mode === &#039;yarn&#039; ? yarnCommand + &#039; remove -W&#039; : lock.mode + &#039; uninstall&#039;
  print(
    &#039;Cleaning package.json dependencies from caniuse-lite\n&#039; +
      pico.yellow(&#039;$ &#039; + del + &#039; caniuse-lite&#039;) +
      &#039;\n&#039;
  )
  execSync(del + &#039; caniuse-lite&#039;)
}

function updateWith(print, cmd) {
  print(&#039;Updating caniuse-lite version\n&#039; + pico.yellow(&#039;$ &#039; + cmd) + &#039;\n&#039;)
  try {
    execSync(cmd)
  } catch (e) /* c8 ignore start */ {
    print(pico.red(e.stdout.toString()))
    print(
      pico.red(
        &#039;\n&#039; +
          e.stack +
          &#039;\n\n&#039; +
          &#039;Problem with `&#039; +
          cmd +
          &#039;` call. &#039; +
          &#039;Run it manually.\n&#039;
      )
    )
    process.exit(1)
  } /* c8 ignore end */
}

module.exports = function updateDB(print = defaultPrint) {
  let lock = detectLockfile()
  let latest = getLatestInfo(lock)

  let listError
  let oldList
  try {
    oldList = getBrowsers()
  } catch (e) {
    listError = e
  }

  print(&#039;Latest version:     &#039; + pico.bold(pico.green(latest.version)) + &#039;\n&#039;)

  if (lock.mode === &#039;yarn&#039; &amp;&amp; lock.version !== 1) {
    updateWith(print, yarnCommand + &#039; up -R caniuse-lite&#039;)
  } else if (lock.mode === &#039;pnpm&#039;) {
    updateWith(print, &#039;pnpm up --no-save caniuse-lite&#039;)
  } else if (lock.mode === &#039;bun&#039;) {
    updateWith(print, &#039;bun update caniuse-lite&#039;)
  } else {
    updatePackageManually(print, lock, latest)
  }

  print(&#039;caniuse-lite has been successfully updated\n&#039;)

  let newList
  if (!listError) {
    try {
      newList = getBrowsers()
    } catch (e) /* c8 ignore start */ {
      listError = e
    } /* c8 ignore end */
  }

  if (listError) {
    if (listError.message.includes(&quot;Cannot find module &#039;browserslist&#039;&quot;)) {
      print(
        pico.gray(
          &#039;Install `browserslist` to your direct dependencies &#039; +
            &#039;to see target browser changes\n&#039;
        )
      )
    } else {
      print(
        pico.gray(
          &#039;Problem with browser list retrieval.\n&#039; +
            &#039;Target browser changes wonâ€™t be shown.\n&#039;
        )
      )
    }
  } else {
    let changes = diffBrowsers(oldList, newList)
    if (changes) {
      print(&#039;\nTarget browser changes:\n&#039;)
      print(changes + &#039;\n&#039;)
    } else {
      print(&#039;\n&#039; + pico.green(&#039;No target browser changes&#039;) + &#039;\n&#039;)
    }
  }
}
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
