<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/nodebb-plugin-2factor/lib/controllers.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/nodebb-plugin-2factor/lib/controllers.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">65.77</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">251</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">46.10</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.09</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

const parent = module.parent.exports;

const passport = require.main.require(&#039;passport&#039;);
const nconf = require.main.require(&#039;nconf&#039;);
const winston = require.main.require(&#039;winston&#039;);
const validator = require.main.require(&#039;validator&#039;);
const async = require(&#039;async&#039;);
const fs = require(&#039;fs&#039;);
const path = require(&#039;path&#039;);
const base64url = require(&#039;base64url&#039;);

const groups = require.main.require(&#039;./src/groups&#039;);
const user = require.main.require(&#039;./src/user&#039;);
const meta = require.main.require(&#039;./src/meta&#039;);
const helpers = require.main.require(&#039;./src/controllers/helpers&#039;);

const Controllers = module.exports;


async function getGroups(set) {
	let groupNames = await groups.getGroups(set, 0, -1);
	groupNames = groupNames.filter(groupName =&gt; groupName &amp;&amp; !groups.isPrivilegeGroup(groupName));

	return groupNames.map(groupName =&gt; ({
		name: validator.escape(String(groupName)),
		value: validator.escape(String(groupName)),
	}));
}

Controllers.renderChoices = async (req, res) =&gt; {
	const uid = res.locals[&#039;2factor&#039;] || req.uid;
	const [hasAuthn, hasTotp, hasBackupCodes] = await Promise.all([
		parent.hasAuthn(uid),
		parent.hasTotp(uid),
		parent.hasBackupCodes(uid),
	]);
	const count = [hasAuthn, hasTotp, hasBackupCodes].reduce((count, cur) =&gt; count + (cur ? 1 : 0), 0);

	if (count === 1) {
		switch (true) {
			case hasAuthn:
				helpers.redirect(res, `/login/2fa/authn?single=1&amp;next=${req.query.next || &#039;/&#039;}`);
				break;

			case hasTotp:
				helpers.redirect(res, `/login/2fa/totp?single=1&amp;next=${req.query.next || &#039;/&#039;}`);
				break;

			case hasBackupCodes:
				helpers.redirect(res, `/login/2fa/backup?single=1&amp;next=${req.query.next || &#039;/&#039;}`);
				break;
		}

		return;
	}

	res.render(&#039;2fa-choices&#039;, {
		hasAuthn,
		hasTotp,
		hasBackupCodes,
		next: req.query.next,
		title: &#039;[[2factor:title]]&#039;,
	});
};

Controllers.renderTotpChallenge = async (req, res, next) =&gt; {
	const uid = res.locals[&#039;2factor&#039;] || req.uid;
	const single = parseInt(req.query.single, 10) === 1;

	if (req.session.tfa === true &amp;&amp; !req.session.tfaForce) {
		return res.redirect(nconf.get(&#039;relative_path&#039;) + (req.query.next || &#039;/&#039;));
	}

	const error = req.flash(&#039;error&#039;);
	if (error.includes(&#039;[[2factor:login.failure]]&#039;)) {
		const main = require(&#039;..&#039;);
		main.handle2faFailure(uid);
	}

	if (!await parent.hasTotp(uid)) {
		return next();
	}

	setTimeout(() =&gt; {
		res.render(&#039;login-totp&#039;, {
			single,
			error: error[0],
			next: req.query.next,
		});
	}, error.length ? 2500 : undefined);
};

Controllers.renderAuthnChallenge = async (req, res, next) =&gt; {
	const uid = res.locals[&#039;2factor&#039;] || req.uid;
	const single = parseInt(req.query.single, 10) === 1;

	if (req.session.tfa === true &amp;&amp; ((req.query.next &amp;&amp; !req.query.next.startsWith(&#039;/admin&#039;)) || !req.session.tfaForce)) {
		return res.redirect(nconf.get(&#039;relative_path&#039;) + (req.query.next || &#039;/&#039;));
	}

	if (!await parent.hasAuthn(uid)) {
		return next();
	}

	const keyIds = await parent.getAuthnKeyIds(uid);
	let authnOptions;
	if (keyIds.length) {
		authnOptions = await parent._f2l.assertionOptions();
		authnOptions.allowCredentials = keyIds.map(keyId =&gt; ({
			id: keyId,
			type: &#039;public-key&#039;,
			transports: [&#039;usb&#039;, &#039;ble&#039;, &#039;nfc&#039;],
		}));
		authnOptions.challenge = base64url(authnOptions.challenge);
		req.session.authRequest = authnOptions.challenge;
	}

	res.render(&#039;login-authn&#039;, {
		single,
		authnOptions,
		next: req.query.next,
	});
};

Controllers.processTotpLogin = function (req, res, next) {
	passport.authenticate(&#039;totp&#039;, {
		failureRedirect: `${nconf.get(&#039;relative_path&#039;)}/login/2fa/totp`,
		failureFlash: &#039;[[2factor:login.failure]]&#039;,
		keepSessionInfo: true,
	})(req, res, next);
};

Controllers.renderBackup = async (req, res, next) =&gt; {
	const uid = res.locals[&#039;2factor&#039;] || req.uid;
	const single = parseInt(req.query.single, 10) === 1;

	if (req.session.tfa === true &amp;&amp; ((req.query.next &amp;&amp; !req.query.next.startsWith(&#039;/admin&#039;)) || !req.session.tfaForce)) {
		return res.redirect(nconf.get(&#039;relative_path&#039;) + (req.query.next || &#039;/&#039;));
	}

	const error = req.flash(&#039;error&#039;);

	if (!await parent.hasKey(uid)) {
		return next();
	}

	setTimeout(() =&gt; {
		res.render(&#039;login-backup&#039;, {
			single,
			error: error[0],
			next: req.query.next,
		});
	}, error.length ? 2500 : undefined);
};

Controllers.generateBackupCodes = function (req, res) {
	parent.generateBackupCodes(req.user.uid, (err, codes) =&gt; {
		if (err) {
			winston.error(`[plugin/2factor] Could not generate new backup codes for uid ${req.user.uid}! Error: ${err.message}`);
			return res.sendStatus(500);
		}

		res.status(200).json({
			codes: codes,
		});
	});
};

Controllers.processBackup = function (req, res, next) {
	parent.useBackupCode(req.body.code, req.user.uid, (err, success) =&gt; {
		if (err || !success) {
			req.flash(&#039;error&#039;, !err ? &#039;[[2factor:backup.failure]]&#039; : err.message);
			res.redirect(`${nconf.get(&#039;relative_path&#039;)}/login/2fa/backup`);
		} else {
			// Success!
			next();
		}
	});
};

Controllers.renderAdminPage = async function (req, res, next) {
	const groups = await getGroups(&#039;groups:createtime&#039;);

	async.parallel({
		image: async.apply(fs.readFile, path.join(__dirname, &#039;../screenshots/profile.png&#039;), {
			encoding: &#039;base64&#039;,
		}),
		users: async.apply(parent.getUsers),
	}, (err, data) =&gt; {
		if (err) {
			return next(err);
		}

		data.groups = groups;
		data.title = &#039;[[2factor:title]]&#039;;
		res.render(&#039;admin/plugins/2factor&#039;, data);
	});
};

Controllers.renderSettings = async (req, res) =&gt; {
	const { username, userslug } = await user.getUserFields(res.locals.uid, [&#039;username&#039;, &#039;userslug&#039;]);
	if (res.locals.uid !== req.uid) {
		return helpers.notAllowed(req, res);
	}

	const breadcrumbs = helpers.buildBreadcrumbs([
		{
			text: username,
			url: `/user/${userslug}`,
		},
		{
			text: &#039;[[2factor:title]]&#039;,
		},
	]);

	let { tfaEnforcedGroups } = await meta.settings.get(&#039;2factor&#039;);
	let forceTfa = false;

	tfaEnforcedGroups = JSON.parse(tfaEnforcedGroups || &#039;[]&#039;);
	if (tfaEnforcedGroups.length &amp;&amp; (await groups.isMemberOfGroups(req.user.uid, tfaEnforcedGroups)).includes(true)) {
		forceTfa = true;
	}

	const hasTotp = await parent.hasTotp(req.user.uid);
	const hasAuthn = await parent.hasAuthn(req.user.uid);
	res.render(&#039;account/2factor&#039;, {
		...res.locals.userData,
		title: &#039;[[2factor:title]]&#039;,
		breadcrumbs,
		forceTfa,
		hasTotp,
		hasAuthn,
		backupCodeCount: await parent.countBackupCodes(req.user.uid),
	});
};

Controllers.renderAccessNotificationHelp = (req, res, next) =&gt; {
	const { when } = req.query;
	if (!when) {
		return next();
	}

	const date = new Date(parseInt(when, 10));
	res.render(&#039;2fa-access-notification&#039;, {
		timeString: date.toLocaleTimeString(date),
		dateString: date.toLocaleDateString(date),
	});
};
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
