<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/nodebb-plugin-spam-be-gone/library.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/nodebb-plugin-spam-be-gone/library.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">70.81</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">331</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">39.61</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.91</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;


var Honeypot = require(&#039;project-honeypot&#039;);
var simpleRecaptcha = require(&#039;simple-recaptcha-new&#039;);
var pluginData = require(&#039;./plugin.json&#039;);
var winston = require.main.require(&#039;winston&#039;);
var nconf = require.main.require(&#039;nconf&#039;);
var async = require.main.require(&#039;async&#039;);
var Meta = require.main.require(&#039;./src/meta&#039;);
var user = require.main.require(&#039;./src/user&#039;);
var topics = require.main.require(&#039;./src/topics&#039;);
var db = require.main.require(&#039;./src/database&#039;);

var akismet;
var honeypot;
var recaptchaArgs;
var pluginSettings;
var Plugin = module.exports;

pluginData.nbbId = pluginData.id.replace(/nodebb-plugin-/, &#039;&#039;);

Plugin.load = function (params, callback) {

	var render = function (req, res, next) {
		res.render(&#039;admin/plugins/&#039; + pluginData.nbbId, pluginData || {});
	};

	Meta.settings.get(pluginData.nbbId, function (err, settings) {
		if (err) {
			return callback(err);
		}
		if (!settings) {
			winston.warn(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Settings not set or could not be retrived!&#039;);
			return callback();
		}

		if (settings.akismetEnabled === &#039;on&#039;) {
			if (settings.akismetApiKey) {
				akismet = require(&#039;akismet&#039;).client({
					blog: nconf.get(&#039;url&#039;),
					apiKey: settings.akismetApiKey
				});
				akismet.verifyKey(function (err, verified) {
					if (!verified) {
						winston.error(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Unable to verify Akismet API key.&#039;);
						akismet = null;
					}
				});
			} else {
				winston.error(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Akismet API Key not set!&#039;);
			}
		}

		if (settings.honeypotEnabled === &#039;on&#039;) {
			if (settings.honeypotApiKey) {
				honeypot = Honeypot(settings.honeypotApiKey);
			} else {
				winston.error(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Honeypot API Key not set!&#039;);
			}
		}

		if (settings.recaptchaEnabled === &#039;on&#039;) {
			if (settings.recaptchaPublicKey &amp;&amp; settings.recaptchaPrivateKey) {

				recaptchaArgs = {
					publicKey: settings.recaptchaPublicKey,
					targetId: pluginData.nbbId + &#039;-recaptcha-target&#039;,
					options: {
						// theme: settings.recaptchaTheme || &#039;clean&#039;,
						//todo: switch to custom theme, issue#9
						theme: &#039;clean&#039;,

						hl: (Meta.config.defaultLang || &#039;en&#039;).toLowerCase(),
						tabindex: settings.recaptchaTabindex || 0
					}
				};
			}
		}

		if (!settings.akismetMinReputationHam) {
			settings.akismetMinReputationHam = 10;
		}

		winston.info(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Settings loaded&#039;);
		pluginSettings = settings;

		params.router.get(&#039;/admin/plugins/&#039; + pluginData.nbbId, params.middleware.admin.buildHeader, render);
		params.router.get(&#039;/api/admin/plugins/&#039; + pluginData.nbbId, render);

		callback();
	});
};

Plugin.addCaptcha = function (data, callback) {
	if (recaptchaArgs) {
		var captcha = {
			label: &#039;Captcha&#039;,
			html: &#039;&#039; +
			&#039;&lt;div id=&quot;&#039; + pluginData.nbbId + &#039;-recaptcha-target&quot;&gt;&lt;/div&gt;&#039; +
			&#039;&lt;script id=&quot;&#039; + pluginData.nbbId + &#039;-recaptcha-script&quot;&gt;\n\n&#039; +
			&#039;window.plugin = window.plugin || {};\n\t\t\t&#039; +
			&#039;plugin[&quot;&#039; + pluginData.nbbId + &#039;&quot;] = window.plugin[&quot;&#039; + pluginData.nbbId + &#039;&quot;] || {};\n\t\t\t&#039;	+
			&#039;plugin[&quot;&#039; + pluginData.nbbId + &#039;&quot;].recaptchaArgs = &#039; + JSON.stringify(recaptchaArgs) + &#039;;\n&#039;+ &#039;&lt;/script&gt;&#039;,
			styleName: pluginData.nbbId
		};
		if (data.templateData.regFormEntry &amp;&amp; Array.isArray(data.templateData.regFormEntry)) {
			data.templateData.regFormEntry.push(captcha);
		} else {
			data.templateData.captcha = captcha;
		}
	}
	callback(null, data);
};

Plugin.onPostEdit = function(data, callback) {
	async.waterfall([
		function (next) {
			topics.getTopicField(data.post.tid, &#039;cid&#039;, next);
		},
		function (cid, next) {
			Plugin.checkReply({
				content: data.post.content,
				uid: data.post.uid,
				cid: cid,
				req: data.req,
			}, {type: &#039;post&#039;}, function (err) {
				next(err, data);
			});
		},
	], callback);
};

Plugin.onTopicEdit = function(data, callback) {
	Plugin.checkReply({
		title: data.topic.title || &#039;&#039;,
		uid: data.topic.uid,
		cid: data.topic.cid,
		req: data.req
	}, {type: &#039;topic&#039;}, function(err) {
		callback(err, data);
	});
};

Plugin.onTopicPost = function(data, callback) {
	Plugin.checkReply(data, {type: &#039;topic&#039;}, callback);
};

Plugin.onTopicReply = function(data, callback) {
	Plugin.checkReply(data, {type: &#039;post&#039;}, callback);
};

Plugin.checkReply = function (data, options, callback) {
	if (typeof options === &#039;function&#039;) {
		callback = options;
		options = null;
	}
	options = options || {};

	// http://akismet.com/development/api/#comment-check
	if (!akismet || !data || !data.req) {
		return callback(null, data);
	}
	var userData;
	var akismetData;
	async.waterfall([
		function (next) {
			async.parallel({
				isAdmin: function(next) {
					user.isAdministrator(data.uid, next);
				},
				isModerator: function (next) {
					user.isModerator(data.uid, data.cid, next);
				},
				userData: function(next) {
					user.getUserFields(data.uid, [&#039;username&#039;, &#039;reputation&#039;, &#039;email&#039;], next);
				}
			}, next);
		},
		function (results, next) {
			userData = results.userData;
			if (results.isAdmin || results.isModerator) {
				return callback(null, data);
			}
			akismetData = {
				referrer: data.req.headers[&#039;referer&#039;],
				user_ip: data.req.ip,
				user_agent: data.req.headers[&#039;user-agent&#039;],
				permalink: nconf.get(&#039;url&#039;).replace(/\/$/, &#039;&#039;) + data.req.path,
				comment_content: (data.title ? data.title + &#039;\n\n&#039; : &#039;&#039;) + (data.content || &#039;&#039;),
				comment_author: userData.username,
				comment_author_email: userData.email,
				// https://github.com/akhoury/nodebb-plugin-spam-be-gone/issues/54
				comment_type: options.type === &#039;topic&#039; ? &#039;forum-post&#039; : &#039;comment&#039;
			};
			akismet.checkSpam(akismetData, next);
		},
		function (spam, next) {
			if (!spam) {
				return callback(null, data);
			}

			if (parseInt(userData.reputation, 10) &gt;= parseInt(pluginSettings.akismetMinReputationHam, 10)) {
				akismet.submitHam(akismetData, function (err) {
					if (err) {
						winston.error(err);
					}
				});
			}

			winston.verbose(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] Post &quot;&#039; + akismetData.comment_content + &#039;&quot; by uid: &#039; + data.uid + &#039; username: &#039; + userData.username + &#039;@&#039; + data.req.ip + &#039; was flagged as spam and rejected.&#039;);
			next(new Error(&#039;Post content was flagged as spam by Akismet.com&#039;));
		}
	], callback);
};

Plugin.checkRegister = function (data, callback) {
	async.parallel([
		function (next) {
			Plugin._honeypotCheck(data.req, data.res, data.userData, next);
		},
		function (next) {
			Plugin._recaptchaCheck(data.req, data.res, data.userData, next);
		}
	], function (err) {
		callback(err, data);
	});
};

Plugin.onPostFlagged = function (data) {
	var flagObj = data.flag;

	// Don&#039;t do anything if flag is not for a post and not for &quot;spam&quot; reason
	if (flagObj.type !== &#039;post&#039; || flagObj.description !== &#039;Spam&#039;) {
		return;
	}

	if (akismet &amp;&amp; pluginSettings.akismetFlagReporting &amp;&amp; parseInt(flagObj.reporter.reputation, 10) &gt;= parseInt(pluginSettings.akismetFlagReporting, 10)) {
		async.parallel({
			userData: function (next) {
				user.getUserFields(flagObj.target.uid, [&#039;username&#039;, &#039;email&#039;], next);
			},
			permalink: function (next) {
				topics.getTopicField(flagObj.target.tid, &#039;slug&#039;, next);
			},
			ip: function (next) {
				db.getSortedSetRevRange(&#039;uid:&#039; + flagObj.target.uid + &#039;:ip&#039;, 0, 1, next);
			}
		}, function (err, data) {
			// todo: we don&#039;t have access to the req here :/
			var submitted = {
				user_ip: data.ip ? data.ip[0] : &#039;&#039;,
				permalink: nconf.get(&#039;url&#039;).replace(/\/$/, &#039;&#039;) + &#039;/topic/&#039; + data.permalink,
				comment_author: data.userData.username,
				comment_author_email: data.userData.email,
				comment_content: flagObj.target.content,
				comment_type: &#039;forum-post&#039;
			};

			akismet.submitSpam(submitted, function (err) {
				if (err) {
					winston.error(&#039;Error reporting to Akismet&#039;, err, submitted);
				}

				winston.info(&#039;Spam reported to Akismet.&#039;, submitted);
			});
		});
	}
};

Plugin._honeypotCheck = function (req, res, userData, next) {
	if (honeypot &amp;&amp; req &amp;&amp; req.ip) {
		honeypot.query(req.ip, function (err, results) {
			if (err) {
				winston.error(err);
				next(null, userData);
			} else {
				if (results &amp;&amp; results.found &amp;&amp; results.type) {
					if (results.type.spammer || results.type.suspicious) {
						var message = userData.username + &#039; | &#039; + userData.email + &#039; was detected as &#039; + (results.type.spammer ? &#039;spammer&#039; : &#039;suspicious&#039;);

						winston.warn(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] &#039; + message + &#039; and was denied registration.&#039;);
						next(new Error(message), userData);
					} else {
						next(null, userData);
					}
				} else {
					winston.verbose(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] username:&#039; + userData.username + &#039; ip:&#039; + req.ip + &#039; was not found in Honeypot database&#039;);
					next(null, userData);
				}
			}
		});
	} else {
		next(null, userData);
	}
};

Plugin._recaptchaCheck = function (req, res, userData, next) {
	if (recaptchaArgs &amp;&amp; req &amp;&amp; req.ip &amp;&amp; req.body) {

		simpleRecaptcha(
			pluginSettings.recaptchaPrivateKey,
			req.ip,
			req.body[&#039;g-recaptcha-response&#039;],
			function (err) {
				if (err) {
					var message = err.Error || &#039;Captcha not verified, are you a robot?&#039;;
					winston.verbose(&#039;[plugins/&#039; + pluginData.nbbId + &#039;] &#039; + message);
					next(new Error(message), userData);
				} else {
					next(null, userData);
				}
			}
		);
	} else {
		next(null, userData);
	}
};

Plugin.admin = {
	menu: function (custom_header, callback) {
		custom_header.plugins.push({
			&quot;route&quot;: &#039;/plugins/&#039; + pluginData.nbbId,
			&quot;icon&quot;: pluginData.faIcon,
			&quot;name&quot;: pluginData.name
		});

		callback(null, custom_header);
	}
};
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
