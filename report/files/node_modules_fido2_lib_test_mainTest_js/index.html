<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/fido2-lib/test/mainTest.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/fido2-lib/test/mainTest.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">75.64</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">970</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">44.31</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">10.46</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&quot;use strict&quot;;

const { Fido2Lib } = require(&quot;../index&quot;);
const {
	Fido2AttestationResult,
	Fido2AssertionResult,
} = require(&quot;../lib/response&quot;);
const chai = require(&quot;chai&quot;);
const chaiAsPromised = require(&quot;chai-as-promised&quot;);
chai.use(chaiAsPromised);
const assert = chai.assert;
const sinon = require(&quot;sinon&quot;);
const h = require(&quot;fido2-helpers&quot;);
const noneAttestation = require(&quot;../lib/attestations/none&quot;);
const u2fAttestation = require(&quot;../lib/attestations/fidoU2F&quot;);
const packedAttestation = require(&quot;../lib/attestations/packed&quot;);
const tpmAttestation = require(&quot;../lib/attestations/tpm&quot;);
const androidSafetyNetAttestation = require(&quot;../lib/attestations/androidSafetyNet&quot;);
const packedSelfAttestationResponse = require(&quot;../fixtures/packedSelfAttestationData.json&quot;);

const {
	MdsCollection,
	MdsEntry,
} = require(&quot;../lib/mds&quot;);

const {
	abToBuf,
	abEqual,
	printHex,
	coerceToArrayBuffer,
} = require(&quot;../lib/utils&quot;);

const crypto = require(&quot;crypto&quot;);

function restoreAttestationFormats() {
	// add &#039;none&#039; attestation format
	Fido2Lib.addAttestationFormat(
		noneAttestation.name,
		noneAttestation.parseFn,
		noneAttestation.validateFn
	);
	// add &#039;u2f&#039; attestation format
	Fido2Lib.addAttestationFormat(
		u2fAttestation.name,
		u2fAttestation.parseFn,
		u2fAttestation.validateFn
	);
	// add &#039;packed&#039; attestation format
	Fido2Lib.addAttestationFormat(
		packedAttestation.name,
		packedAttestation.parseFn,
		packedAttestation.validateFn
	);
	// add &#039;tpm&#039; attestation format
	Fido2Lib.addAttestationFormat(
		tpmAttestation.name,
		tpmAttestation.parseFn,
		tpmAttestation.validateFn
	);
	// add &#039;android-safetynet&#039; attestation format
	Fido2Lib.addAttestationFormat(
		androidSafetyNetAttestation.name,
		androidSafetyNetAttestation.parseFn,
		androidSafetyNetAttestation.validateFn
	);
}

describe(&quot;Fido2Lib&quot;, function() {
	it(&quot;can create FIDO server object&quot;, function() {
		var fs = new Fido2Lib();
		assert(fs);
		assert.isFunction(fs.attestationOptions);
		assert.isFunction(fs.attestationResult);
		assert.isFunction(fs.assertionOptions);
		assert.isFunction(fs.assertionResult);
	});

	describe(&quot;config&quot;, function() {
		it(&quot;can config timeout&quot;, function() {
			var fs = new Fido2Lib({
				timeout: 42,
			});
			assert.strictEqual(fs.config.timeout, 42);
		});

		it(&quot;can config zero timeout&quot;, function() {
			var fs = new Fido2Lib({
				timeout: 0,
			});
			assert.strictEqual(fs.config.timeout, 0);
		});

		it(&quot;has default timeout&quot;, function() {
			var fs = new Fido2Lib();
			assert.strictEqual(fs.config.timeout, 60000);
		});

		it(&quot;throws on bad timeout&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					timeout: &quot;foo&quot;,
				});
			}, TypeError, &quot;expected timeout to be number, got: foo&quot;);
		});

		it(&quot;throws on NaN timeout&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					timeout: NaN,
				});
			}, RangeError, &quot;timeout should be zero or positive integer&quot;);
		});

		it(&quot;throws on floating point timeout&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					timeout: 3.14,
				});
			}, RangeError, &quot;timeout should be zero or positive integer&quot;);
		});

		it(&quot;throws on negative timeout&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					timeout: -1,
				});
			}, RangeError, &quot;timeout should be zero or positive integer&quot;);
		});

		it(&quot;can config rpId&quot;, function() {
			var fs = new Fido2Lib({
				rpId: &quot;example.com&quot;,
			});
			assert.strictEqual(fs.config.rpId, &quot;example.com&quot;);
		});

		it(&quot;throws on bad rpId&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					rpId: -1,
				});
			}, TypeError, &quot;expected rpId to be string, got: -1&quot;);
		});

		it(&quot;can config rpName&quot;, function() {
			var fs = new Fido2Lib({
				rpName: &quot;ACME&quot;,
			});
			assert.strictEqual(fs.config.rpName, &quot;ACME&quot;);
		});

		it(&quot;has default rpName&quot;, function() {
			var fs = new Fido2Lib();
			assert.strictEqual(fs.config.rpName, &quot;Anonymous Service&quot;);
		});

		it(&quot;throws on bad rpName&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					rpName: -1,
				});
			}, TypeError, &quot;expected rpName to be string, got: -1&quot;);
		});

		it(&quot;can config rpIcon&quot;, function() {
			var fs = new Fido2Lib({
				rpIcon: &quot;https://example.com/foo.png&quot;,
			});
			assert.strictEqual(fs.config.rpIcon, &quot;https://example.com/foo.png&quot;);
		});

		it(&quot;throws on bad rpIcon&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					rpIcon: -1,
				});
			}, TypeError, &quot;expected rpIcon to be string, got: -1&quot;);
		});

		it(&quot;can config challengeSize&quot;, function() {
			var fs = new Fido2Lib({
				challengeSize: 128,
			});
			assert.strictEqual(fs.config.challengeSize, 128);
		});

		it(&quot;has default challengeSize&quot;, function() {
			var fs = new Fido2Lib();
			assert.strictEqual(fs.config.challengeSize, 64);
		});

		it(&quot;throws if challengeSize too small&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					challengeSize: 31,
				});
			}, RangeError, &quot;challenge size too small&quot;);
		});

		it(&quot;throws on bad challengeSize&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					challengeSize: &quot;foo&quot;,
				});
			}, TypeError, &quot;expected challengeSize to be number, got: foo&quot;);
		});

		it(&quot;can config direct attestation&quot;, function() {
			var fs = new Fido2Lib({
				attestation: &quot;direct&quot;,
			});
			assert.strictEqual(fs.config.attestation, &quot;direct&quot;);
		});

		it(&quot;can config indirect attestation&quot;, function() {
			var fs = new Fido2Lib({
				attestation: &quot;indirect&quot;,
			});
			assert.strictEqual(fs.config.attestation, &quot;indirect&quot;);
		});

		it(&quot;can config none attestation&quot;, function() {
			var fs = new Fido2Lib({
				attestation: &quot;none&quot;,
			});
			assert.strictEqual(fs.config.attestation, &quot;none&quot;);
		});

		it(&quot;can config defautl attestation&quot;, function() {
			var fs = new Fido2Lib();
			assert.strictEqual(fs.config.attestation, &quot;direct&quot;);
		});

		it(&quot;throws on bad attestation string&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					attestation: &quot;foo&quot;,
				});
			}, TypeError, &quot;expected attestation to be &#039;direct&#039;, &#039;indirect&#039;, or &#039;none&#039;, got: foo&quot;);
		});

		it(&quot;throws on bad attestation type&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					attestation: -1,
				});
			}, TypeError, &quot;expected attestation to be &#039;direct&#039;, &#039;indirect&#039;, or &#039;none&#039;, got: -1&quot;);
		});

		it(&quot;can config authenticatorAttachment to platform&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorAttachment: &quot;platform&quot;,
			});
			assert.strictEqual(fs.config.authenticatorAttachment, &quot;platform&quot;);
		});

		it(&quot;can config authenticatorAttachment to cross-platform&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorAttachment: &quot;cross-platform&quot;,
			});
			assert.strictEqual(fs.config.authenticatorAttachment, &quot;cross-platform&quot;);
		});

		it(&quot;throws if authenticatorAttachment isn&#039;t platform or cross-platform&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					authenticatorAttachment: &quot;bob&quot;,
				});
			}, TypeError, &quot;expected authenticatorAttachment to be &#039;platform&#039;, or &#039;cross-platform&#039;, got: bob&quot;);
		});

		it(&quot;can config authenticatorRequireResidentKey to false&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorRequireResidentKey: false,
			});
			assert.strictEqual(fs.config.authenticatorRequireResidentKey, false);
		});

		it(&quot;can config authenticatorRequireResidentKey to true&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorRequireResidentKey: true,
			});
			assert.strictEqual(fs.config.authenticatorRequireResidentKey, true);
		});

		it(&quot;throws if authenticatorRequireResidentKey is non-boolean&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					authenticatorRequireResidentKey: 0,
				});
			}, TypeError, &quot;expected authenticatorRequireResidentKey to be boolean, got: 0&quot;);
		});

		it(&quot;can config authenticatorUserVerification to discouraged&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorUserVerification: &quot;discouraged&quot;,
			});
			assert.strictEqual(fs.config.authenticatorUserVerification, &quot;discouraged&quot;);
		});

		it(&quot;can config authenticatorUserVerification to preferred&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorUserVerification: &quot;preferred&quot;,
			});
			assert.strictEqual(fs.config.authenticatorUserVerification, &quot;preferred&quot;);
		});

		it(&quot;can config authenticatorUserVerification to required&quot;, function() {
			var fs = new Fido2Lib({
				authenticatorUserVerification: &quot;required&quot;,
			});
			assert.strictEqual(fs.config.authenticatorUserVerification, &quot;required&quot;);
		});

		it(&quot;throws if authenticatorUserVerification is not required, preferred, or discouraged&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					authenticatorUserVerification: &quot;bob&quot;,
				});
			}, TypeError, &quot;expected authenticatorUserVerification to be &#039;required&#039;, &#039;preferred&#039;, or &#039;discouraged&#039;, got: bob&quot;);
		});

		it(&quot;can config cryptoParams order&quot;, function() {
			var fs = new Fido2Lib({
				cryptoParams: [-257, -7],
			});
			assert.deepEqual(fs.config.cryptoParams, [-257, -7]);
		});

		it(&quot;can config cryptoParams value&quot;, function() {
			var fs = new Fido2Lib({
				cryptoParams: [-8],
			});
			assert.deepEqual(fs.config.cryptoParams, [-8]);
		});

		it(&quot;can config cryptoParams value&quot;, function() {
			var fs = new Fido2Lib();
			assert.deepEqual(fs.config.cryptoParams, [-7, -257]);
		});

		it(&quot;throws on bad cryptoParams&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					cryptoParams: &quot;bob&quot;,
				});
			}, TypeError, &quot;expected cryptoParams to be Array, got: bob&quot;);
		});

		it(&quot;throws on bad value inside cryptoParams&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					cryptoParams: [-7, &quot;bob&quot;, -257],
				});
			}, TypeError, &quot;expected cryptoParam to be number, got: bob&quot;);
		});

		it(&quot;throws on empty cryptoParams&quot;, function() {
			assert.throws(function() {
				new Fido2Lib({
					cryptoParams: [],
				});
			}, TypeError, &quot;cryptoParams must have at least one element&quot;);
		});
	});

	describe(&quot;attestationOptions&quot;, function() {
		var serv;
		beforeEach(function() {
			serv = new Fido2Lib();
		});

		it(&quot;returns options&quot;, function() {
			return serv.attestationOptions().then((opts) =&gt; {
				assert.isObject(opts);
			});
		});

		it(&quot;returns a challenge&quot;, function() {
			return serv.attestationOptions().then((opts) =&gt; {
				assert.instanceOf(opts.challenge, ArrayBuffer);
				assert.strictEqual(opts.challenge.byteLength, 64);
			});
		});

		it(&quot;returns a timeout&quot;, function() {
			return serv.attestationOptions().then((opts) =&gt; {
				assert.isNumber(opts.timeout);
				assert.strictEqual(opts.timeout, 60000);
			});
		});

		it(&quot;picks up values from constructors options&quot;, function() {
			serv = new Fido2Lib({
				timeout: 42,
				rpId: &quot;example.com&quot;,
				rpName: &quot;ACME&quot;,
				rpIcon: &quot;https://example.com/logo.png&quot;,
				challengeSize: 128,
				attestation: &quot;none&quot;,
				cryptoParams: [-8, -9],
				authenticatorAttachment: &quot;platform&quot;,
				authenticatorRequireResidentKey: false,
				authenticatorUserVerification: &quot;required&quot;,
			});

			return serv.attestationOptions().then((opts) =&gt; {
				assert.isObject(opts);
				assert.isNumber(opts.timeout);
				assert.strictEqual(opts.timeout, 42);
				assert.isObject(opts.rp);
				assert.isString(opts.rp.id);
				assert.strictEqual(opts.rp.id, &quot;example.com&quot;);
				assert.isString(opts.rp.name);
				assert.strictEqual(opts.rp.name, &quot;ACME&quot;);
				assert.isString(opts.rp.icon);
				assert.strictEqual(opts.rp.icon, &quot;https://example.com/logo.png&quot;);
				assert.instanceOf(opts.challenge, ArrayBuffer);
				assert.strictEqual(opts.challenge.byteLength, 128);
				assert.isArray(opts.pubKeyCredParams);
				assert.strictEqual(opts.pubKeyCredParams.length, 2);
				assert.deepEqual(opts.pubKeyCredParams, [
					{
						type: &quot;public-key&quot;,
						alg: -8,
					}, {
						type: &quot;public-key&quot;,
						alg: -9,
					},
				]);
				assert.isNumber(opts.timeout);
				assert.strictEqual(opts.timeout, 42);
				assert.isObject(opts.authenticatorSelection);
				assert.isString(opts.authenticatorSelection.authenticatorAttachment);
				assert.strictEqual(opts.authenticatorSelection.authenticatorAttachment, &quot;platform&quot;);
				assert.isBoolean(opts.authenticatorSelection.requireResidentKey);
				assert.strictEqual(opts.authenticatorSelection.requireResidentKey, false);
				assert.isString(opts.authenticatorSelection.userVerification);
				assert.strictEqual(opts.authenticatorSelection.userVerification, &quot;required&quot;);
				assert.isString(opts.attestation);
				assert.strictEqual(opts.attestation, &quot;none&quot;);
			});
		});

		it(&quot;accepts extraData and returns rawChallenge&quot;, async function() {
			let extraData = new Uint8Array([0x1, 0x2, 0x3, 0x4]).buffer;
			let opts = await serv.attestationOptions({
				extraData: extraData,
			});

			let challenge = opts.challenge;
			let hash = crypto.createHash(&quot;sha256&quot;);
			hash.update(abToBuf(opts.rawChallenge));
			hash.update(abToBuf(extraData));
			let calculatedChallenge = new Uint8Array(hash.digest()).buffer;
			assert.isTrue(abEqual(challenge, calculatedChallenge), &quot;extraData hashes match&quot;);
		});
	});

	describe(&quot;attestationResult&quot;, function() {
		var serv;
		beforeEach(function() {
			serv = new Fido2Lib();
		});

		it(&quot;validates a credential request with &#039;none&#039; attestation&quot;, function() {
			var expectations = {
				challenge: &quot;33EHav-jZ1v9qwH783aU-j0ARx6r5o-YHh-wd7C6jPbd7Wh6ytbIZosIIACehwf9-s6hXhySHO-HHUjEwZS29w&quot;,
				origin: &quot;https://localhost:8443&quot;,
				factor: &quot;either&quot;,
			};

			return serv.attestationResult(h.lib.makeCredentialAttestationNoneResponse, expectations).then((res) =&gt; {
				assert.instanceOf(res, Fido2AttestationResult);
				return res;
			});
		});

		it(&quot;validates a credential request with &#039;u2f&#039; attestation&quot;);

		it(&quot;validates a packed credential that has self attestation&quot;, function() {
			const expectations = {
				challenge: &quot;zBNZ9XmBj4cu7xxYI_uSJauAj89yOTZX1xEqKxhQydhYCTdoKB0k8bzs3llRrBxQlNn3WyRovWvYAXmuIiswLQ&quot;,
				origin: &quot;http://localhost:3000&quot;,
				factor: &quot;either&quot;,
			};

			const parsedPackedSelfAttestationResponse = {
				...packedSelfAttestationResponse,
				id: h.functions.b64decode(packedSelfAttestationResponse.id),
				rawId: h.functions.b64decode(packedSelfAttestationResponse.rawId),
				response: {
					attestationObject: h.functions.b64decode(packedSelfAttestationResponse.response.attestationObject),
					clientDataJSON: h.functions.b64decode(packedSelfAttestationResponse.response.clientDataJSON),
				},
			};

			return serv.attestationResult(parsedPackedSelfAttestationResponse, expectations).then((res) =&gt; {
				assert.instanceOf(res, Fido2AttestationResult);
				return res;
			});
		});

		it(&quot;validates a credential request with &#039;android-safetynet&#039; attestation&quot;, function(){
			var serv = new Fido2Lib();
			var expectations = {
				challenge: &quot;NrRzgRhGy5Y0NlKNhEAqs4ZFVgNGtN49ZyCTOfLk8G1EPY3vnN3zasIZynlCAyUOLdB3-AALfy1XG2MiVps_Vw&quot;,
				origin: &quot;https://contubernio.tic.udc.es&quot;,
				factor: &quot;second&quot;,
			};

			var makeCredentialAttestationSafetyNetResponse = {
				rawId: coerceToArrayBuffer(&quot;AcaOtf577JrxNa9lHZ9g1Npx2YgKhU0w-F_fFkzbOZNZRmh4_S4NFXBBOH75Jf5NS76jK9vcuRiamDIn63Jxxw0&quot;,&quot;rawId&quot;),
				response: {
					attestationObject: coerceToArrayBuffer(
						&quot;o2NmbXRxYW5kcm9pZC1zYWZldHluZXRnYXR0U3RtdKJjdmVyaTIwMTgxNzAxN2hyZXNwb25zZVkU3mV5SmhiR2NpT2lKU1V6STFOaUlzSW5nMVl5STZXeUpOU1VsR2EzcERRMEpJZFdkQmQwbENRV2RKVWtGT1kxTnJhbVJ6Tlc0MkswTkJRVUZCUVVGd1lUQmpkMFJSV1VwTGIxcEphSFpqVGtGUlJVeENVVUYzVVdwRlRFMUJhMGRCTVZWRlFtaE5RMVpXVFhoSWFrRmpRbWRPVmtKQmIxUkdWV1IyWWpKa2MxcFRRbFZqYmxaNlpFTkNWRnBZU2pKaFYwNXNZM3BGVkUxQ1JVZEJNVlZGUVhoTlMxSXhVbFJKUlU1Q1NVUkdVRTFVUVdWR2R6QjVUVVJCZUUxVVRYaE5WRkY0VGtSc1lVWjNNSGxOVkVGNFRWUkZlRTFVVVhoT1JHeGhUVWQzZUVONlFVcENaMDVXUWtGWlZFRnNWbFJOVWsxM1JWRlpSRlpSVVVsRmQzQkVXVmQ0Y0ZwdE9YbGliV3hvVFZKWmQwWkJXVVJXVVZGSVJYY3hUbUl6Vm5Wa1IwWndZbWxDVjJGWFZqTk5VazEzUlZGWlJGWlJVVXRGZDNCSVlqSTVibUpIVldkVVJYaEVUVkp6ZDBkUldVUldVVkZFUlhoS2FHUklVbXhqTTFGMVdWYzFhMk50T1hCYVF6VnFZakl3ZDJkbl&quot;+
						&quot;JXbE5RVEJIUTFOeFIxTkpZak5FVVVWQ1FWRlZRVUUwU1VKRWQwRjNaMmRGUzBGdlNVSkJVVU5YUlhKQ1VWUkhXa2RPTVdsYVlrNDVaV2hTWjJsbVYwSjRjV2t5VUdSbmVIY3dNMUEzVkhsS1dtWk5lR3B3TlV3M2FqRkhUbVZRU3pWSWVtUnlWVzlKWkRGNVEwbDVRazE1ZUhGbllYcHhaM1J3V0RWWGNITllWelJXWmsxb1NtSk9NVmt3T1hGNmNYQTJTa1FyTWxCYVpHOVVWVEZyUmxKQlRWZG1UQzlWZFZwMGF6ZHdiVkpZWjBkdE5XcExSSEphT1U1NFpUQTBkazFaVVhJNE9FNXhkMWN2YTJaYU1XZFVUMDVKVlZRd1YzTk1WQzgwTlRJeVFsSlhlR1ozZUdNelVVVXhLMVJMVjJ0TVEzSjJaV3MyVjJ4SmNYbGhRelV5VnpkTlJGSTRUWEJHWldKNWJWTkxWSFozWmsxU2QzbExVVXhVTUROVlREUjJkRFE0ZVVWak9ITndOM2RVUVVoTkwxZEVaemhSYjNSaGNtWTRUMEpJYTI1dldqa3lXR2wyYVdGV05uUlJjV2hTVDBoRFptZHRia05ZYVhobVZ6QjNSVmhEZG5GcFRGUmlVWFJWWWt4elV5ODRTVkowWkZocmNGRkNPVUZuVFVKQlFVZHFaMmRLV1UxSlNVTldSRUZQUW1kT1ZraFJPRUpCWmpo&quot;+
						&quot;RlFrRk5RMEpoUVhkRmQxbEVWbEl3YkVKQmQzZERaMWxKUzNkWlFrSlJWVWhCZDBWM1JFRlpSRlpTTUZSQlVVZ3ZRa0ZKZDBGRVFXUkNaMDVXU0ZFMFJVWm5VVlUyUkVoQ2QzTkJkbUkxTTJjdlF6QTNjSEpVZG5aM1RsRlJURmwzU0hkWlJGWlNNR3BDUW1kM1JtOUJWVzFPU0RSaWFFUnllal&quot;+
						&quot;YyYzFsS09GbHJRblZuTmpNd1NpOVRjM2RhUVZsSlMzZFpRa0pSVlVoQlVVVkZWMFJDVjAxRFkwZERRM05IUVZGVlJrSjZRVUpvYUhSdlpFaFNkMDlwT0haaU1rNTZZME0xZDJFeWEzVmFNamwyV25rNWJtUklUWGhpZWtWM1MzZFpTVXQzV1VKQ1VWVklUVUZMUjBneWFEQmtTRUUyVEhrNWQyRXlhM1ZhTWpsMlduazVibU16U1hsTU1HUlZWWHBHVUUxVE5XcGpibEYzU0ZGWlJGWlNNRkpDUWxsM1JrbEpVMWxZVWpCYVdFNHdURzFHZFZwSVNuWmhWMUYxV1RJNWRFMURSVWRCTVZWa1NVRlJZVTFDWjNkRFFWbEhXalJGVFVGUlNVTk5RWGRIUTJselIwRlJVVUl4Ym10RFFsRk5kMHgzV1VSV1VqQm1Ra05uZDBwcVFXdHZRMHRuU1VsWlpXRklVakJqUkc5MlRESk9lV0pETlhkaE1tdDFXakk1ZGxwNU9VaFdSazE0VkhwRmRWa3pTbk5OU1VsQ1FrRlpTMHQzV1VKQ1FVaFhaVkZKUlVGblUwSTVVVk5DT0dkRWQwRklZMEU1YkhsVlREbEdNMDFEU1ZWV1FtZEpUVXBTVjJwMVRrNUZlR3Q2ZGprNFRVeDVRVXg2UlRkNFdrOU5RVUZCUm5adWRYa3dXbmRCUVVKQlRVRlRSRUpIUVdsRlFUZGxMe&quot;+
						&quot;kJaVW5VemQwRkdiVmRJTWpkTk1uWmlWbU5hTDIxeWNDczBjbVpaWXk4MVNWQktNamxHTm1kRFNWRkRia3REUTBGaFkxWk9aVmxhT0VORFpsbGtSM0JDTWtkelNIaDFUVTlJYTJFdlR6UXhhbGRsUml0NlowSXhRVVZUVlZwVE5uYzNjeloyZUVWQlNESkxhaXRMVFVSaE5XOUxLekpOYzNoMFZDOVVUVFZoTVhSdlIyOUJRVUZDWWpVM2MzUktUVUZCUVZGRVFVVlpkMUpCU1dkRldHSnBiMUJpU25BNWNVTXdSR295TlRoRVJrZFRVazFCVlN0YVFqRkZhVlpGWW1KaUx6UlZkazVGUTBsQ2FFaHJRblF4T0haU2JqbDZSSFo1Y21aNGVYVmtZMGhVVDFOc00yZFVZVmxCTHpkNVZDOUNhVWcwVFVFd1IwTlRjVWRUU1dJelJGRkZRa04zVlVGQk5FbENRVkZFU1VGalVVSnNiV1E0VFVWblRHUnljbkpOWWtKVVEzWndUVmh6ZERVcmQzZ3lSR3htWVdwS1RrcFZVRFJxV1VacVdWVlJPVUl6V0RSRk1ucG1ORGx1V0ROQmVYVmFSbmhCY1U5U2JtSnFMelZxYTFrM1lUaHhUVW93YWpFNWVrWlBRaXR4WlhKNFpXTXdibWh0T0dkWmJFeGlVVzAyYzB0Wk4xQXdaWGhtY2pkSWRVc3pUV3RRTVhCbFl6RTBk&quot;+
						&quot;MFpGVldGSGNVUjNWV0pIWjJ3dmIybDZNemhHV0VORkswTlhPRVV4VVVGRlZXWjJZbEZRVkZsaVMzaFphaXQwUTA1c2MzTXdZbFJUYjB3eVdqSmtMMm96UW5CTU0wMUdkekI1ZUZOTEwxVlVjWGxyVEhJeVFTOU5aR2hLVVcxNGFTdEhLMDFMVWxOelVYSTJNa0Z1V21GMU9YRTJXVVp2YVNz&quot;+
						&quot;NVFVVklLMEUwT0ZoMFNYbHphRXg1UTFSVk0waDBLMkZMYjJoSGJuaEJOWFZzTVZoU2JYRndPRWgyWTBGME16bFFPVFZHV2tkR1NtVXdkWFpzZVdwUGQwRjZXSFZOZFRkTksxQlhVbU1pTENKTlNVbEZVMnBEUTBGNlMyZEJkMGxDUVdkSlRrRmxUekJ0Y1VkT2FYRnRRa3BYYkZGMVJFRk9RbWRyY1docmFVYzVkekJDUVZGelJrRkVRazFOVTBGM1NHZFpSRlpSVVV4RmVHUklZa2M1YVZsWGVGUmhWMlIxU1VaS2RtSXpVV2RSTUVWblRGTkNVMDFxUlZSTlFrVkhRVEZWUlVOb1RVdFNNbmgyV1cxR2MxVXliRzVpYWtWVVRVSkZSMEV4VlVWQmVFMUxVako0ZGxsdFJuTlZNbXh1WW1wQlpVWjNNSGhPZWtFeVRWUlZkMDFFUVhkT1JFcGhSbmN3ZVUxVVJYbE5WRlYzVFVSQmQwNUVTbUZOUlVsNFEzcEJTa0puVGxaQ1FWbFVRV3hXVkUxU05IZElRVmxFVmxGUlMwVjRWa2hpTWpsdVlrZFZaMVpJU2pGak0xRm5WVEpXZVdSdGJHcGFXRTE0UlhwQlVrSm5UbFpDUVUxVVEydGtWVlY1UWtSUlUwRjRWSHBGZDJkblJXbE5RVEJIUTFOeFIxTkpZak5FVVVWQ1FWRlZRVUUwU1VKRWQwRjNaMmRGUzB&quot;+
						&quot;GdlNVSkJVVVJSUjAwNVJqRkpkazR3TlhwclVVODVLM1JPTVhCSlVuWktlbnA1VDFSSVZ6VkVla1ZhYUVReVpWQkRiblpWUVRCUmF6STRSbWRKUTJaTGNVTTVSV3R6UXpSVU1tWlhRbGxyTDJwRFprTXpVak5XV2sxa1V5OWtUalJhUzBORlVGcFNja0Y2UkhOcFMxVkVlbEp5YlVKQ1NqVjNkV1JuZW01a1NVMVpZMHhsTDFKSFIwWnNOWGxQUkVsTFoycEZkaTlUU2tndlZVd3JaRVZoYkhST01URkNiWE5MSzJWUmJVMUdLeXRCWTNoSFRtaHlOVGx4VFM4NWFXdzNNVWt5WkU0NFJrZG1ZMlJrZDNWaFpXbzBZbGhvY0RCTVkxRkNZbXA0VFdOSk4wcFFNR0ZOTTFRMFNTdEVjMkY0YlV0R2MySnFlbUZVVGtNNWRYcHdSbXhuVDBsbk4zSlNNalY0YjNsdVZYaDJPSFpPYld0eE4zcGtVRWRJV0d0NFYxazNiMGM1YWl0S2ExSjVRa0ZDYXpkWWNrcG1iM1ZqUWxwRmNVWktTbE5RYXpkWVFUQk1TMWN3V1RONk5XOTZNa1F3WXpGMFNrdDNTRUZuVFVKQlFVZHFaMmRGZWsxSlNVSk1la0ZQUW1kT1ZraFJPRUpCWmpoRlFrRk5RMEZaV1hkSVVWbEVWbEl3YkVKQ1dYZEdRVmxKUzNkWlFrSlJWVWhCZD&quot;+
						&quot;BWSFEwTnpSMEZSVlVaQ2QwMURUVUpKUjBFeFZXUkZkMFZDTDNkUlNVMUJXVUpCWmpoRFFWRkJkMGhSV1VSV1VqQlBRa0paUlVaS2FsSXJSelJSTmpncllqZEhRMlpIU2tGaWIwOTBPVU5tTUhKTlFqaEhRVEZWWkVsM1VWbE5RbUZCUmtwMmFVSXhaRzVJUWpkQllXZGlaVmRpVTJGTVpDOW&quot;+
						&quot;pSMWxaZFUxRVZVZERRM05IUVZGVlJrSjNSVUpDUTJ0M1NucEJiRUpuWjNKQ1owVkdRbEZqZDBGWldWcGhTRkl3WTBSdmRrd3lPV3BqTTBGMVkwZDBjRXh0WkhaaU1tTjJXak5PZVUxcVFYbENaMDVXU0ZJNFJVdDZRWEJOUTJWblNtRkJhbWhwUm05a1NGSjNUMms0ZGxrelNuTk1ia0p5WVZNMWJtSXlPVzVNTW1SNlkycEpkbG96VG5sTmFUVnFZMjEzZDFCM1dVUldVakJuUWtSbmQwNXFRVEJDWjFwdVoxRjNRa0ZuU1hkTGFrRnZRbWRuY2tKblJVWkNVV05EUVZKWlkyRklVakJqU0UwMlRIazVkMkV5YTNWYU1qbDJXbms1ZVZwWVFuWmpNbXd3WWpOS05VeDZRVTVDWjJ0eGFHdHBSemwzTUVKQlVYTkdRVUZQUTBGUlJVRkhiMEVyVG01dU56aDVObkJTYW1RNVdHeFJWMDVoTjBoVVoybGFMM0l6VWs1SGEyMVZiVmxJVUZGeE5sTmpkR2s1VUVWaGFuWjNVbFF5YVZkVVNGRnlNREptWlhOeFQzRkNXVEpGVkZWM1oxcFJLMnhzZEc5T1JuWm9jMDg1ZEhaQ1EwOUpZWHB3YzNkWFF6bGhTamw0YW5VMGRGZEVVVWc0VGxaVk5sbGFXaTlZZEdWRVUwZFZPVmw2U25GUWFsazRjVE5OUkhoeWVtM&quot;+
						&quot;XhaWEJDUTJZMWJ6aHRkeTkzU2pSaE1rYzJlSHBWY2paR1lqWlVPRTFqUkU4eU1sQk1Va3cyZFROTk5GUjZjek5CTWsweGFqWmllV3RLV1drNGQxZEpVbVJCZGt0TVYxcDFMMkY0UWxaaWVsbHRjVzEzYTIwMWVreFRSRmMxYmtsQlNtSkZURU5SUTFwM1RVZzFOblF5UkhaeGIyWjRjelpDUW1ORFJrbGFWVk53ZUhVMmVEWjBaREJXTjFOMlNrTkRiM05wY2xOdFNXRjBhaTg1WkZOVFZrUlJhV0psZERoeEx6ZFZTelIyTkZwVlRqZ3dZWFJ1V25veGVXYzlQU0pkZlEuZXlKdWIyNWpaU0k2SW05R2VVNWtTVzQwU204M1ZsbFVkRFJrUkVnMlYxRjZkalZ3TjFac1kwZzRhV3RHVmtoTE1EUmxjWE05SWl3aWRHbHRaWE4wWVcxd1RYTWlPakUxT1RFME16TTRNRGMxTmpRc0ltRndhMUJoWTJ0aFoyVk9ZVzFsSWpvaVkyOXRMbWR2YjJkc1pTNWhibVJ5YjJsa0xtZHRjeUlzSW1Gd2EwUnBaMlZ6ZEZOb1lUSTFOaUk2SWl0clVrSk1WM1ZuVm5wNE1sbFVjVEk1VGtneVJWSnVSRzlITlVOMlRrUnRNR2N5ZGsxUWNVUlFZbFU5SWl3aVkzUnpVSEp2Wm1sc1pVMWhkR05vSWpwMGNuVmxMQ0poY0d0&quot;+
						&quot;RFpYSjBhV1pwWTJGMFpVUnBaMlZ6ZEZOb1lUSTFOaUk2V3lJNFVERnpWekJGVUVwamMyeDNOMVY2VW5OcFdFdzJOSGNyVHpVd1JXUXJVa0pKUTNSaGVURm5NalJOUFNKZExDSmlZWE5wWTBsdWRHVm5jbWwwZVNJNmRISjFaU3dpWlhaaGJIVmhkR2x2YmxSNWNHVWlPaUpDUVZOSlF5Sjku&quot;+
						&quot;S3pKWWJYUEJUSUFvamFNbThqQ1hjR3E3ZU9COWxCMnV1LUlrMmNxU29HYzBYNnlTSUNVRlotNmJSbjAtcnZDS25zazlBN0Y0bkt0UUl0dDBsaFFPUnlLOFFuUUNINnFCYlM1NjQ4akt5cFNQXzNTaEdmbWhuRk1PWWU5UlpONDA0Vi0zWl8xR3BaeElvRjZ4VWZRR2UwSUU3UVd6TEcyN3daSlFDZWwwRzZtMXU0d2JBcWllN0dBRXV0Z0tTc0dxcXdYb3NldEZCQnFzUS1mbUk3Y0lEb3pVc01pbkw0ZmE1djkwQWsyZHFLSlFyclZqRWczdzJKYTNjdmo1X0dWMFpzUlVrdDlQY2E3TnBPaGUtejE4a0xCUGpkYlhJNlZLVW1QSjNrY2xmcVZtY1VvRGk4cXVVMW1wVlJ1VTRIdy1QU2VpMEtqUDVVYTI4UTZxZEs2U2pBaGF1dGhEYXRhWMXZV8JswNgrrG46LjoHvBP-XVNbLFy4fMYY3an12FPexUUAAAAAuT_ZYfLmRi-xIoIAIkfeeABBAcaOtf577JrxNa9lHZ9g1Npx2YgKhU0w-F_fFkzbOZNZRmh4_S4NFXBBOH75Jf5NS76jK9vcuRiamDIn63Jxxw2lAQIDJiABIVggKCVQt7mNWFnqmPUTz5n6zHuR1TMvb8RmmH0E3ILATSciWCCs8K3giniEnyLwfll7C8e1g1PPckAN8JXnGWUfHuGVEA&quot;,
						&quot;attestationObject&quot;
					),
					clientDataJSON: coerceToArrayBuffer(&quot;eyJ0eXBlIjoid2ViYXV0aG4uY3JlYXRlIiwiY2hhbGxlbmdlIjoiTnJSemdSaEd5NVkwTmxLTmhFQXFzNFpGVmdOR3RONDlaeUNUT2ZMazhHMUVQWTN2bk4zemFzSVp5bmxDQXlVT0xkQjMtQUFMZnkxWEcyTWlWcHNfVnciLCJvcmlnaW4iOiJodHRwczpcL1wvY29udHViZXJuaW8udGljLnVkYy5lcyIsImFuZHJvaWRQYWNrYWdlTmFtZSI6ImNvbS5hbmRyb2lkLmNocm9tZSJ9&quot;,&quot;clientDataJSON&quot;),
				},
			};

			return serv.attestationResult(makeCredentialAttestationSafetyNetResponse, expectations).then(res =&gt; {
				assert.instanceOf(res, Fido2AttestationResult);
				return res;
			});
		});

		it(&quot;catches bad requests&quot;);
	});

	describe(&quot;assertionOptions&quot;, function() {
		var serv;
		beforeEach(function() {
			serv = new Fido2Lib();
		});

		it(&quot;returns a challenge&quot;, function() {
			return serv.assertionOptions().then((chal) =&gt; {
				assert.isNumber(chal.timeout);
				assert.strictEqual(chal.timeout, 60000);
				assert.instanceOf(chal.challenge, ArrayBuffer);
				assert.strictEqual(chal.challenge.byteLength, 64);
			});
		});

		it(&quot;picks up values from constructors options&quot;, function() {
			serv = new Fido2Lib({
				timeout: 42,
				rpId: &quot;example.com&quot;,
				rpName: &quot;ACME&quot;,
				rpIcon: &quot;https://example.com/logo.png&quot;,
				challengeSize: 128,
				attestation: &quot;none&quot;,
				cryptoParams: [-8, -9],
				authenticatorAttachment: &quot;platform&quot;,
				authenticatorRequireResidentKey: false,
				authenticatorUserVerification: &quot;required&quot;,
			});

			return serv.assertionOptions().then((opts) =&gt; {
				assert.isObject(opts);
				assert.isNumber(opts.timeout);
				assert.strictEqual(opts.timeout, 42);
				assert.isString(opts.rpId);
				assert.strictEqual(opts.rpId, &quot;example.com&quot;);
				assert.instanceOf(opts.challenge, ArrayBuffer);
				assert.strictEqual(opts.challenge.byteLength, 128);
				assert.isString(opts.userVerification);
				assert.strictEqual(opts.userVerification, &quot;required&quot;);
			});
		});

		it(&quot;accepts extraData and returns rawChallenge&quot;, async function() {
			let extraData = new Uint8Array([0x1, 0x2, 0x3, 0x4]).buffer;
			let opts = await serv.assertionOptions({
				extraData: extraData,
			});

			let challenge = opts.challenge;
			let hash = crypto.createHash(&quot;sha256&quot;);
			hash.update(abToBuf(opts.rawChallenge));
			hash.update(abToBuf(extraData));
			let calculatedChallenge = new Uint8Array(hash.digest()).buffer;
			assert.isTrue(abEqual(challenge, calculatedChallenge), &quot;extraData hashes match&quot;);
		});
	});

	describe(&quot;assertionResult&quot;, function() {
		var serv;
		beforeEach(function() {
			serv = new Fido2Lib();
		});

		it(&quot;valid an assertion&quot;, function() {
			var expectations = {
				challenge: &quot;eaTyUNnyPDDdK8SNEgTEUvz1Q8dylkjjTimYd5X7QAo-F8_Z1lsJi3BilUpFZHkICNDWY8r9ivnTgW7-XZC3qQ&quot;,
				origin: &quot;https://localhost:8443&quot;,
				factor: &quot;either&quot;,
				publicKey: h.lib.assnPublicKey,
				prevCounter: 362,
				userHandle: null,
			};

			return serv.assertionResult(h.lib.assertionResponse, expectations).then((res) =&gt; {
				assert.instanceOf(res, Fido2AssertionResult);
				return res;
			});
		});

		it(&quot;valid assertion without userHandle&quot;, function() {
			var expectations = {
				challenge: &quot;eaTyUNnyPDDdK8SNEgTEUvz1Q8dylkjjTimYd5X7QAo-F8_Z1lsJi3BilUpFZHkICNDWY8r9ivnTgW7-XZC3qQ&quot;,
				origin: &quot;https://localhost:8443&quot;,
				factor: &quot;either&quot;,
				publicKey: h.lib.assnPublicKey,
				prevCounter: 362,
				userHandle: null,
			};

			var assertionResponse = {
				rawId: h.lib.assertionResponse.rawId,
				response: {
					clientDataJSON: h.lib.assertionResponse.response.clientDataJSON,
					authenticatorData: h.lib.assertionResponse.response.authenticatorData,
					signature: h.lib.assertionResponse.response.signature,
					// userHandle: h.lib.assertionResponse.response.userHandle
				},
			};

			return serv.assertionResult(assertionResponse, expectations).then((res) =&gt; {
				assert.instanceOf(res, Fido2AssertionResult);
				return res;
			});
		});

		it(&quot;valid assertion without counter supported&quot;, function() {
			var expectations = {
				challenge: &quot;g_Pu32bpluktxugNNBLX-ZO5N9ub0D50bJERbKiU2GWON3md0rR9CaQYdPHdCgo-dpi1-9gbJJvmCuHDnh04Rg&quot;,
				origin: &quot;https://mighty-fireant-84.loca.lt&quot;,
				factor: &quot;first&quot;,
				publicKey: &quot;-----BEGIN PUBLIC KEY-----\n&quot; +
				&quot;MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE0dBhdNNvh2NkaNstlFhrBhi9yrjP\n&quot; +
				&quot;0qPqZvRRnf3zQiN9zDwJ9ZXoyO4dhKz3OIhMBJG6F+muH35fEsWBZI6dhg==\n&quot; +
				&quot;-----END PUBLIC KEY-----\n&quot;,
				prevCounter: 0,
				userHandle: null,
			};

			var assertionResponse = {
				rawId: coerceToArrayBuffer(&quot;7S8aQSSxqPkztahKbgw36Mr_-hE&quot;, &quot;rawId&quot;),
				response: {
					authenticatorData: coerceToArrayBuffer(&quot;YS67HU8UTNyqQ5f-EVzitWw5paVnpyhQli2ahN6PS6UFAAAAAA&quot;, &quot;authenticatorData&quot;),
					clientDataJSON: coerceToArrayBuffer(&quot;eyJ0eXBlIjoid2ViYXV0aG4uZ2V0IiwiY2hhbGxlbmdlIjoiZ19QdTMyYnBsdWt0eHVnTk5CTFgtWk81Tjl1YjBENTBiSkVSYktpVTJHV09OM21kMHJSOUNhUVlkUEhkQ2dvLWRwaTEtOWdiSkp2bUN1SERuaDA0UmciLCJvcmlnaW4iOiJodHRwczovL21pZ2h0eS1maXJlYW50LTg0LmxvY2EubHQifQ&quot;, &quot;clientDataJSON&quot;),
					signature: coerceToArrayBuffer(&quot;MEQCIEhIhQBglBn1iGMDgF4WFDG7ISJHD1C1Q60drTaijjV2AiBOnQleadMnzcMJ0EBpwoP8zr2V5lBuKvpNfJrcbC1T4w&quot;, &quot;signature&quot;),
				},
			};

			return serv.assertionResult(assertionResponse, expectations).then((res) =&gt; {
				assert.instanceOf(res, Fido2AssertionResult);
				return res;
			});
		});
	});

	describe(&quot;addAttestationFormat&quot;, function() {
		afterEach(function() {
			Fido2Lib.deleteAllAttestationFormats();
		});

		after(function() {
			restoreAttestationFormats();
		});

		it(&quot;adds to map on success&quot;, function() {
			var serv = new Fido2Lib();
			assert.instanceOf(serv.attestationMap, Map);
			var prevSize = serv.attestationMap.size;
			var ret = Fido2Lib.addAttestationFormat(&quot;foo&quot;, function() {}, function() {});
			assert.isTrue(ret);
			assert.strictEqual(serv.attestationMap.size, prevSize + 1);
			assert.isTrue(serv.attestationMap.has(&quot;foo&quot;));
			var newFmt = serv.attestationMap.get(&quot;foo&quot;);
			assert.isObject(newFmt);
			assert.strictEqual(Object.keys(newFmt).length, 2);
			assert.isFunction(newFmt.parseFn);
			assert.isFunction(newFmt.validateFn);
		});

		it(&quot;throws on bad fmt&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.addAttestationFormat({}, function() {}, function() {});
			}, TypeError, &quot;expected &#039;fmt&#039; to be string, got: object&quot;);
		});

		it(&quot;throws on duplicate fmt&quot;, function() {
			Fido2Lib.addAttestationFormat(&quot;foo&quot;, function() {}, function() {});
			assert.throws(() =&gt; {
				Fido2Lib.addAttestationFormat(&quot;foo&quot;, function() {}, function() {});
			}, Error, &quot;can&#039;t add format: &#039;foo&#039; already exists&quot;);
		});

		it(&quot;throws on bad parseFn&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.addAttestationFormat(&quot;foo&quot;, [], function() {});
			}, TypeError, &quot;expected &#039;parseFn&#039; to be string, got: object&quot;);
		});

		it(&quot;throws on bad validateFn&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.addAttestationFormat(&quot;foo&quot;, function() {}, &quot;blah&quot;);
			}, TypeError, &quot;expected &#039;validateFn&#039; to be string, got: string&quot;);
		});
	});

	describe(&quot;parseAttestation&quot;, function() {
		var parseStub;
		var validateStub;
		beforeEach(function() {
			parseStub = sinon.stub();
			validateStub = sinon.stub();
			Fido2Lib.addAttestationFormat(&quot;foo&quot;, parseStub, validateStub);
		});

		afterEach(function() {
			Fido2Lib.deleteAllAttestationFormats();
		});

		after(function() {
			restoreAttestationFormats();
		});

		it(&quot;returns Map on success&quot;, function() {
			var arg = new Map([
				[&quot;test&quot;, &quot;yup&quot;],
			]);
			parseStub.onCall(0).returns(arg);
			var ret = Fido2Lib.parseAttestation(&quot;foo&quot;, arg);
			assert.instanceOf(ret, Map);
			assert.strictEqual(parseStub.callCount, 1);
			assert.isTrue(parseStub.calledWith(arg));
		});

		it(&quot;success when returning empty map&quot;, function() {
			var arg = new Map();
			parseStub.onCall(0).returns(arg);
			var ret = Fido2Lib.parseAttestation(&quot;foo&quot;, arg);
			assert.instanceOf(ret, Map);
			assert.strictEqual(parseStub.callCount, 1);
			assert.isTrue(parseStub.calledWith(arg));
		});

		it(&quot;throws if parseFn doesn&#039;t return Map&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.parseAttestation(&quot;foo&quot;, { test: &quot;yup&quot; });
			}, Error, &quot;foo parseFn did not return a Map&quot;);
		});

		it(&quot;throws on non-string format&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.parseAttestation({}, { test: &quot;yup&quot; });
			}, TypeError, &quot;expected &#039;fmt&#039; to be string, got: object&quot;);
		});

		it(&quot;throws on missing format&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.parseAttestation();
			}, TypeError, &quot;expected &#039;fmt&#039; to be string, got: undefined&quot;);
		});

		it(&quot;throws on missing data&quot;, function() {
			assert.throws(() =&gt; {
				Fido2Lib.parseAttestation(&quot;foo&quot;);
			}, TypeError, &quot;expected &#039;attStmt&#039; to be object, got: undefined&quot;);
		});
	});

	describe(&quot;validateAttestation&quot;, function() {
		var parseStub;
		var validateStub;
		var fakeRequest;
		beforeEach(function() {
			parseStub = sinon.stub();
			validateStub = sinon.stub();
			Fido2Lib.addAttestationFormat(&quot;foo&quot;, parseStub, validateStub);
			fakeRequest = {
				authnrData: new Map([
					[&quot;fmt&quot;, &quot;foo&quot;],
				]),
			};
		});

		afterEach(function() {
			Fido2Lib.deleteAllAttestationFormats();
		});

		after(function() {
			restoreAttestationFormats();
		});

		it(&quot;returns Map on success&quot;, async function() {
			validateStub.onCall(0).returns(true);
			var arg = new Map();
			var ret = await Fido2Lib.validateAttestation.call(fakeRequest);
			assert.isTrue(ret);
			assert.strictEqual(validateStub.callCount, 1);
		});

		it(&quot;throws if validateFn doesn&#039;t return true&quot;, async function() {
			return assert.isRejected(Fido2Lib.validateAttestation.call(fakeRequest), Error, &quot;foo validateFn did not return &#039;true&#039;&quot;);
		});

		it(&quot;throws on non-string format&quot;, function() {
			fakeRequest.authnrData.set(&quot;fmt&quot;, {});
			return assert.isRejected(Fido2Lib.validateAttestation.call(fakeRequest), TypeError, &quot;expected &#039;fmt&#039; to be string, got: object&quot;);
		});

		it(&quot;throws on missing format&quot;, function() {
			fakeRequest.authnrData.clear();
			return assert.isRejected(Fido2Lib.validateAttestation.call(fakeRequest), TypeError, &quot;expected &#039;fmt&#039; to be string, got: undefined&quot;);
		});
	});

	describe(&quot;createMdsCollection&quot;, function() {
		it(&quot;throws if no name provided&quot;, function() {
			assert.throws(function() {
				Fido2Lib.createMdsCollection();
			}, Error, &quot;expected &#039;collectionName&#039; to be non-empty string, got: undefined&quot;);
		});

		it(&quot;returns a MdsCollection&quot;, function() {
			var mc = Fido2Lib.createMdsCollection(&quot;test&quot;);
			assert.instanceOf(mc, MdsCollection);
		});
	});

	describe(&quot;addMdsCollection&quot;, function() {
		afterEach(function() {
			Fido2Lib.clearMdsCollections();
		});

		it(&quot;throws if argument isn&#039;t a MdsCollection&quot;, function() {
			assert.throws(function() {
				Fido2Lib.addMdsCollection();
			}, Error, &quot;expected &#039;mdsCollection&#039; to be instance of MdsCollection, got: undefined&quot;);
		});

		it(&quot;sets the current global MDS collection&quot;, async function() {
			var mc = Fido2Lib.createMdsCollection(&quot;test&quot;);
			await mc.addToc(h.mds.mds2TocJwt);
			mc.addEntry(h.mds.mds2UafEntry);
			assert.strictEqual(mc.entryList.size, 0);
			Fido2Lib.addMdsCollection(mc);
			assert.strictEqual(mc.entryList.size, 1);
		});

		it(&quot;can add multiple collections&quot;, async function() {
			var mc1 = Fido2Lib.createMdsCollection(&quot;fido-mds-1&quot;);
			await mc1.addToc(h.mds.mds1TocJwt);
			mc1.addEntry(h.mds.mds1UafEntry);
			assert.strictEqual(mc1.entryList.size, 0);
			Fido2Lib.addMdsCollection(mc1);
			assert.strictEqual(mc1.entryList.size, 1);

			var mc2 = Fido2Lib.createMdsCollection(&quot;fido-mds-2&quot;);
			await mc2.addToc(h.mds.mds2TocJwt);
			mc2.addEntry(h.mds.mds2UafEntry);
			assert.strictEqual(mc2.entryList.size, 0);
			Fido2Lib.addMdsCollection(mc2);
			assert.strictEqual(mc2.entryList.size, 1);
		});
	});

	describe(&quot;findMdsEntry&quot;, function() {
		afterEach(function() {
			Fido2Lib.clearMdsCollections();
		});

		it(&quot;throws if a global MDS collection hasn&#039;t been set&quot;, function() {
			assert.throws(function() {
				Fido2Lib.findMdsEntry(&quot;4e4e#4005&quot;);
			}, Error, &quot;must set MDS collection before attempting to find an MDS entry&quot;);
		});

		it(&quot;finds a UAF MDS entry in the global collection&quot;, async function() {
			var mc = Fido2Lib.createMdsCollection(&quot;test&quot;);
			await mc.addToc(h.mds.mds2TocJwt);
			mc.addEntry(h.mds.mds2UafEntry);
			Fido2Lib.addMdsCollection(mc);

			var entryList = Fido2Lib.findMdsEntry(&quot;4e4e#4005&quot;);
			assert.isArray(entryList);
			assert.strictEqual(entryList.length, 1);
			var entry = entryList[0];
			assert.instanceOf(entry, MdsEntry);
			assert.strictEqual(entry.aaid, &quot;4e4e#4005&quot;);
		});

		it(&quot;finds a UAF MDS entry in the global collection&quot;, async function() {
			var mc = Fido2Lib.createMdsCollection(&quot;test&quot;);
			await mc.addToc(h.mds.mds1TocJwt);
			mc.addEntry(h.mds.mds1U2fEntry);
			Fido2Lib.addMdsCollection(mc);

			var entryList = Fido2Lib.findMdsEntry(&quot;923881fe2f214ee465484371aeb72e97f5a58e0a&quot;);
			assert.isArray(entryList);
			assert.strictEqual(entryList.length, 1);
			var entry = entryList[0];
			assert.strictEqual(entry.protocolFamily, &quot;u2f&quot;);
			assert.deepEqual(entry.attestationCertificateKeyIdentifiers, [&quot;923881fe2f214ee465484371aeb72e97f5a58e0a&quot;]);
			assert.strictEqual(entry.description, &quot;Feitian BioPass FIDO Security Key&quot;);
		});

		it(&quot;throws if id isn&#039;t specified&quot;, async function() {
			var mc = Fido2Lib.createMdsCollection(&quot;test&quot;);
			await mc.addToc(h.mds.mds2TocJwt);
			mc.addEntry(h.mds.mds2UafEntry);
			Fido2Lib.addMdsCollection(mc);

			assert.throws(function() {
				Fido2Lib.findMdsEntry();
			}, Error, &quot;expected &#039;id&#039; to be String, got: undefined&quot;);
		});

		it(&quot;can find multiple entries&quot;, async function() {
			// Add UAF 4e4e#4005 from FIDO MDS 1
			var mc1 = Fido2Lib.createMdsCollection(&quot;fido-mds1-toc&quot;);
			await mc1.addToc(h.mds.mds1TocJwt);
			mc1.addEntry(h.mds.mds1UafEntry4e4e4005);
			Fido2Lib.addMdsCollection(mc1);

			// Add UAF 4e4e#4005 from FIDO MDS 2
			var mc2 = Fido2Lib.createMdsCollection(&quot;fido-mds2-toc&quot;);
			await mc2.addToc(h.mds.mds2TocJwt);
			mc2.addEntry(h.mds.mds2UafEntry);
			Fido2Lib.addMdsCollection(mc2);

			var entryList = Fido2Lib.findMdsEntry(&quot;4e4e#4005&quot;);
			assert.isArray(entryList);
			assert.strictEqual(entryList.length, 2);

			// first entry from MDS1
			var entry1 = entryList[0];
			assert.strictEqual(entry1.aaid, &quot;4e4e#4005&quot;);
			assert.isObject(entry1.collection);
			assert.strictEqual(entry1.collection.name, &quot;fido-mds1-toc&quot;);
			assert.isUndefined(entry1.legalHeader);

			// second entry from MDS2
			var entry2 = entryList[1];
			assert.strictEqual(entry2.aaid, &quot;4e4e#4005&quot;);
			assert.isObject(entry2.collection);
			assert.strictEqual(entry2.collection.name, &quot;fido-mds2-toc&quot;);
			assert.isString(entry2.legalHeader); // distinguishing characteristic of MDS2
		});
	});
});
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
