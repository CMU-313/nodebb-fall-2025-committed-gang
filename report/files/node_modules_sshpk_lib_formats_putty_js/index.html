<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/sshpk/lib/formats/putty.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/sshpk/lib/formats/putty.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">49.12</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">195</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">44.20</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.15</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Copyright 2018 Joyent, Inc.

module.exports = {
	read: read,
	write: write
};

var assert = require(&#039;assert-plus&#039;);
var Buffer = require(&#039;safer-buffer&#039;).Buffer;
var rfc4253 = require(&#039;./rfc4253&#039;);
var Key = require(&#039;../key&#039;);
var SSHBuffer = require(&#039;../ssh-buffer&#039;);
var crypto = require(&#039;crypto&#039;);
var PrivateKey = require(&#039;../private-key&#039;);

var errors = require(&#039;../errors&#039;);

// https://tartarus.org/~simon/putty-prerel-snapshots/htmldoc/AppendixC.html
function read(buf, options) {
	var lines = buf.toString(&#039;ascii&#039;).split(/[\r\n]+/);
	var found = false;
	var parts;
	var si = 0;
	var formatVersion;
	while (si &lt; lines.length) {
		parts = splitHeader(lines[si++]);
		if (parts) {
			formatVersion = {
				&#039;putty-user-key-file-2&#039;: 2,
				&#039;putty-user-key-file-3&#039;: 3
			}[parts[0].toLowerCase()];
			if (formatVersion) {
				found = true;
				break;
			}
		}
	}
	if (!found) {
		throw (new Error(&#039;No PuTTY format first line found&#039;));
	}
	var alg = parts[1];

	parts = splitHeader(lines[si++]);
	assert.equal(parts[0].toLowerCase(), &#039;encryption&#039;);
	var encryption = parts[1];

	parts = splitHeader(lines[si++]);
	assert.equal(parts[0].toLowerCase(), &#039;comment&#039;);
	var comment = parts[1];

	parts = splitHeader(lines[si++]);
	assert.equal(parts[0].toLowerCase(), &#039;public-lines&#039;);
	var publicLines = parseInt(parts[1], 10);
	if (!isFinite(publicLines) || publicLines &lt; 0 ||
	    publicLines &gt; lines.length) {
		throw (new Error(&#039;Invalid public-lines count&#039;));
	}

	var publicBuf = Buffer.from(
	    lines.slice(si, si + publicLines).join(&#039;&#039;), &#039;base64&#039;);
	var keyType = rfc4253.algToKeyType(alg);
	var key = rfc4253.read(publicBuf);
	if (key.type !== keyType) {
		throw (new Error(&#039;Outer key algorithm mismatch&#039;));
	}

	si += publicLines;
	if (lines[si]) {
		parts = splitHeader(lines[si++]);
		assert.equal(parts[0].toLowerCase(), &#039;private-lines&#039;);
		var privateLines = parseInt(parts[1], 10);
		if (!isFinite(privateLines) || privateLines &lt; 0 ||
		    privateLines &gt; lines.length) {
			throw (new Error(&#039;Invalid private-lines count&#039;));
		}

		var privateBuf = Buffer.from(
			lines.slice(si, si + privateLines).join(&#039;&#039;), &#039;base64&#039;);

		if (encryption !== &#039;none&#039; &amp;&amp; formatVersion === 3) {
			throw new Error(&#039;Encrypted keys arenot supported for&#039; +
			&#039; PuTTY format version 3&#039;);
		}

		if (encryption === &#039;aes256-cbc&#039;) {
			if (!options.passphrase) {
				throw (new errors.KeyEncryptedError(
					options.filename, &#039;PEM&#039;));
			}

			var iv = Buffer.alloc(16, 0);
			var decipher = crypto.createDecipheriv(
				&#039;aes-256-cbc&#039;,
				derivePPK2EncryptionKey(options.passphrase),
				iv);
			decipher.setAutoPadding(false);
			privateBuf = Buffer.concat([
				decipher.update(privateBuf), decipher.final()]);
		}

		key = new PrivateKey(key);
		if (key.type !== keyType) {
			throw (new Error(&#039;Outer key algorithm mismatch&#039;));
		}

		var sshbuf = new SSHBuffer({buffer: privateBuf});
		var privateKeyParts;
		if (alg === &#039;ssh-dss&#039;) {
			privateKeyParts = [ {
				name: &#039;x&#039;,
				data: sshbuf.readBuffer()
			}];
		} else if (alg === &#039;ssh-rsa&#039;) {
			privateKeyParts = [
				{ name: &#039;d&#039;, data: sshbuf.readBuffer() },
				{ name: &#039;p&#039;, data: sshbuf.readBuffer() },
				{ name: &#039;q&#039;, data: sshbuf.readBuffer() },
				{ name: &#039;iqmp&#039;, data: sshbuf.readBuffer() }
			];
		} else if (alg.match(/^ecdsa-sha2-nistp/)) {
			privateKeyParts = [ {
				name: &#039;d&#039;, data: sshbuf.readBuffer()
			} ];
		} else if (alg === &#039;ssh-ed25519&#039;) {
			privateKeyParts = [ {
				name: &#039;k&#039;, data: sshbuf.readBuffer()
			} ];
		} else {
			throw new Error(&#039;Unsupported PPK key type: &#039; + alg);
		}

		key = new PrivateKey({
			type: key.type,
			parts: key.parts.concat(privateKeyParts)
		});
	}

	key.comment = comment;
	return (key);
}

function derivePPK2EncryptionKey(passphrase) {
	var hash1 = crypto.createHash(&#039;sha1&#039;).update(Buffer.concat([
		Buffer.from([0, 0, 0, 0]),
		Buffer.from(passphrase)
	])).digest();
	var hash2 = crypto.createHash(&#039;sha1&#039;).update(Buffer.concat([
		Buffer.from([0, 0, 0, 1]),
		Buffer.from(passphrase)
	])).digest();
	return (Buffer.concat([hash1, hash2]).slice(0, 32));
}

function splitHeader(line) {
	var idx = line.indexOf(&#039;:&#039;);
	if (idx === -1)
		return (null);
	var header = line.slice(0, idx);
	++idx;
	while (line[idx] === &#039; &#039;)
		++idx;
	var rest = line.slice(idx);
	return ([header, rest]);
}

function write(key, options) {
	assert.object(key);
	if (!Key.isKey(key))
		throw (new Error(&#039;Must be a public key&#039;));

	var alg = rfc4253.keyTypeToAlg(key);
	var buf = rfc4253.write(key);
	var comment = key.comment || &#039;&#039;;

	var b64 = buf.toString(&#039;base64&#039;);
	var lines = wrap(b64, 64);

	lines.unshift(&#039;Public-Lines: &#039; + lines.length);
	lines.unshift(&#039;Comment: &#039; + comment);
	lines.unshift(&#039;Encryption: none&#039;);
	lines.unshift(&#039;PuTTY-User-Key-File-2: &#039; + alg);

	return (Buffer.from(lines.join(&#039;\n&#039;) + &#039;\n&#039;));
}

function wrap(txt, len) {
	var lines = [];
	var pos = 0;
	while (pos &lt; txt.length) {
		lines.push(txt.slice(pos, pos + 64));
		pos += 64;
	}
	return (lines);
}
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
